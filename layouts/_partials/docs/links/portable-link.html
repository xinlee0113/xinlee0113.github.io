{{- $destination := .Destination -}}
{{- $url := urls.Parse .Destination -}}

{{- $isRemote := gt (len $url.Host) 0 -}}
{{- $isFragment := strings.HasPrefix .Destination "#" -}}

{{- if and (not $isRemote) (not $isFragment) -}}
  {{- $path := strings.TrimPrefix "./" $url.Path -}}
  {{- $path = strings.TrimSuffix ".md" $path -}}
  {{- $path = strings.TrimSuffix "/_index" $path -}}

  {{- $found := false -}}
  
  {{- with (.Page.GetPage $path) -}}
    {{- $destination = .RelPermalink -}}
    {{- $found = true -}}
  {{- end -}}
  
  {{- if not $found -}}
    {{- with (.Page.Resources.Get $path) -}}
      {{- $destination = .RelPermalink -}}
      {{- $found = true -}}
    {{- end -}}
  {{- end -}}
  
  {{- if not $found -}}
    {{- with (resources.Get $path) -}}
      {{- $destination = .RelPermalink -}}
      {{- $found = true -}}
    {{- end -}}
  {{- end -}}
  
  {{- if not $found -}}
    {{- warnf "Reference '%s' not found in '%s'" .Destination .Page.Permalink -}}
  {{- end -}}

  {{- with $url.RawQuery -}}
    {{- $destination = print $destination "?" . -}}
  {{- end -}}
  {{- with $url.Fragment -}}
    {{- $destination = print $destination "#" . -}}
  {{- end -}}
{{- end -}}
{{- return $destination -}}