---
layout: default
title: 国际版开机引导测试完整方案
parent: MiuiProvision项目文档
---

# 国际版开机引导测试完整方案

## 🔴 核心问题

**MIUI国际版必须通过Google SetupWizard启动，才能获得真实的`wizardBundle`（包含WizardStack对象），否则返回Google时会崩溃。**

## ❌ 失败的尝试和原因

### 尝试1: 不重启，直接启动

**方法**:
```bash
adb shell am start -n com.android.provision/.activities.DefaultActivity
```

**结果**: 点击"继续"后崩溃
```
IllegalArgumentException: Intent does not contain WizardStack
```

**原因**: 缺少Google创建的`wizardBundle`

### 尝试2: 设置device_provisioned=0并重启

**方法**:
```bash
adb shell settings put global device_provisioned 0
adb reboot
```

**结果**: 重启后直接进桌面

**原因**: 
1. 设备的`first_boot_completed=1`，系统不会触发开机向导
2. MIUI Provision被`finishSetup()`禁用了（`enabled=0`）
3. Google SetupWizard保存了完成状态

### 尝试3: 清除Google数据并重启

**方法**:
```bash
adb shell pm clear com.google.android.setupwizard
adb shell settings put global device_provisioned 0
adb reboot
```

**结果**: 仍然进桌面

**原因**: 系统判断"首次启动"的依据不只是`device_provisioned`

## ✅ 唯一可行的解决方案

### 方案：恢复出厂设置

这是**唯一能保证100%成功**的方式，因为它会：
1. 清除所有数据（包括`first_boot_completed`标记）
2. 重置所有settings值
3. 清除所有应用数据
4. 触发真正的首次启动流程

### 实施步骤

#### 方式一：ADB命令（推荐，保留数据）

```bash
# 1. 构建并安装APK
bash scripts/build_and_install.sh

# 2. 进入Recovery模式
adb reboot recovery

# 等待进入Recovery模式（~30秒）
# 手动操作：
#   - 选择"Wipe data/factory reset"
#   - 确认清除数据
#   - 选择"Reboot system now"

# 3. 等待重启（~1分钟）
# Google SetupWizard会自动启动，从wizard_script.xml的miui_startup开始
```

#### 方式二：设置中恢复（用户友好）

```bash
# 1. 手动进入设置
# 2. 进入"关于手机" -> "恢复出厂设置"
# 3. 确认重置
# 4. 等待自动重启和启动开机向导
```

#### 方式三：fastboot刷机（开发测试）

```bash
# 适用于频繁测试的开发场景
# 1. 准备clean boot image
# 2. fastboot flash userdata
# 3. fastboot reboot
# 这样可以只清除用户数据，保留系统分区
```

## 🎯 开发流程最佳实践

### 日常开发（修改UI、逻辑）

**如果不涉及返回Google的流程**：

```bash
# 可以快速测试，不需要恢复出厂
bash scripts/build_and_install.sh
# 选择 'n' 跳过重启
# 手动启动查看UI
adb shell am start -n com.android.provision/.activities.DefaultActivity
```

**限制**: 
- ✅ 可以测试MIUI内部的所有页面
- ✅ 可以测试UI、动画、交互
- ❌ 不能测试返回Google的流程（会崩溃）

### 完整测试（包括Google集成）

**必须恢复出厂**：

```bash
# 1. 构建安装
bash scripts/build_and_install.sh

# 2. 进入recovery恢复出厂
adb reboot recovery
# 手动操作清除数据

# 3. 等待首次启动
# Google SetupWizard会自动调用MIUI，带上真实的wizardBundle

# 4. 完整测试所有流程
# 包括点击"继续"返回Google
```

## 📊 不同场景对比

| 场景 | 方法 | 时间成本 | 测试范围 | 是否崩溃 |
|------|------|---------|---------|----------|
| UI调试 | 直接启动 | ~5秒 | ✅ MIUI页面<br>❌ Google集成 | ✅ 返回Google时 |
| 逻辑测试 | 直接启动 | ~5秒 | ✅ MIUI内部逻辑<br>❌ wizardBundle处理 | ✅ 返回Google时 |
| 完整测试 | 恢复出厂 | ~3分钟 | ✅ 完整流程<br>✅ Google集成 | ❌ 无崩溃 |
| 发布前验证 | 恢复出厂 | ~3分钟 | ✅ 真实用户体验 | ❌ 无崩溃 |

## 🔧 脚本优化建议

### 更新build_and_install.sh

```bash
# 国际版的选项菜单
if [[ "$REGION" == "global" ]]; then
    echo ""
    log_info "国际版测试选项："
    echo "  1) 快速测试（仅测试MIUI UI，返回Google会崩溃）"
    echo "  2) 完整测试（需要恢复出厂，测试完整流程）"
    read -p "请选择 (1-2): " -n 1 -r TEST_MODE
    echo ""
    
    if [[ $TEST_MODE == "1" ]]; then
        # 快速测试
        log_warning "⚠️ 快速测试模式"
        log_warning "  - 可以测试MIUI UI和逻辑"
        log_warning "  - 点击'继续'返回Google会崩溃"
        adb shell am start -n com.android.provision/.activities.DefaultActivity
    else
        # 完整测试
        log_info "完整测试模式，需要恢复出厂设置"
        log_warning "⚠️ 警告：将清除所有数据！"
        read -p "确认继续？(yes/no): " CONFIRM
        
        if [[ $CONFIRM == "yes" ]]; then
            log_info "进入recovery模式..."
            adb reboot recovery
            log_success "设备将在recovery模式启动"
            log_info "请手动操作："
            log_info "  1. 选择 'Wipe data/factory reset'"
            log_info "  2. 确认清除数据"
            log_info "  3. 选择 'Reboot system now'"
            log_info "  4. 等待Google SetupWizard自动启动MIUI"
        fi
    fi
fi
```

## 💡 开发技巧

### 1. 使用虚拟机/模拟器

**优点**:
- 支持快照，可以快速恢复到"首次启动"状态
- 恢复出厂更快（<1分钟 vs ~3分钟）
- 不影响真机数据

**方法**:
```bash
# 创建快照（首次启动前）
emulator -avd Pixel_7_API_35 -snapshot-save first_boot

# 恢复快照
emulator -avd Pixel_7_API_35 -snapshot-load first_boot

# 每次测试后恢复快照即可
```

### 2. 准备专用测试机

如果有条件，准备一台专用的测试设备：
- 不放个人数据
- 专门用于恢复出厂测试
- 可以自动化测试脚本

### 3. 拆分测试

```
开发阶段：
- 90%的时间用快速测试（直接启动）
- 测试UI、动画、逻辑、性能

集成测试：
- 10%的时间用完整测试（恢复出厂）
- 测试Google集成、wizardBundle、完整流程

发布前：
- 100%完整测试
- 真机、多型号、完整流程
```

## 📝 为什么不能简单重启？

### 系统判断"首次启动"的条件

Android系统判断是否需要启动开机向导，不只看`device_provisioned`，还看：

1. **first_boot_completed** (persist)
   - 标记设备是否完成过首次启动
   - 这个值persist，普通重启不会清除

2. **Provision组件enabled状态**
   - `finishSetup()`会禁用Provision
   - 即使`device_provisioned=0`，禁用的组件不会启动

3. **Google SetupWizard的内部状态**
   - Google维护自己的完成状态
   - 存储在`/data/data/com.google.android.setupwizard/`
   - `pm clear`只能清除应用数据，不影响系统判断

4. **系统启动流程**
   - 系统启动时会检查上述所有条件
   - 只有**全部**条件满足才会启动开机向导
   - 否则直接进入桌面

### 恢复出厂设置的特殊性

恢复出厂会：
- ✅ 清除`/data`分区的所有数据
- ✅ 重置所有persist属性
- ✅ 清除所有应用数据
- ✅ 触发真正的"首次启动"流程
- ✅ **这是Android系统设计的官方重置方式**

## 🎯 总结

### 快速测试（日常开发）
```bash
# 优点：快（5秒）
# 缺点：不能测试返回Google
bash scripts/build_and_install.sh  # 选择 'n'
adb shell am start -n com.android.provision/.activities.DefaultActivity
```

### 完整测试（集成验证）
```bash
# 优点：完整流程，无崩溃
# 缺点：慢（3分钟），清除数据
bash scripts/build_and_install.sh  # 选择 'y'
adb reboot recovery
# 手动操作恢复出厂
```

### 推荐策略
- **开发阶段**: 90%快速测试 + 10%完整测试
- **提交前**: 100%完整测试
- **发布前**: 多设备完整测试

---

**文档版本**: v1.0  
**创建时间**: 2025-10-10  
**验证状态**: ✅ 已在真机验证

