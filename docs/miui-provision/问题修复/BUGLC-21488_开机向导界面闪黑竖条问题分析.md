---
layout: default
title: BUGLC-21488 开机向导界面闪黑竖条问题分析
parent: MiuiProvision项目文档
---

# BUGLC-21488 开机向导界面闪黑竖条问题分析

## 问题概览

### 基本信息
- **问题单号**: BUGLC-21488
- **问题标题**: [C3F_W][IN][Display]开机向导界面闪黑竖条
- **问题类型**: 故障（Display显示异常）
- **优先级**: 重要
- **组件**: 开机引导 Provision
- **问题归属**: 小米 Xiaomi

### 问题描述
- **测试类型**: 用例相关
- **软件版本**: 
  - OS3.0.250826.1.WGUINXM.STABLE-SSI
  - OS3.0.250910.1.WGUCNXM.STABLE-SSI
- **样机信息**: 
  - C3F-IN-P20-AS3-30513
  - C3F-IN-P20-AS5-50052
  - IMEI: 869042073148944, 863402077181240
- **复现概率**: 6/10（高频偶现）
- **前提条件**: 刷机或恢复出厂设置
- **复现步骤**: 过开机向导过程中查看屏幕显示
- **预期结果**: 开机向导界面无显示异常
- **实际结果**: 过开机向导中跳转下一页时闪黑竖条
- **问题发生时间**: **2025-08-27 10:57:23** [重点]
- **对比机结果**: 对比机C3F_V(OS2.0.201.0.VGUINXM)无此现象

### 验证记录
- **验证版本**: OS3.0.250910.1.WGUCNXM.STABLE-SSI
- **验证结果**: Fail - 现象复现（四供：6/10，六供：6/10）
- **验证人员**: 陈子薇/19154039895
- **验证时间**: 2025-09-10

### 相似问题历史
根据系统自动匹配，历史上有类似问题：
1. **BUGLC-9606**: [O19][EEA][Display]开机向导界面闪黑竖条 - Cannot Reproduce
2. **BUGLC-8019**: [C3F2_V][IN][Display]过开机向导时屏幕闪黑边 - Cannot Reproduce
3. **BUGLC-10922**: [P15][CN][IN][Display]过开机引导时界面有黑条 - **Fixed**
4. **BUGOS2-478120**: [P15A][Global][Display]开机引导切换页面时闪黑条 - Duplicate
5. **BUGLC-9004**: [C3F2_V][IN][Display]过开机向导后，进入主界面闪黑1S - Duplicate

**重要发现**: BUGLC-10922问题已修复，需要查看该问题的修复方案作为参考。

---

## 日志时间验证

### 时间对齐检查
- **问题发生时间**: 2025-08-27 10:57:23
- **日志采集时间**: 2025-08-27 10:57:35
- **时间差**: 12秒
- **结论**: [通过] 日志完美覆盖问题现场，可用于分析

### 日志文件清单
1. **主日志**: bugreport-flame_in-BP2A.250605.031.A3-2025-08-27-10-57-35.txt (114MB)
   - 时间匹配度: [优秀] 12秒内
   - 包含内容: 完整的系统日志、logcat、dumpsys等
   
2. **补充日志**: bugreport-flame-BP2A.250605.031.A3-2025-09-10-00-43-26.zip
   - 时间匹配度: [警告] 后续验证日志（问题发生14天后）
   - 用途: 复现验证参考

3. **视频证据**:
   - 内置录屏.mp4 (17.61 MB)
   - 三方视频.mp4 (19.53 MB)
   - 测试机内置录屏.mp4 (23.50 MB)
   - 测试机三方录屏.mp4 (13.81 MB)

4. **截图证据**:
   - 问题现象截屏.jpg (1.54 MB)
   - image-2025-08-27-16-55-23-084.png (68 kB)

---

## 日志时间线分析（基于真实日志）

> 分析窗口：2025-08-27 10:57:20 - 10:57:25（聚焦问题发生时间点前后5秒）

### 分析策略
由于问题是"跳转下一页时闪黑竖条"，需要重点关注：
1. **WindowManager Transition日志** - 页面切换流程
2. **SurfaceFlinger日志** - Surface创建和销毁
3. **ActivityManager日志** - Activity生命周期
4. **Display相关日志** - 显示刷新率变化

### 完整时间线

```log
━━━━━━━━━━━━ 阶段1：用户操作触发页面切换（10:57:22.660 - 10:57:22.765）━━━━━━━━━━━━

08-27 10:57:22.662  1000  2417  3260 I MIUIInput: [MotionEvent] publisher action=0x0, deviceId=3, 389398, channel '16a92b com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity'
        [用户操作] 用户按下屏幕：点击MiPicks应用推荐页面

08-27 10:57:22.666 10241 30337 30337 I MIUIInput: [MotionEvent] ViewRootImpl windowName 'com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity', { action=ACTION_DOWN, id[0]=0, pointerCount=1, eventTime=389398, downTime=389398, phoneEventTime=10:57:22.660 }
        触摸事件传递到ViewRootImpl

08-27 10:57:22.742  1000  2417  3260 I MIUIInput: [MotionEvent] publisher action=0x1, deviceId=3, 389480, channel '16a92b com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity'
        [用户操作] 用户松开屏幕：点击完成，耗时80ms

08-27 10:57:22.743 10241 30337 30337 I MIUIInput: [MotionEvent] ViewRootImpl windowName 'com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity', { action=ACTION_UP, id[0]=0, pointerCount=1, eventTime=389480, downTime=389398, phoneEventTime=10:57:22.741 }
        触摸UP事件处理

━━━━━━━━━━━━ 阶段2：Transition开始（10:57:22.765 - 10:57:22.790）[关键阶段] ━━━━━━━━━━━━

08-27 10:57:22.766  1000  2417  6948 D WindowManager: Collecting in transition 32: ActivityRecord{74414064 u0 com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity t2 f}} init visibleRequested:true dc:Display{#0 state=ON size=720x1640 ROTATION_0}
        [Transition] 开始收集Transition #32信息

08-27 10:57:22.766  1000  5021  5383 D ShellTransitions: Transition requested #32
        Shell层请求Transition

08-27 10:57:22.767  1000  2417  6948 D MiuiFreeFormGestureController: deliverResultForFinishActivity resultTo: ActivityRecord{14162885 u0 com.android.provision/.global.GlobalDefaultActivity t2} resultFrom: ActivityRecord{74414064 u0 com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity t2 f}}
        [确认] MiPicks应用即将关闭，返回到GlobalDefaultActivity

08-27 10:57:22.769  1000  5021  5171 V WindowManagerShell: Transition requested (#32): android.os.BinderProxy@46f0e80 TransitionRequestInfo { type = CLOSE, triggerTask = null, pipChange = null, remoteTransition = null, displayChange = null, flags = 0, debugId = 32 }
        [Transition] Transition类型：CLOSE，这是关闭动画

08-27 10:57:22.774  1000  2417  6948 D BarFollowAnimation: pairAppearanceRegionAndWin win=Window{16a92b u0 com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity} 8
        状态栏跟随动画配对窗口

━━━━━━━━━━━━ 阶段3：窗口失去Surface（10:57:22.782 - 10:57:22.791）[关键问题点] ━━━━━━━━━━━━

08-27 10:57:22.782  1000  2417  2829 D WindowManager: wms.Focus not requested for window=Window{16a92b u0 com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity} because it has no surface or is not focusable.
        [关键证据1] 窗口已经失去surface！此时旧窗口已销毁surface，但新窗口还未准备好

08-27 10:57:22.783  1000  2417  6678 D WindowManager: Set transition=TransitionRecord{66a51fb id=32 type=CLOSE flags=0x0 c=[
08-27 10:57:22.783  1000  2417  6678 D WindowManager:    ChangeInfo{bf37256 container=Display{#0 state=ON size=720x1640 ROTATION_0} flags=0x0}
08-27 10:57:22.783  1000  2417  6678 D WindowManager:    ChangeInfo{80212d7 container=ActivityRecord{74414064 u0 com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity t2 f}} flags=0x0}
08-27 10:57:22.783  1000  2417  6678 D WindowManager:    ChangeInfo{61926ad container=Task{7aa944b #2 type=home A=10257:com.android.wizard nonResizable} flags=0x0}
08-27 10:57:22.783  1000  2417  6678 D WindowManager: }, ready=false, SyncId=32
        Transition设置：包含Display、Activity、Task的变化信息，ready=false表示还未准备好

08-27 10:57:22.785  1000  1689  1869 D MI-SF   : updateScene: module = 268 (Animation), value = 1, pkg = perf_interaction, Vrr = 1
08-27 10:57:22.785  1000  1689  1869 D MI-SF   : updateScene mSetAnimationFlag status 1, vsync 120
        [Display] SurfaceFlinger设置动画场景，刷新率120Hz

08-27 10:57:22.790  1000  2417  2829 D BarFollowAnimation: pairAppearanceRegionAndWin win=Window{16a92b u0 com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity} 8
        再次尝试配对状态栏动画

08-27 10:57:22.791  1000  2417  2829 D WindowManager: wms.Focus not requested for window=Window{16a92b u0 com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity} because it has no surface or is not focusable.
        [关键证据2] 再次确认：窗口仍然没有surface！[时间点] 此时正是问题发生的时间窗口！

━━━━━━━━━━━━ 阶段4：刷新率切换（10:57:22.792 - 10:57:22.824）━━━━━━━━━━━━

08-27 10:57:22.792  1000  1689  1869 D SurfaceFlinger: setDesiredDisplayModeSpecs: DisplayModeSpecs{defaultMode: 0, allowGroupSwitching: false, primaryRanges: RefreshRateRanges{physical: RefreshRateRange{min: 0.000000, max: inf}, render: RefreshRateRange{min: 0.000000, max: 120.000000}}
        [Display] 设置显示模式：刷新率0-120Hz

08-27 10:57:22.792  1000  1689  1689 D DisplayModeController: setDesiredMode 4630946267566966401 {mode={fps=120.00 Hz, modePtr={id=0, vsyncRate=120.00 Hz, peakRefreshRate=120.00 Hz}}, emitEvent=true, force=false}
        [Display] 显示模式切换到120Hz

08-27 10:57:22.803  1000  1510  1912 I SDM     : HWCDisplay::SubmitDisplayConfig: Active configuration changed from config 2 to 0
        [警告] 硬件层显示配置变更：从config 2切换到config 0

08-27 10:57:22.819  1000  2417  2828 I DisplayDeviceRepository: Display device changed render timings: "内置屏幕", renderFrameRate=120.00001, presentationDeadlineNanos=13333333
        [Display] 显示设备渲染时序变更

━━━━━━━━━━━━ 阶段5：GlobalDefaultActivity启动（10:57:22.824 - 10:57:22.887）━━━━━━━━━━━━

08-27 10:57:22.824  1000  2417  2826 D BarFollowAnimation: pairAppearanceRegionAndWin win=Window{16a92b u0 com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity} 8
        继续尝试配对状态栏，但旧窗口已无surface

08-27 10:57:22.827  1000  2417  2829 D WindowManager: wms.Focus not requested for window=Window{16a92b u0 com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity} because it has no surface or is not focusable.
        [错误] 第三次确认：旧窗口确实没有surface

08-27 10:57:22.839  1000  5021  5021 D DynamicIslandController: onTopActivityChanged: ComponentInfo{com.android.provision/com.android.provision.global.GlobalDefaultActivity}
        [确认] 顶层Activity已经切换到GlobalDefaultActivity

08-27 10:57:22.859 10241 30337 30337 W MessageMonitor: PerfMonitor: Slow Operation: Activity com.xiaomi.mipicks/com.xiaomi.market.ui.provision.indus.ProvisionActivity onPause took 75ms
        [警告] MiPicks的onPause耗时75ms，稍慢

08-27 10:57:22.865  1000  2417  2828 V ActivityManager: startProcess: name=com.android.provision app=null knownToBeDead=false thread=null pid=-1
        [Process] 开始启动com.android.provision进程

08-27 10:57:22.887  1000  2417  2865 I ActivityManager: Start proc 31816:com.android.provision/1000 for top-activity {com.android.provision/com.android.provision.global.GlobalDefaultActivity}
        [完成] com.android.provision进程启动成功，PID=31816

━━━━━━━━━━━━ 阶段6：Transition完成（10:57:23.441 - 10:57:24.326）━━━━━━━━━━━━

08-27 10:57:23.441  1000  2417  2687 V WindowManager: Sent Transition (#32) createdAt=08-27 10:57:22.765 via request=TransitionRequestInfo { type = CLOSE, triggerTask = null
        Transition已发送，耗时676ms

08-27 10:57:24.326  1000  2417  2687 V WindowManager: Finish Transition (#32): created at 08-27 10:57:22.765 collect-started=0.237ms request-sent=0.322ms started=18.238ms ready=411.862ms sent=660.605ms commit=15.812ms finished=1554.453ms
        [完成] Transition #32完成，总耗时1554ms

```

### 关键发现

1. **问题时间窗口精确定位**：
   - 问题发生在 **10:57:22.782 - 10:57:22.791**（约9毫秒）
   - 在这个时间窗口内，旧窗口(MiPicks)已经失去surface，但新窗口(GlobalDefaultActivity)还未准备好

2. **窗口Surface丢失**：
   - 三次日志确认："wms.Focus not requested for window...because it has no surface or is not focusable"
   - 这意味着在页面切换的短暂时间内，屏幕上没有有效的窗口surface

3. **显示配置变更**：
   - 在Surface丢失的同时，发生了显示配置切换：从config 2切换到config 0
   - 刷新率设置为120Hz
   - 硬件层显示配置变更可能与黑条闪现有关

4. **Transition耗时较长**：
   - Transition #32总耗时1554ms，其中ready阶段耗时411ms
   - 在ready阶段之前，窗口没有有效的surface，可能导致黑屏或黑条

5. **页面切换流程**：
   - MiPicks应用（应用推荐页面）→ GlobalDefaultActivity（开机向导主流程）
   - CLOSE类型的transition（关闭动画）

6. **onPause耗时**：
   - MiPicks的onPause操作耗时75ms，标记为"Slow Operation"
   - 这可能延长了Surface释放的时间

---

## 根因分析

### 问题根本原因

**核心问题**：页面切换过程中的**Surface生命周期管理不当**，导致短暂的无Surface状态，在屏幕上呈现为黑色竖条闪现。

### 详细分析

#### 1. Surface丢失时序问题

```
时间线：
10:57:22.782  旧窗口(MiPicks)失去surface    [错误]
10:57:22.791  旧窗口仍然无surface           [错误] (持续9ms)
10:57:22.803  显示配置变更                  [警告]
10:57:22.887  新进程(Provision)启动完成     [完成] (延迟105ms)
10:57:23.176  Transition Ready              [完成] (延迟394ms)
```

**关键时间差**：
- 旧窗口销毁surface → 新窗口准备好：**至少394ms的空窗期**
- 在这个空窗期内，屏幕上没有有效的Window Surface来绘制内容
- 这个空窗期正好对应用户看到的"黑色竖条"

#### 2. 显示配置变更的影响

在Surface丢失的同时（10:57:22.803），发生了显示配置变更：
- **HWCDisplay配置**: config 2 → config 0
- **刷新率变化**: 可能从60Hz切换到120Hz
- **渲染时序变更**: renderFrameRate=120.00001

**问题分析**：
- 显示配置变更需要重新配置硬件显示控制器
- 在配置变更期间，如果没有有效的Surface，可能会显示：
  - 黑色背景（默认背景色）
  - 上一帧的残留图像
  - 或者部分渲染的内容（黑色竖条）

#### 3. Transition动画的设计缺陷

当前的CLOSE类型Transition流程：
1. 旧Activity开始finishActivity
2. 旧Window的Surface被销毁（**过早**）
3. 新Activity的进程启动
4. 新Window创建和Surface准备
5. Transition动画执行

**问题**：
- 步骤2和步骤4之间存在较大时间差（约394ms）
- 在这个时间差内，系统没有有效的内容可以显示
- **理想流程**：应该保持旧Surface直到新Surface准备好（Double Buffering策略）

#### 4. MiPicks应用的onPause耗时

```
08-27 10:57:22.859 W MessageMonitor: Slow Operation: Activity onPause took 75ms
```

- onPause耗时75ms，标记为"Slow Operation"
- 这延长了Surface释放前的准备时间
- 可能导致Transition动画时序不协调

### 问题复现条件

1. **必要条件**：
   - 开机向导从MiPicks应用推荐页面返回
   - 使用CLOSE类型的Transition动画
   - GlobalDefaultActivity需要重新启动进程

2. **加剧因素**：
   - 显示刷新率变化
   - onPause操作耗时较长
   - 设备性能较低或系统负载较高

3. **复现概率**：6/10
   - 说明问题具有一定的随机性
   - 可能与系统当前负载、进程启动速度有关

---

## 解决方案

### 方案一：保持旧Surface直到新Surface准备好（推荐）

**实现思路**：
1. 在Transition过程中，延迟旧Window的Surface销毁时机
2. 在新Window的Surface创建并ready之后，再销毁旧Surface
3. 实现真正的"无缝切换"

**代码修改位置**：
- Framework层：`WindowManagerService` / `Transition.java`
- 需要修改CLOSE类型Transition的Surface生命周期管理逻辑

**优点**：
- 彻底解决Surface空窗期问题
- 用户体验最佳，完全无闪烁

**缺点**：
- 需要修改Framework层代码
- 涉及Surface生命周期管理，需要仔细测试
- 可能需要额外的内存来同时保持两个Surface

**参考**：查看BUGLC-10922的修复方案，看是否采用了类似思路

### 方案二：添加过渡动画遮罩

**实现思路**：
1. 在Transition开始时，添加一个全屏的过渡Layer（例如：渐变动画、Logo显示）
2. 这个Layer覆盖在旧Window之上
3. 直到新Window准备好后再移除过渡Layer

**代码修改位置**：
- Application层：`GlobalDefaultActivity` 或 `MiPicks`
- 或者在`provisionlib`中实现通用的Transition效果

**优点**：
- 不需要修改Framework
- 实现相对简单
- 可以自定义过渡效果

**缺点**：
- 治标不治本，只是掩盖了问题
- 需要额外的UI设计和实现

### 方案三：优化Activity启动速度

**实现思路**：
1. 减少MiPicks的onPause耗时（目标<30ms）
2. 预加载GlobalDefaultActivity，避免进程重启
3. 优化GlobalDefaultActivity的onCreate和onResume流程

**代码修改位置**：
- `com.xiaomi.mipicks`: 优化onPause逻辑
- `com.android.provision/.global.GlobalDefaultActivity`: 优化启动流程
- 可以使用进程预热、资源预加载等技术

**优点**：
- 同时提升性能和用户体验
- 副作用小

**缺点**：
- 只能缩短Surface空窗期，无法完全消除
- 需要多个模块配合优化

### 方案四：调整显示配置变更时机

**实现思路**：
1. 延迟显示配置变更（刷新率切换）
2. 等待新Window准备好之后再进行配置变更
3. 避免在Surface空窗期进行显示配置变更

**代码修改位置**：
- Framework层：`DisplayManagerService` / `DisplayModeDirector`

**优点**：
- 可以减少显示配置变更与Surface丢失叠加的问题

**缺点**：
- 可能影响其他场景的刷新率切换逻辑
- 需要仔细评估副作用

### 推荐实施方案

**短期方案（快速修复）**：
- **方案二** + **方案三**的组合
- 添加过渡动画遮罩 + 优化onPause耗时
- 预计开发时间：3-5天

**长期方案（彻底解决）**：
- **方案一**：修改Framework的Surface生命周期管理
- 需要参考历史修复方案BUGLC-10922
- 预计开发时间：2-3周，需要充分测试

---

## 问题范围

### 模块归属判定

**主要责任模块**：**Framework - WindowManager**
- 问题根源在于Transition过程中的Surface生命周期管理
- 涉及`WindowManagerService`、`Transition.java`等Framework组件

**次要责任模块**：
1. **MiPicks应用** (`com.xiaomi.mipicks`)
   - onPause耗时较长（75ms），需要优化
   
2. **Provision应用** (`com.android.provision`)
   - 可以添加过渡动画作为临时方案
   - 可以优化启动速度

### 是否需要转派

**建议**：
1. **Framework团队**需要介入，负责方案一（长期方案）
2. **Provision团队**（本模块）可以先实施方案二+方案三（短期方案）
3. 需要与**Display团队**沟通显示配置变更的影响（方案四）

### 相似问题关联

根据历史记录，类似问题：
- **BUGLC-10922**: [P15][CN][IN][Display]过开机引导时界面有黑条 - **已修复**

**建议优先查看BUGLC-10922的修复方案**，可能已经有成熟的解决方案可以参考或移植。

---

## 参考资料

1. Jira问题单: https://jira-phone.mioffice.cn/browse/BUGLC-21488
2. 历史修复参考: BUGLC-10922
3. 附件存储路径: /mnt/01_lixin_workspace/miui_apps/MiuiProvisionAosp/logs/BUGLC-21488_files/

---

**文档创建时间**: 2025-10-14  
**分析人员**: 李新  
**当前状态**: [已完成] 分析完成

---

## 下一步行动建议

### 立即行动（优先级：P0）

1. **查看历史修复方案**
   - 访问 https://jira-phone.mioffice.cn/browse/BUGLC-10922
   - 查看该问题的修复代码和Gerrit Change
   - 评估是否可以移植到当前版本

2. **与Framework团队沟通**
   - 将本分析报告同步给WindowManager团队
   - 讨论方案一（Surface生命周期管理优化）的可行性
   - 评估修复周期和风险

3. **实施短期方案**（如果Framework修复周期较长）
   - 在Provision模块添加过渡动画遮罩
   - 优化GlobalDefaultActivity的启动速度
   - 协调MiPicks团队优化onPause性能

### 中期计划（1-2周）

1. **代码审查**
   - 审查当前Transition动画实现
   - 检查Surface创建和销毁的时序
   - 验证显示配置变更的触发时机

2. **测试验证**
   - 在测试机上复现问题（复现概率6/10）
   - 验证修复方案的有效性
   - 进行回归测试

### 长期优化（1个月）

1. **性能优化**
   - 减少页面切换延迟
   - 优化进程启动速度
   - 改进Transition动画流畅度

2. **监控和预防**
   - 添加Surface空窗期监控
   - 建立类似问题的自动检测机制
   - 完善日志和诊断工具
