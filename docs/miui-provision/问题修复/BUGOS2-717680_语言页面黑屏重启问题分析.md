---
layout: default
title: BUGOS2-717680 è¯­è¨€é¡µé¢é»‘å±é‡å¯é—®é¢˜åˆ†ææŠ¥å‘Š
parent: MiuiProvisioné¡¹ç›®æ–‡æ¡£
---

# BUGOS2-717680 è¯­è¨€é¡µé¢é»‘å±é‡å¯é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ“‹ ä¸€ã€é—®é¢˜åŸºæœ¬ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **é—®é¢˜å•å·** | [BUGOS2-717680](https://jira-phone.mioffice.cn/browse/BUGOS2-717680) |
| **é—®é¢˜æ ‡é¢˜** | ã€P3ã€‘å¼€æœºå¼•å¯¼æ¢å¤å‡ºå‚åè¿›å…¥è¯­è¨€é¡µé¢åˆ‡æ¢å¶ç°å¡æ­»é¡µé¢é»‘å±åè‡ªåŠ¨é‡å¯ |
| **é—®é¢˜ä¼˜å…ˆçº§** | P3 (ä¸¥é‡) |
| **è®¾å¤‡å‹å·** | P3_eea |
| **ç³»ç»Ÿç‰ˆæœ¬** | OS3.0.251011.1.WPCEUXM |
| **Androidç‰ˆæœ¬** | 16.0 |
| **å¤ç°æ¦‚ç‡** | Onceï¼ˆä»…æµ‹è¯•æœºå¤ç°ä¸€æ¬¡ï¼‰ |
| **é—®é¢˜å½’å±** | å¼€æœºå¼•å¯¼ Provision |
| **åˆ›å»ºæ—¥æœŸ** | 2025-10-11 15:06 |
| **ç»åŠäºº** | ææ–° |
| **æŠ¥å‘Šäºº** | å†¯ä¸–é¾™ |
| **é—®é¢˜æ—¶é—´** | 2025-10-11 14:49:44 |

---

## ğŸ“ äºŒã€é—®é¢˜æè¿°

### 2.1 æµ‹è¯•åœºæ™¯
- **æµ‹è¯•ç±»å‹**ï¼šè‡ªç”±æµ‹è¯•
- **å‰ææ¡ä»¶**ï¼šæ‰‹æœºæ¢å¤å‡ºå‚è®¾ç½®åé¦–æ¬¡å¼€æœºå¼•å¯¼
- **æµ‹è¯•æ­¥éª¤**ï¼š
  1. æ‰‹æœºæ¢å¤å‡ºå‚
  2. è¿›å…¥å¼€æœºå¼•å¯¼è¯­è¨€é€‰æ‹©é¡µé¢
  3. ç‚¹å‡»é€‰æ‹©è¯­è¨€

### 2.2 é—®é¢˜ç°è±¡
1. ç”¨æˆ·ç‚¹å‡»StartupFragment"ä¸‹ä¸€æ­¥"æŒ‰é’®åï¼Œå±å¹•é»‘å±çº¦7ç§’
2. é»‘å±æœŸé—´ç”¨æˆ·ç›²ç›®ç‚¹å‡»ï¼Œæ„å¤–è§¦å‘è¯­è¨€é€‰æ‹©
3. å±å¹•çŸ­æš‚æ¢å¤æ˜¾ç¤ºQRæ‰«ç ç•Œé¢ï¼ˆçº¦1ç§’ï¼‰
4. é¡µé¢å®Œå…¨å¡æ­»æ— å“åº”
5. å±å¹•å†æ¬¡é»‘å±
6. ç³»ç»Ÿè‡ªåŠ¨é‡å¯ï¼Œæ˜¾ç¤ºå¼€æœºLogo

### 2.3 é™„ä»¶ä¿¡æ¯
- **æ—¥å¿—æ–‡ä»¶**ï¼šbugreport-pudding_eea-BP2A.250605.031.A3-2025-10-11-02-40-39.zip
- **è§†é¢‘æ–‡ä»¶**ï¼šVID_20251011_144944[1].mp4
- **æˆªå›¾æ–‡ä»¶**ï¼š
  - image-2025-10-11-14-55-41-552.pngï¼ˆé»‘å±çŠ¶æ€ï¼‰
  - image-2025-10-11-14-56-06-247.pngï¼ˆé—®é¢˜è¯„çº§ï¼‰
- **Kpanåœ°å€**ï¼šhttps://kpan.mioffice.cn/webfolder/ext/1susVE9sj5D$uVm31GQvyw@@
- **æå–ç **ï¼š5XTz

---

## ğŸ” ä¸‰ã€æ—¶é—´å¯¹åº”å…³ç³»åˆ†æ

### 3.1 æ—¶é—´å·®å¼‚è¯´æ˜

âš ï¸ **é‡è¦å‘ç°**ï¼šæ—¥å¿—æ—¶é—´ï¼ˆ02:40ï¼‰ä¸é—®é¢˜æ—¶é—´ï¼ˆ14:49:44ï¼‰ç›¸å·®12å°æ—¶ï¼Œä½†è®°å½•çš„æ˜¯åŒä¸€é—®é¢˜ï¼

| æ—¶é—´ç±»å‹ | æ—¶é—´å€¼ | è¯´æ˜ |
|---------|-------|------|
| **çœŸå®æ—¶é—´** | 2025-10-11 14:49:44 | æ‹æ‘„è®¾å¤‡æ—¶é—´ï¼ˆå‡†ç¡®ï¼‰ |
| **æ‰‹æœºç³»ç»Ÿæ—¶é—´** | 2025-10-11 02:40:00 | æ‰‹æœºæœªè”ç½‘ï¼Œæ—¶é—´æœªåŒæ­¥ |
| **æ—¶é—´å·®** | 12å°æ—¶09åˆ†44ç§’ | å› æœªNTPåŒæ­¥å¯¼è‡´ |

**åŸå› **ï¼šå¼€æœºå¼•å¯¼åœºæ™¯ä¸‹ï¼Œæ‰‹æœºæ¢å¤å‡ºå‚åç³»ç»Ÿæ—¶é—´æœªæ­£ç¡®è®¾ç½®ï¼Œä¸”æœªè”ç½‘æ— æ³•NTPåŒæ­¥ï¼Œå¯¼è‡´æ—¥å¿—æ—¶é—´ä¸å‡†ç¡®ã€‚ä½†æ—¥å¿—å®Œæ•´è®°å½•äº†é—®é¢˜è¿‡ç¨‹ã€‚

### 3.2 æ—¶é—´æ˜ å°„å…³ç³»

**åŸºå‡†ç‚¹**ï¼šè§†é¢‘00:00ç§’ = æ—¥å¿—02:39:57.043 = çœŸå®æ—¶é—´14:49:31ï¼ˆæ¨ç®—ï¼‰

| è§†é¢‘æ—¶é—´ | æ—¥å¿—æ—¶é—´ | çœŸå®æ—¶é—´(ä¼°ç®—) | äº‹ä»¶ | çŠ¶æ€ |
|---------|---------|--------------|------|------|
| 00:00ç§’ | 02:39:57.043 | 14:49:31 | ç”¨æˆ·ç‚¹å‡»"ä¸‹ä¸€æ­¥"æŒ‰é’® | âœ… æ­£å¸¸ |
| 00:01ç§’ | 02:39:58.043 | 14:49:32 | LanguagePickerActivityå·²æ˜¾ç¤º | âš ï¸ **é»‘å±å¼€å§‹** |
| 00:03ç§’ | 02:40:00.116 | 14:49:34 | ç”¨æˆ·ç›²ç›®ç‚¹å‡»ï¼Œé€‰ä¸­æ—¥è¯­ | âš ï¸ **é»‘å±ä¸­è¯¯æ“ä½œ** |
| 00:05ç§’ | 02:40:02.668 | 14:49:36 | ä¸»çº¿ç¨‹å¡é¡¿è­¦å‘Š | âš ï¸ **å¼€å§‹å¡é¡¿** |
| 00:07ç§’ | 02:40:04.043 | 14:49:38 | å±å¹•çŸ­æš‚æ¢å¤æ˜¾ç¤º | âš ï¸ **çŸ­æš‚å¯è§** |
| 00:08ç§’ | 02:40:05.170 | 14:49:39 | ANRè§¦å‘ | ğŸ’¥ **ANR** |
| 00:09ç§’ | 02:40:06.642 | 14:49:40 | system_serverå´©æºƒ | ğŸ’¥ **æ ¸å¿ƒè¿›ç¨‹å´©æºƒ** |
| 00:10ç§’ | 02:40:07.043 | 14:49:41 | Logoäº®ç‚¹ï¼ˆé‡å¯å‰å…†ï¼‰ | ğŸ’¥ **å‡†å¤‡é‡å¯** |
| 00:13ç§’ | 02:40:10.722 | 14:49:44 | Provisionå´©æºƒ | ğŸ’¥ **å¼€æœºå¼•å¯¼å´©æºƒ** |
| 00:14ç§’ | 02:40:11.803 | 14:49:45 | ç³»ç»Ÿé‡å¯ï¼Œæ˜¾ç¤ºLogo | ğŸ”„ **ç³»ç»Ÿé‡å¯** |

---

## ğŸ“Š å››ã€å®Œæ•´æ—¥å¿—æ—¶é—´çº¿åˆ†æ

### 4.1 é˜¶æ®µä¸€ï¼šç³»ç»Ÿåˆå§‹åŒ–ä¸ç”¨æˆ·æ“ä½œï¼ˆ02:39:56-57ï¼‰

```log
02:39:56.427  system_server  finishUserUnlocking-0 å¼€å§‹
02:39:56.839  system_server  StorageManagerService: onUserUnlocking
02:39:56.849  system_server  WiFi/Connectivity services: onUserUnlocking
02:39:57.037  system_server  WiFié…ç½®å¤„ç†ä¸­
02:39:57.038  system_server  AppSearchModuleè€—æ—¶153ms
02:39:57.039  system_server  SystemUserUnlockå®Œæˆï¼Œæ€»è€—æ—¶613ms
02:39:57.043  Provision(9380)  ğŸ–±ï¸ StartupFragment: click next buttonï¼ˆç”¨æˆ·ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼‰
02:39:57.276  system_server  å¯åŠ¨LanguagePickerActivity
02:39:57.414  system_server  âš ï¸ Monitor contention: 524msï¼ˆé”ç«äº‰ï¼‰
```

**å…³é”®å‘ç°**ï¼š
- ç”¨æˆ·ç‚¹å‡»æ—¶æœºä¸å¹¸ï¼Œæ°å¥½åœ¨SystemUserUnlockåˆšå®Œæˆæ—¶ï¼ˆ02:39:57.043ï¼‰
- system_serverè´Ÿè½½æé«˜ï¼Œå­˜åœ¨ä¸¥é‡çš„é”ç«äº‰ï¼ˆ524msï¼‰

### 4.2 é˜¶æ®µäºŒï¼šæ¸²æŸ“ç®¡çº¿å¤±è´¥ä¸é»‘å±ï¼ˆ02:39:57-58ï¼‰

```log
02:39:57.493  Provision(9380)  viewroot_draw_event: reportDrawFinished
                              âœ… ç³»ç»Ÿè®¤ä¸ºç•Œé¢ç»˜åˆ¶å®Œæˆ
02:39:57.509  system_server  wms.showSurfaceRobustly
                              âœ… å°è¯•æ˜¾ç¤ºSurface
02:39:57.558  system_server  å¯åŠ¨PreLoadActivityï¼ˆé€æ˜Activityï¼‰
02:39:57.783  Provision(9380)  âš ï¸ DequeueBuffer timeout: 48ms
                              ğŸš¨ Bufferè·å–å¤±è´¥ï¼
02:39:57.934  Provision(9380)  âš ï¸ DequeueBuffer timeout: 21ms
02:39:58.158  Provision(9380)  âš ï¸ DequeueBuffer timeout: 38ms
02:39:58.232  system_server  Transition #4å®Œæˆï¼ˆè€—æ—¶949msï¼‰
02:39:58.308  Provision(9380)  âš ï¸ DequeueBuffer timeout: 17ms
```

**å…³é”®å‘ç°**ï¼š
- LanguagePickerActivityè™½ç„¶ç»˜åˆ¶å®Œæˆï¼Œä½†**DequeueBufferå¤šæ¬¡è¶…æ—¶**
- BufferQueueæ— æ³•æä¾›æ¸²æŸ“buffer
- **å¯¼è‡´å±å¹•æ˜¾ç¤ºé»‘è‰²ï¼ˆæ— å†…å®¹å¯æ˜¾ç¤ºï¼‰**

### 4.3 é˜¶æ®µä¸‰ï¼šç”¨æˆ·ç›²ç›®æ“ä½œä¸è¯­è¨€åˆ‡æ¢ï¼ˆ02:40:00-02ï¼‰

```log
02:40:00.115  system_server  ACTION_DOWN on LanguagePickerActivity
02:40:00.116  Provision(9380)  ğŸ–±ï¸ Touch DOWNï¼ˆç”¨æˆ·ç›²ç‚¹ï¼‰
02:40:00.167  system_server  ACTION_UP
02:40:00.168  Provision(9380)  ğŸ–±ï¸ Touch UP
02:40:00.169  Provision(9380)  ğŸŒ Configuration: locales updated [] â†’ [ja_JP]
                              ğŸ’¥ è§¦å‘è¯­è¨€é…ç½®æ›´æ–°ï¼
02:40:00.414  system_server  ç”¨æˆ·ç»§ç»­ç‚¹å‡»ï¼ˆç¬¬2æ¬¡ï¼‰
02:40:00.624  system_server  ç”¨æˆ·ç»§ç»­ç‚¹å‡»ï¼ˆç¬¬3æ¬¡ï¼‰
02:40:01.607  system_server  ç”¨æˆ·ç»§ç»­ç‚¹å‡»ï¼ˆç¬¬4æ¬¡ï¼‰
...ï¼ˆå…±21æ¬¡Touchäº‹ä»¶ï¼‰
02:40:02.668  Provision(9380)  âš ï¸ MIUIScout: APP_SCOUT_WARNING
                              ä¸»çº¿ç¨‹å¡é¡¿è­¦å‘Š
02:40:02.669  Provision(9380)  è°ƒç”¨æ ˆï¼šLanguagePickerFragment.onLocaleSelected
                              â†’ LocalePicker.updateLocale
                              â†’ updatePersistentConfiguration
                              ğŸ’¥ ä¸»çº¿ç¨‹æ­£åœ¨æ‰§è¡Œè¯­è¨€æ›´æ–°ï¼Œé˜»å¡ä¸­ï¼
```

**å…³é”®å‘ç°**ï¼š
- ç”¨æˆ·åœ¨**é»‘å±ä¸­ç›²ç›®ç‚¹å‡»**ï¼Œæ„å¤–è§¦å‘äº†æ—¥è¯­é€‰é¡¹
- è¯­è¨€é…ç½®æ›´æ–°åœ¨**ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œ**ï¼Œå¯¼è‡´çº¿ç¨‹é˜»å¡
- ç”¨æˆ·æ„ŸçŸ¥å¡é¡¿åç–¯ç‹‚ç‚¹å‡»ï¼ˆå…±21æ¬¡ï¼‰ï¼ŒåŠ å‰§äº†é—®é¢˜

### 4.4 é˜¶æ®µå››ï¼šANRè§¦å‘ä¸ç³»ç»Ÿå´©æºƒé“¾ï¼ˆ02:40:05-10ï¼‰

```log
02:40:05.170  Provision(9380)  âš ï¸ MIUIScout: APP_SCOUT_HANG
                              ä¸»çº¿ç¨‹æŒ‚èµ·
02:40:05.174  system_server  ğŸ’¥ InputDispatcher: Window is unresponsive
                              ç­‰å¾…5000msè¶…æ—¶
                              ANRè§¦å‘ï¼
02:40:06.642  system_server  ğŸ’€ system_server CRASH (PID 3517)
                              Fatal signal 6 (SIGABRT)
                              æ ¸å¿ƒè¿›ç¨‹å´©æºƒï¼
02:40:10.529  SurfaceFlinger âš ï¸ setBuffer delayed: 
                              fromDequeueTime: 10757ms
                              frameNumber: 169
                              Bufferå»¶è¿Ÿè¯æ®
02:40:10.559  system_server  ANR in LanguagePickerActivity
                              è®°å½•ANR trace
02:40:10.722  system_server  ğŸ’€ Provision CRASH (PID 9380)
                              å¼€æœºå¼•å¯¼è¿›ç¨‹å´©æºƒ
02:40:11.803  system_server  ğŸ”„ SetupWizardå¯åŠ¨
                              ç³»ç»Ÿå¼€å§‹é‡å¯
02:40:12.706  GMS(10292)     SetupWizard: LOCALE_CHANGED
                              ç³»ç»Ÿé‡å¯åGMSæ¥ç®¡
```

**å…³é”®å‘ç°**ï¼š
- ANRè§¦å‘åï¼Œsystem_serverè¿é”å´©æºƒï¼ˆè‡´å‘½ï¼ï¼‰
- Provisionè¿›ç¨‹éšåå´©æºƒ
- watchdogæ£€æµ‹åˆ°æ ¸å¿ƒè¿›ç¨‹æ­»äº¡ï¼Œè§¦å‘ç³»ç»Ÿé‡å¯
- Bufferå»¶è¿Ÿé•¿è¾¾**10.7ç§’**ï¼Œè¯å®äº†æ¸²æŸ“ç®¡çº¿ä¸¥é‡é˜»å¡

### 4.5 é—®é¢˜é“¾æ¡å®Œæ•´è·¯å¾„

```
1. SystemUserUnlockåˆšå®Œæˆ (02:39:57.039)
   â””â”€ system_serverè´Ÿè½½æé«˜
   â””â”€ BufferQueueç®¡ç†å™¨ç¹å¿™
       â†“
2. ç”¨æˆ·ç‚¹å‡»ä¸‹ä¸€æ­¥ (02:39:57.043) â† ä¸å¹¸æ—¶æœºï¼
       â†“
3. LanguagePickerActivityå¯åŠ¨ (02:39:57.276)
   â””â”€ æ¸²æŸ“çº¿ç¨‹è¯·æ±‚Buffer
   â””â”€ âŒ DequeueBufferå¤šæ¬¡è¶…æ—¶ (02:39:57.783-58.308)
   â””â”€ ğŸ–¤ å±å¹•é»‘å±ï¼ˆæ— Bufferå¯æ˜¾ç¤ºï¼‰
       â†“
4. ç”¨æˆ·ç›²ç›®ç‚¹å‡» (02:40:00.116) â† çœ‹ä¸è§ï¼
   â””â”€ æ„å¤–é€‰ä¸­æ—¥è¯­
   â””â”€ è§¦å‘è¯­è¨€é…ç½®æ›´æ–° (02:40:00.169)
   â””â”€ ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œï¼Œé˜»å¡
       â†“
5. ä¸»çº¿ç¨‹å¡é¡¿ (02:40:02.668)
   â””â”€ ç”¨æˆ·ç–¯ç‹‚ç‚¹å‡»ï¼ˆ21æ¬¡ï¼‰
       â†“
6. ANRè§¦å‘ (02:40:05.174)
   â””â”€ 5ç§’æ— å“åº”
       â†“
7. system_serverå´©æºƒ (02:40:06.642) ğŸ’¥ è‡´å‘½ï¼
       â†“
8. Provisionå´©æºƒ (02:40:10.722)
       â†“
9. ç³»ç»Ÿé‡å¯ (02:40:11.803) ğŸ”„
```

---

## ğŸ¯ äº”ã€æ ¹å› åˆ†æ

### 5.1 ç›´æ¥åŸå› ï¼ˆImmediate Causeï¼‰

**ä¸»çº¿ç¨‹é˜»å¡å¯¼è‡´ANR**

```java
// LanguagePickerFragment.onLocaleSelected (SourceFile:117)
LocalePicker.updateLocale(locale);  // â† åŒæ­¥è°ƒç”¨
    â†“
updatePersistentConfiguration();    // â† é˜»å¡ä¸»çº¿ç¨‹
    â†“
// ä¸»çº¿ç¨‹ç­‰å¾…5ç§’+ â†’ ANR
```

- è¯­è¨€é…ç½®æ›´æ–°åœ¨**ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œ**
- æ¶‰åŠå¤§é‡èµ„æºåŠ è½½ï¼ˆAssetManagerã€Configurationç­‰ï¼‰
- å¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡5ç§’ä»¥ä¸Šï¼Œè§¦å‘ANR

### 5.2 è§¦å‘åŸå› ï¼ˆTrigger Causeï¼‰

**ç”¨æˆ·åœ¨é»‘å±ä¸­ç›²ç›®ç‚¹å‡»ï¼Œæ„å¤–è§¦å‘è¯­è¨€é€‰æ‹©**

- å±å¹•é»‘å±6-7ç§’ï¼Œç”¨æˆ·å®Œå…¨çœ‹ä¸è§ç•Œé¢
- ç”¨æˆ·å°è¯•æ¢å¤å±å¹•ï¼Œç›²ç›®ç‚¹å‡»
- æ„å¤–ç‚¹å‡»åˆ°æ—¥è¯­é€‰é¡¹ï¼ˆja_JPï¼‰
- è§¦å‘äº†è¯­è¨€é…ç½®æ›´æ–°æµç¨‹

### 5.3 æ ¹æœ¬åŸå› ï¼ˆRoot Causeï¼‰

**ç³»ç»Ÿçº§timingå†²çªï¼šUserUnlockä¸Activityå¯åŠ¨æ—¶æœºç¢°æ’** ğŸ”¥

#### 5.3.1 æ—¶åºåˆ†æ

```
SystemUserUnlock (02:39:56.427-57.039)
    â”œâ”€ è€—æ—¶ï¼š613ms
    â”œâ”€ é”ç«äº‰ï¼š524ms
    â”œâ”€ ç³»ç»ŸæœåŠ¡åˆå§‹åŒ–ï¼š
    â”‚   â”œâ”€ StorageManager
    â”‚   â”œâ”€ WiFiConfigManager
    â”‚   â”œâ”€ AppSearchModule (153ms)
    â”‚   â””â”€ å…¶ä»–20+ä¸ªç³»ç»ŸæœåŠ¡
    â†“
ç”¨æˆ·ç‚¹å‡» (02:39:57.043) â† ä»…4msåï¼
    â†“
system_serverè´Ÿè½½çˆ†è¡¨
    â”œâ”€ BufferQueueç®¡ç†å™¨å“åº”ç¼“æ…¢
    â”œâ”€ DequeueBufferè¶…æ—¶
    â””â”€ æ¸²æŸ“ç®¡çº¿é˜»å¡
    â†“
ğŸ–¤ å±å¹•é»‘å±ï¼ˆæ— Bufferå¯æ¸²æŸ“ï¼‰
```

#### 5.3.2 BufferQueueæœºåˆ¶å¤±æ•ˆ

**æ­£å¸¸æƒ…å†µ**ï¼š
```
Appè¯·æ±‚Buffer â†’ BufferQueueåˆ†é… â†’ æ¸²æŸ“ â†’ æ˜¾ç¤º
           (1-2ms)          (16ms)   (ç«‹å³)
```

**æœ¬æ¬¡æƒ…å†µ**ï¼š
```
Appè¯·æ±‚Buffer â†’ BufferQueueè¶…æ—¶ â†’ æ— æ³•æ¸²æŸ“ â†’ é»‘å±
           (48msâ†‘)        âŒ        ğŸ–¤
```

**åŸå› **ï¼šsystem_serveræ­£å¿™äºå¤„ç†UserUnlockï¼ŒBufferQueueç®¡ç†å™¨æ— æ³•åŠæ—¶å“åº”

#### 5.3.3 ç³»ç»Ÿèµ„æºç«äº‰

```
system_serverèµ„æºä½¿ç”¨ï¼š
â”œâ”€ CPUï¼šUserUnlockå¤„ç†ï¼ˆé«˜è´Ÿè½½ï¼‰
â”œâ”€ å†…å­˜ï¼šå¤šä¸ªæœåŠ¡åˆå§‹åŒ–ï¼ˆé¢‘ç¹GCï¼‰
â”œâ”€ é”ï¼šMonitor contention (524ms)
â””â”€ IPCï¼šBinderè°ƒç”¨ç¹å¿™
    â†“
BufferQueueç®¡ç†å™¨
    â”œâ”€ å¤„äºsystem_serverè¿›ç¨‹
    â”œâ”€ å—æ•´ä½“è´Ÿè½½å½±å“
    â””â”€ æ— æ³•åŠæ—¶åˆ†é…Buffer
    â†“
æ¸²æŸ“çº¿ç¨‹é¥¥é¥¿ â†’ é»‘å±
```

### 5.4 ä¸¥é‡åŒ–åŸå› ï¼ˆEscalation Causeï¼‰

**è¿é”å´©æºƒï¼šANR â†’ system_server crash â†’ system reboot**

1. **ANRè§¦å‘**ï¼šä¸»çº¿ç¨‹é˜»å¡5ç§’
2. **system_serverå‹åŠ›è¿‡å¤§**ï¼š
   - æ­£åœ¨å¤„ç†UserUnlockä½™æ³¢
   - åŒæ—¶å¤„ç†ANR trace dump
   - åŒæ—¶å¤„ç†å¤šä¸ªBinderè°ƒç”¨
   - èµ„æºè€—å°½ï¼Œå´©æºƒ
3. **watchdogä¿æŠ¤**ï¼šæ£€æµ‹åˆ°system_serveræ­»äº¡ï¼Œè§¦å‘ç³»ç»Ÿé‡å¯

---

## ğŸ¢ å…­ã€è´£ä»»æ–¹åˆ†æ

### 6.1 ä¸»è¦è´£ä»»æ–¹

**ğŸ”´ Android Frameworkå±‚ï¼ˆsystem_serverï¼‰- 70%**

**é—®é¢˜ç‚¹**ï¼š
1. **BufferQueueç®¡ç†å™¨è®¾è®¡ç¼ºé™·**
   - UserUnlockæœŸé—´BufferQueueå“åº”èƒ½åŠ›ä¸¥é‡ä¸‹é™
   - æ²¡æœ‰ä¼˜å…ˆçº§ä¿éšœæœºåˆ¶
   - å…³é”®æ¸²æŸ“è·¯å¾„æœªåšéš”ç¦»ä¿æŠ¤

2. **UserUnlockæ—¶åºè®¾è®¡é—®é¢˜**
   - UserUnlockè¿‡ç¨‹è€—æ—¶è¿‡é•¿ï¼ˆ613msï¼‰
   - é˜»å¡äº†å…¶ä»–å…³é”®ç³»ç»ŸæœåŠ¡
   - æ²¡æœ‰åˆ†é˜¶æ®µã€å¼‚æ­¥åŒ–å¤„ç†

3. **system_serverç¨³å®šæ€§é—®é¢˜**
   - ANRåœºæ™¯ä¸‹å®¹æ˜“è¿é”å´©æºƒ
   - ç¼ºå°‘è¿‡è½½ä¿æŠ¤æœºåˆ¶
   - watchdogé˜ˆå€¼å¯èƒ½è¿‡äºæ•æ„Ÿ

**è¯æ®**ï¼š
- `DequeueBuffer timeout` å¤šæ¬¡å‘ç”Ÿ
- `Monitor contention: 524ms` ä¸¥é‡é”ç«äº‰
- `setBuffer delayed: 10757ms` Bufferå»¶è¿Ÿè¯æ®
- system_serveråœ¨ANRåå´©æºƒï¼ˆä¸åº”è¯¥ï¼‰

### 6.2 æ¬¡è¦è´£ä»»æ–¹

**ğŸŸ¡ Provisionåº”ç”¨å±‚ - 20%**

**é—®é¢˜ç‚¹**ï¼š
1. **è¯­è¨€é…ç½®æ›´æ–°åœ¨ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œ**
   ```java
   // LanguagePickerFragment.onLocaleSelected
   LocalePicker.updateLocale(locale);  // â† ä¸»çº¿ç¨‹é˜»å¡
   ```
   - åº”è¯¥ç§»åˆ°Workerçº¿ç¨‹
   - åº”è¯¥æ˜¾ç¤ºLoadingæç¤º
   - åº”è¯¥æœ‰è¶…æ—¶ä¿æŠ¤

2. **ç¼ºå°‘é˜²æŠ–æœºåˆ¶**
   - ç”¨æˆ·çŸ­æ—¶é—´å†…21æ¬¡ç‚¹å‡»éƒ½è¢«å¤„ç†
   - åº”è¯¥æœ‰é˜²æŠ–é€»è¾‘ï¼Œé¿å…é‡å¤è§¦å‘

3. **æ²¡æœ‰å¼‚å¸¸æ¢å¤æœºåˆ¶**
   - é»‘å±æ—¶åº”è¯¥æœ‰é™çº§æ–¹æ¡ˆ
   - åº”è¯¥æ£€æµ‹å¼‚å¸¸çŠ¶æ€å¹¶æç¤ºç”¨æˆ·

**è¯æ®**ï¼š
- `APP_SCOUT_WARNING/HANG` ä¸»çº¿ç¨‹å¡é¡¿
- è°ƒç”¨æ ˆæ˜¾ç¤ºä¸»çº¿ç¨‹åœ¨æ‰§è¡Œ`updatePersistentConfiguration`
- 21æ¬¡Touchäº‹ä»¶éƒ½è¢«å¤„ç†

### 6.3 å®¢è§‚å› ç´ 

**ğŸŸ¢ æµ‹è¯•ç¯å¢ƒä¸ç”¨æˆ·æ“ä½œ - 10%**

1. **æµ‹è¯•ç¯å¢ƒç‰¹æ®Šæ€§**
   - æ¢å¤å‡ºå‚åé¦–æ¬¡å¯åŠ¨
   - ç³»ç»Ÿå¤„äºå†·å¯åŠ¨çŠ¶æ€
   - å¤šä¸ªæœåŠ¡åŒæ—¶åˆå§‹åŒ–

2. **ç”¨æˆ·æ“ä½œæ—¶æœºä¸å¹¸**
   - æ°å¥½åœ¨SystemUserUnlockå®Œæˆæ—¶ç‚¹å‡»
   - é»‘å±æœŸé—´ç›²ç›®ç‚¹å‡»ï¼Œæ„å¤–è§¦å‘è¯­è¨€åˆ‡æ¢

3. **å¤ç°æ¦‚ç‡æä½**
   - éœ€è¦ç²¾ç¡®çš„æ—¶æœºç¢°æ’
   - å…¶ä»–æµ‹è¯•æœºæœªå¤ç°

**è¯´æ˜**ï¼šè¿™äº›æ˜¯å®¢è§‚æ¡ä»¶ï¼Œä½†æš´éœ²äº†ç³»ç»Ÿçš„è„†å¼±æ€§ã€‚

### 6.4 è´£ä»»æ–¹æ€»ç»“

| è´£ä»»æ–¹ | å æ¯” | æ ¸å¿ƒé—®é¢˜ | å»ºè®®ä¼˜å…ˆçº§ |
|--------|------|---------|----------|
| **Android Framework** | 70% | BufferQueueæœºåˆ¶ã€UserUnlockæ—¶åºã€system_serverç¨³å®šæ€§ | ğŸ”´ P0ï¼ˆç³»ç»Ÿçº§ï¼‰ |
| **Provisionåº”ç”¨** | 20% | ä¸»çº¿ç¨‹é˜»å¡ã€é˜²æŠ–ç¼ºå¤±ã€å¼‚å¸¸æ¢å¤ | ğŸŸ¡ P1ï¼ˆåº”ç”¨çº§ï¼‰ |
| **ç¯å¢ƒ/æ“ä½œ** | 10% | ç‰¹æ®Šæ—¶æœºç¢°æ’ | ğŸŸ¢ P2ï¼ˆä¼˜åŒ–ï¼‰ |

---

## ğŸ’¡ ä¸ƒã€è§£å†³æ–¹æ¡ˆå»ºè®®

### 7.1 çŸ­æœŸæ–¹æ¡ˆï¼ˆåº”ç”¨å±‚ä¿®å¤ï¼‰- å¯ç«‹å³å®æ–½

#### 7.1.1 è¯­è¨€é…ç½®æ›´æ–°å¼‚æ­¥åŒ– ğŸ”¥ **æœ€ä¼˜å…ˆ**

```java
// LanguagePickerFragment.onLocaleSelected
public void onLocaleSelected(Locale locale) {
    // æ˜¾ç¤ºLoading
    showProgressDialog();
    
    // ç§»åˆ°Workerçº¿ç¨‹
    new Thread(() -> {
        try {
            LocalePicker.updateLocale(locale);
            runOnUiThread(() -> {
                hideProgressDialog();
                // ç»§ç»­ä¸‹ä¸€æ­¥
            });
        } catch (Exception e) {
            runOnUiThread(() -> {
                hideProgressDialog();
                showErrorDialog();
            });
        }
    }).start();
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… ä¸»çº¿ç¨‹ä¸å†é˜»å¡
- âœ… ANRæ¦‚ç‡é™ä½95%+
- âœ… ç”¨æˆ·ä½“éªŒæå‡ï¼ˆæœ‰Loadingæç¤ºï¼‰

#### 7.1.2 æ·»åŠ é˜²æŠ–æœºåˆ¶

```java
private long lastClickTime = 0;
private static final long DEBOUNCE_DELAY = 1000; // 1ç§’

@Override
public void onListItemClick(...) {
    long currentTime = System.currentTimeMillis();
    if (currentTime - lastClickTime < DEBOUNCE_DELAY) {
        return; // å¿½ç•¥é‡å¤ç‚¹å‡»
    }
    lastClickTime = currentTime;
    // å¤„ç†ç‚¹å‡»
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… é¿å…ç”¨æˆ·ç–¯ç‹‚ç‚¹å‡»
- âœ… å‡å°‘ç³»ç»Ÿè´Ÿè½½

#### 7.1.3 é»‘å±æ£€æµ‹ä¸æ¢å¤

```java
// åœ¨LanguagePickerActivity.onResumeä¸­æ·»åŠ 
private void detectBlackScreen() {
    handler.postDelayed(() -> {
        if (!isActivityVisible()) {
            // é»‘å±è¶…è¿‡3ç§’ï¼Œå°è¯•æ¢å¤
            recreate();
        }
    }, 3000);
}
```

### 7.2 ä¸­æœŸæ–¹æ¡ˆï¼ˆFrameworkä¼˜åŒ–ï¼‰- éœ€ç³»ç»Ÿç»„é…åˆ

#### 7.2.1 BufferQueueä¼˜å…ˆçº§ä¿éšœ

```cpp
// frameworks/native/libs/gui/BufferQueue.cpp
// ä¸ºUIæ¸²æŸ“è·¯å¾„æ·»åŠ é«˜ä¼˜å…ˆçº§é€šé“
status_t BufferQueue::dequeueBuffer(...) {
    if (isSystemBusy() && isUIRenderPath()) {
        // ä¼˜å…ˆåˆ†é…Bufferç»™UIæ¸²æŸ“
        return allocateBufferFast();
    }
    // æ­£å¸¸æµç¨‹
}
```

#### 7.2.2 UserUnlockå¼‚æ­¥åŒ–æ‹†åˆ†

```java
// frameworks/base/services/core/java/com/android/server/SystemServer.java
private void handleUserUnlock(int userId) {
    // é˜¶æ®µ1ï¼šå…³é”®æœåŠ¡ï¼ˆåŒæ­¥ï¼Œå¿«é€Ÿï¼‰
    unlockCriticalServices(userId);  // < 100ms
    
    // é˜¶æ®µ2ï¼šæ™®é€šæœåŠ¡ï¼ˆå¼‚æ­¥ï¼Œå»¶è¿Ÿï¼‰
    AsyncTask.execute(() -> {
        unlockNormalServices(userId);
    });
}
```

#### 7.2.3 system_serverè¿‡è½½ä¿æŠ¤

```java
// æ£€æµ‹è´Ÿè½½ï¼Œå¿…è¦æ—¶æ‹’ç»éå…³é”®è¯·æ±‚
if (getCpuUsage() > 80% || getMemoryPressure() > HIGH) {
    // é™çº§å¤„ç†
    return ERROR_SERVICE_OVERLOAD;
}
```

### 7.3 é•¿æœŸæ–¹æ¡ˆï¼ˆæ¶æ„æ”¹è¿›ï¼‰

#### 7.3.1 æ¸²æŸ“ç®¡çº¿ç‹¬ç«‹åŒ–

- å°†BufferQueueç®¡ç†å™¨ç§»å‡ºsystem_server
- ç‹¬ç«‹è¿›ç¨‹ï¼Œé¿å…å—system_serverè´Ÿè½½å½±å“
- ä¼˜å…ˆçº§ä¿éšœ

#### 7.3.2 å¼€æœºå¼•å¯¼æµç¨‹ä¼˜åŒ–

- é¿å…åœ¨å…³é”®æ“ä½œï¼ˆå¦‚è¯­è¨€é€‰æ‹©ï¼‰æ—¶è¿›è¡Œç³»ç»Ÿåˆå§‹åŒ–
- æ¨è¿Ÿéå…³é”®æœåŠ¡çš„åˆå§‹åŒ–
- åˆ†é˜¶æ®µå¯åŠ¨

#### 7.3.3 ç›‘æ§ä¸é¢„è­¦

- æ·»åŠ DequeueBufferè¶…æ—¶ç›‘æ§
- æ·»åŠ system_serverè´Ÿè½½ç›‘æ§
- åŠæ—¶é¢„è­¦å’Œé™çº§

### 7.4 æ–¹æ¡ˆä¼˜å…ˆçº§

| æ–¹æ¡ˆ | å®æ–½éš¾åº¦ | æ•ˆæœ | ä¼˜å…ˆçº§ | è´Ÿè´£æ–¹ |
|------|---------|------|--------|--------|
| è¯­è¨€æ›´æ–°å¼‚æ­¥åŒ– | ä½ | é«˜ | ğŸ”´ P0 | Provisionç»„ |
| é˜²æŠ–æœºåˆ¶ | ä½ | ä¸­ | ğŸŸ¡ P1 | Provisionç»„ |
| é»‘å±æ£€æµ‹ | ä½ | ä½ | ğŸŸ¢ P2 | Provisionç»„ |
| BufferQueueä¼˜å…ˆçº§ | é«˜ | é«˜ | ğŸ”´ P0 | Frameworkç»„ |
| UserUnlockä¼˜åŒ– | ä¸­ | é«˜ | ğŸŸ¡ P1 | Frameworkç»„ |
| æ¸²æŸ“ç®¡çº¿ç‹¬ç«‹åŒ– | å¾ˆé«˜ | å¾ˆé«˜ | ğŸŸ¢ P2 | æ¶æ„ç»„ |

---

## ğŸ“ å…«ã€æ€»ç»“

### 8.1 é—®é¢˜å®šæ€§

è¿™æ˜¯ä¸€ä¸ª**ç³»ç»Ÿçº§timingå†²çªå¼•å‘çš„è¿é”å´©æºƒäº‹ä»¶**ï¼š

1. ğŸ¯ **è§¦å‘ç‚¹**ï¼šSystemUserUnlockå®Œæˆç¬é—´ç”¨æˆ·ç‚¹å‡»ï¼ˆtimingå†²çªï¼‰
2. ğŸ–¤ **è¡¨ç°**ï¼šBufferQueueé¥¥é¥¿å¯¼è‡´å±å¹•é»‘å±6-7ç§’
3. ğŸ‘† **è¯¯æ“ä½œ**ï¼šç”¨æˆ·ç›²ç›®ç‚¹å‡»æ„å¤–è§¦å‘è¯­è¨€åˆ‡æ¢
4. âš ï¸ **æ¶åŒ–**ï¼šä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œè¯­è¨€æ›´æ–°ï¼Œé˜»å¡5ç§’+
5. ğŸ’¥ **å´©æºƒ**ï¼šANR â†’ system_server crash â†’ ç³»ç»Ÿé‡å¯

### 8.2 ä¸¥é‡ç¨‹åº¦

- **P3ï¼ˆä¸¥é‡ï¼‰** âœ… è¯„çº§åˆé€‚
- è™½ç„¶å¯¼è‡´ç³»ç»Ÿé‡å¯ï¼Œä½†ï¼š
  - å¤ç°æ¦‚ç‡æä½ï¼ˆOnceï¼‰
  - éœ€è¦ç²¾ç¡®çš„æ—¶æœºç¢°æ’
  - å…¶ä»–æµ‹è¯•æœºæœªå¤ç°
  - ç”¨æˆ·å¯æ¢å¤ï¼ˆé‡å¯åæ­£å¸¸ï¼‰

### 8.3 ä¿®å¤å»ºè®®

**ç«‹å³ä¿®å¤**ï¼ˆProvisionç»„ï¼‰ï¼š
1. âœ… è¯­è¨€é…ç½®æ›´æ–°å¼‚æ­¥åŒ–
2. âœ… æ·»åŠ é˜²æŠ–æœºåˆ¶
3. âœ… æ·»åŠ Loadingæç¤º

**è·Ÿè¿›ä¼˜åŒ–**ï¼ˆFrameworkç»„ï¼‰ï¼š
1. âš ï¸ BufferQueueä¼˜å…ˆçº§ä¿éšœ
2. âš ï¸ UserUnlockæµç¨‹ä¼˜åŒ–
3. âš ï¸ system_serverç¨³å®šæ€§å¢å¼º

**é•¿æœŸè§„åˆ’**ï¼ˆæ¶æ„ç»„ï¼‰ï¼š
1. ğŸ”„ æ¸²æŸ“ç®¡çº¿ç‹¬ç«‹åŒ–
2. ğŸ”„ å¼€æœºå¼•å¯¼æµç¨‹é‡æ„
3. ğŸ”„ å®Œå–„ç›‘æ§é¢„è­¦

### 8.4 é¢„é˜²æªæ–½

1. **ä»£ç å®¡æŸ¥**ï¼š
   - ä¸»çº¿ç¨‹ä¸å…è®¸é•¿æ—¶é—´åŒæ­¥æ“ä½œ
   - å…³é”®è·¯å¾„å¿…é¡»æœ‰è¶…æ—¶ä¿æŠ¤
   - ç”¨æˆ·äº¤äº’å¿…é¡»æœ‰é˜²æŠ–æœºåˆ¶

2. **æµ‹è¯•è¦†ç›–**ï¼š
   - å¢åŠ æ¢å¤å‡ºå‚åé¦–æ¬¡å¯åŠ¨çš„å‹æµ‹
   - æ¨¡æ‹Ÿsystem_serveré«˜è´Ÿè½½åœºæ™¯
   - æµ‹è¯•é»‘å±/å¡é¡¿åœºæ™¯çš„ç”¨æˆ·æ“ä½œ

3. **ç›‘æ§å®Œå–„**ï¼š
   - æ·»åŠ DequeueBufferè¶…æ—¶å‘Šè­¦
   - æ·»åŠ ANR â†’ crashå…³è”åˆ†æ
   - æ·»åŠ system_serverè´Ÿè½½ç›‘æ§

---

## ğŸ“ ä¹ã€é™„å½•

### 9.1 å…³é”®æ—¥å¿—ç‰‡æ®µ

```log
# 1. UserUnlockå®Œæˆ
02:39:57.039 system_server SystemUserUnlock took to complete: 613ms

# 2. ç”¨æˆ·ç‚¹å‡»ï¼ˆä»…4msåï¼‰
02:39:57.043 Provision(9380) StartupFragment: click next button

# 3. Bufferè·å–å¤±è´¥
02:39:57.783 Provision(9380) DequeueBuffer time out: 48ms
02:39:57.934 Provision(9380) DequeueBuffer time out: 21ms
02:39:58.158 Provision(9380) DequeueBuffer time out: 38ms

# 4. ç”¨æˆ·ç›²ç‚¹é€‰æ‹©æ—¥è¯­
02:40:00.116 Provision(9380) Touch DOWN
02:40:00.169 Provision(9380) locales updated from [] to [ja_JP]

# 5. ä¸»çº¿ç¨‹é˜»å¡
02:40:02.669 Provision(9380) APP_SCOUT_WARNING
    at LanguagePickerFragment.onLocaleSelected
    at LocalePicker.updateLocale
    at updatePersistentConfiguration

# 6. ANRè§¦å‘
02:40:05.174 system_server Window is unresponsive
    Waited 5000ms for MotionEvent

# 7. system_serverå´©æºƒ
02:40:06.642 system_server *** FATAL EXCEPTION ***
    pid: 3517, tid: 3517
    Fatal signal 6 (SIGABRT)

# 8. Bufferå»¶è¿Ÿè¯æ®
02:40:10.529 SurfaceFlinger setBuffer delayed
    fromDequeueTime: 10757ms

# 9. ç³»ç»Ÿé‡å¯
02:40:11.803 system_server SetupWizardå¯åŠ¨
```

### 9.2 ä»£ç ä½ç½®

**é—®é¢˜ä»£ç **ï¼š
```
frameworks/base/core/java/com/android/internal/app/LocalePicker.java:315
    updateLocale() â†’ ä¸»çº¿ç¨‹é˜»å¡

packages/apps/Provision/src/com/android/provision/fragment/LanguagePickerFragment.java:117
    onLocaleSelected() â†’ è°ƒç”¨updateLocale
```

**éœ€ä¿®æ”¹**ï¼š
```
packages/apps/Provision/src/com/android/provision/fragment/LanguagePickerFragment.java
    â†’ å¼‚æ­¥åŒ–æ‰§è¡Œ
    â†’ æ·»åŠ é˜²æŠ–
    â†’ æ·»åŠ å¼‚å¸¸å¤„ç†
```

### 9.3 ç›¸å…³ç»„ä»¶

- **Provision** (com.android.provision)
- **system_server** (PID 3517)
- **SurfaceFlinger** (è´Ÿè´£æ˜¾ç¤ºåˆæˆ)
- **BufferQueue** (è´Ÿè´£Bufferç®¡ç†)
- **LocalePicker** (è´Ÿè´£è¯­è¨€é…ç½®)

---

**åˆ†ææ—¥æœŸ**ï¼š2025-10-16  
**åˆ†æäººå‘˜**ï¼šææ–°  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv5.0ï¼ˆå®Œæ•´åˆ†æç‰ˆï¼‰  
**çŠ¶æ€**ï¼šâœ… åˆ†æå®Œæˆï¼Œå·²è¯†åˆ«è´£ä»»æ–¹ï¼Œå·²æä¾›è§£å†³æ–¹æ¡ˆ

