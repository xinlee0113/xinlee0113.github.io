---
layout: default
title: BUGOS2-716277 å¼€æœºå¼•å¯¼é‡å¯åç”¨æˆ·åè®®æ— æ³•æ‰“å¼€é—®é¢˜åˆ†æ
parent: é—®é¢˜ä¿®å¤
---



# BUGOS2-716277 å¼€æœºå¼•å¯¼é‡å¯åç”¨æˆ·åè®®æ— æ³•æ‰“å¼€é—®é¢˜åˆ†æ

## ğŸ“‹ é—®é¢˜ä¿¡æ¯

| å­—æ®µ | å†…å®¹ |
|------|------|
| **é—®é¢˜å•å·** | BUGOS2-716277 |
| **é—®é¢˜æ ‡é¢˜** | N12-GLå¼€æœºå¼•å¯¼æ‰‹åŠ¿é¡µé¢/ç»å…¸å¯¼èˆªé¡µé¢é‡å¯åä½¿ç”¨æ¡æ¬¾ç”¨æˆ·åè®®ä¸éšç§æ”¿ç­–æ— æ³•æ‰“å¼€ |
| **ä¼˜å…ˆçº§** | ä¸¥é‡ |
| **æœºå‹** | N12_global |
| **Androidç‰ˆæœ¬** | 16.0 |
| **ROMç‰ˆæœ¬** | OS3.0.9.19.W_STABLE_GL |
| **å¤ç°æ¦‚ç‡** | 2/3ï¼ˆé«˜é¢‘å¶ç°ï¼‰ |
| **é—®é¢˜å½’å±** | å°ç±³ Xiaomi |
| **ç»„ä»¶** | å¼€æœºå¼•å¯¼ Provision |
| **Corgi ID** | 8032867 |
| **é—®é¢˜é“¾æ¥** | https://jira-phone.mioffice.cn/browse/BUGOS2-716277 |

### é—®é¢˜æè¿°
- **æµ‹è¯•ç±»å‹**ï¼šæ‰‹å·¥æµ‹è¯•
- **å¤ç°æ¦‚ç‡**ï¼š2/3
- **å‰ææ¡ä»¶**ï¼šæ— 
- **å¤ç°æ­¥éª¤**ï¼šN12-GLå¼€æœºå¼•å¯¼æ‰‹åŠ¿é¡µé¢/ç»å…¸å¯¼èˆªé¡µé¢é‡å¯åä½¿ç”¨æ¡æ¬¾ç”¨æˆ·åè®®ä¸éšç§æ”¿ç­–æ— æ³•æ‰“å¼€
- **é¢„æœŸç»“æœ**ï¼šå¯ä»¥æ­£å¸¸è¿›å…¥ç”¨æˆ·åè®®é¡µé¢
- **å®é™…ç»“æœ**ï¼šæç¤º"not found"ï¼ŒæŠ›å‡ºActivityNotFoundException
- **æ˜¯å¦å¯æ¢å¤**ï¼šæ¢å¤æ“ä½œå®¹æ˜“ï¼ˆ**ç­‰å¾…ä¸€ä¼šåå†ç‚¹å‡»å¯ä»¥æ­£å¸¸è¿›å…¥**ï¼‰

### æ—¥å¿—æ¥æº
- **Jiraé™„ä»¶**ï¼šbugreport-rothko_global-BP2A.250605.031.A3-2025-09-20-18-08-15.zip
- **Kpané“¾æ¥**ï¼šhttps://kpan.mioffice.cn/webfolder/ext/MRe9E#TDed#$uVm31GQvyw@@ ï¼ˆå¯†ç ï¼š9a9Kï¼‰
- **ææ•ˆå·¥å…·æ—¥å¿—**ï¼šhttps://cnbj1-fds.api.xiaomi.net/jira-logs/RREOSBUG-23920.zip
- **æœ¬åœ°æ—¥å¿—è·¯å¾„**ï¼š`/mnt/01_lixin_workspace/miui_apps/MiuiProvisionAosp/logs/BUGOS2-716277_files/`

---

## â° æ—¥å¿—æ—¶é—´éªŒè¯

### æ—¶é—´å¯¹æ¯”
| é¡¹ç›® | æ—¶é—´ | è¯´æ˜ |
|------|------|------|
| **ç³»ç»Ÿå¯åŠ¨å®Œæˆæ—¶é—´** | 2025-09-20 18:07:22 | Boot completed |
| **ç”¨æˆ·è§£é”å¼€å§‹æ—¶é—´** | 2025-09-20 18:07:29 | keystore2: on_device_unlocked |
| **é—®é¢˜é¦–æ¬¡å‘ç”Ÿæ—¶é—´** | 2025-09-20 18:07:31 | é¦–æ¬¡ç‚¹å‡»ç”¨æˆ·åè®®æ—¶æŠ›å‡ºå¼‚å¸¸ |
| **æ—¥å¿—é‡‡é›†æ—¶é—´** | 2025-09-20 18:08:15 | dumpstateå¼€å§‹æ—¶é—´ |
| **å…³é”®æ—¶é—´å·®** | **å¯åŠ¨å®Œæˆå9ç§’ï¼Œè§£é”å¼€å§‹å2ç§’** | âš ï¸ ç”¨æˆ·åœ¨ç³»ç»Ÿè§£é”è¿‡ç¨‹ä¸­æ“ä½œ |

### éªŒè¯ç»“è®º
âœ… **æ—¥å¿—æ—¶é—´å®Œå…¨åŒ¹é…ï¼Œå®Œæ•´è¦†ç›–é—®é¢˜ç°åœº**
- æ—¥å¿—é‡‡é›†æ—¶é—´åœ¨é—®é¢˜å‘ç”Ÿå44ç§’ï¼Œå®Œæ•´æ•è·äº†é—®é¢˜ç°åœº
- é—®é¢˜å‘ç”Ÿåœ¨ç³»ç»Ÿå¯åŠ¨å®Œæˆåä»…9ç§’ï¼Œå°è¯äº†"é‡å¯åç«‹å³ç‚¹å‡»"çš„åœºæ™¯æè¿°
- **å…³é”®å‘ç°**ï¼šé—®é¢˜å‘ç”Ÿåœ¨ç³»ç»Ÿæ­£åœ¨è§£é”è¿‡ç¨‹ä¸­ï¼ˆ18:07:29å¼€å§‹è§£é”ï¼Œ18:07:31å‘ç”Ÿé—®é¢˜ï¼‰
- æ—¥å¿—ä¸­è®°å½•äº†è¿ç»­å¤šæ¬¡ç‚¹å‡»å¤±è´¥ï¼ˆ18:07:31 - 18:07:34ï¼Œå…±7æ¬¡ï¼‰
- è¯¥æ—¥å¿—å¯ç”¨äºæ·±åº¦é—®é¢˜åˆ†æ

---

## æ—¥å¿—æ—¶é—´çº¿åˆ†æï¼ˆåŸºäºçœŸå®æ—¥å¿—ï¼‰

### Frameworkå±‚CEå­˜å‚¨è§£é”ä¸PackageManagerå¯ç”¨æ€§æ—¶åºé—®é¢˜

```log
â”â”â”â”â”â”â”â”â”â”â”â” é˜¶æ®µ1ï¼šç³»ç»Ÿå¯åŠ¨ä½†User 0ä»Lockedï¼ˆ18:07:19 - 18:07:22ï¼‰â”â”â”â”â”â”â”â”â”â”â”â”

09-20 18:07:19.666  1000  1472  2478 W UsageStatsService: Failed to query usage stats for locked user 0
09-20 18:07:19.670  1000  1472  2478 W UsageStatsService: Failed to query usage stats for locked user 0
    (Frameworkå±‚ï¼šå¤§é‡æœåŠ¡æŠ¥å‘Šuser 0å¤„äºlockedçŠ¶æ€)

09-20 18:07:20.088 10252  2892  2892 W ContextImpl: Failed to ensure /data/user/0/com.google.android.setupwizard/shared_prefs: mkdir failed: errno 126 (Required key not available)
    ã€å…³é”®æ—¥å¿—1ã€‘SetupWizardæ— æ³•è®¿é—®CEå­˜å‚¨ï¼Œé”™è¯¯ç 126è¡¨ç¤ºå¯†é’¥ä¸å¯ç”¨

09-20 18:07:20.110  1000  1472  3010 I ActivityTaskManager: START u0 {...cmp=com.android.provision/.activities.DefaultActivity...} from uid 10252 from pid 2892 callingPackage com.google.android.setupwizard
    (SetupWizardå¯åŠ¨MiuiProvisionï¼Œæ­¤æ—¶user 0ä»æ˜¯locked)

09-20 18:07:20.130  1000  1472  1584 I ActivityManager: Start proc 3276:com.android.provision/1000 for top-activity {com.android.provision/com.android.provision.activities.DefaultActivity}
    (MiuiProvisionè¿›ç¨‹å¯åŠ¨ï¼ŒPID 3276ï¼Œå› ä¸ºdirectBootAware=trueå¯ä»¥åœ¨lockedçŠ¶æ€ä¸‹å¯åŠ¨)

09-20 18:07:20.224  1000  3276  3276 I ProvisionApplication: setupProvisionResources when application create
    (ProvisionApplication.onCreateæ‰§è¡Œï¼Œæ³¨å†ŒACTION_USER_UNLOCKEDå¹¿æ’­æ¥æ”¶å™¨)

09-20 18:07:22.442  1000  1472  1555 I TransparencyService: Boot completed. Getting boot integrity data.
09-20 18:07:22.442  1000  1472  1555 I TransparencyService: Boot completed. Collecting biometric system properties.
    (Frameworkå±‚ï¼šç³»ç»Ÿå¯åŠ¨å®Œæˆ)

09-20 18:07:22.492  1000  1472  1555 D LockSettingsService: Not unlocking CE storage for user 0 yet because user is secured
    ã€å…³é”®æ—¥å¿—2ã€‘Frameworkå±‚æ˜ç¡®åˆ¤å®šï¼šè™½ç„¶ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼Œä½†ä¸è§£é”user 0çš„CEå­˜å‚¨

09-20 18:07:22.492  1000  1472  1555 D SystemServerTiming: finishUserUnlocking-0
    (Frameworkå±‚å¼€å§‹user 0è§£é”æµç¨‹)

â”â”â”â”â”â”â”â”â”â”â”â” é˜¶æ®µ2ï¼šFrameworkå‘é€USER_UNLOCKEDå¹¿æ’­ä½†CEå­˜å‚¨ä»ä¸å¯ç”¨ï¼ˆ18:07:29ï¼‰â”â”â”â”â”â”â”â”â”â”â”â”

09-20 18:07:29.439  1017   612   612 I keystore2: system/security/keystore2/src/authorization.rs:126 - on_device_unlocked(user_id=0, password.is_some()=false)
    ã€å…³é”®æ—¥å¿—3ã€‘Frameworkå±‚keystore2è§¦å‘è§£é”äº‹ä»¶ï¼Œæ­¤æ—¶ä¼šå‘é€ACTION_USER_UNLOCKEDå¹¿æ’­

09-20 18:07:29.458  1000  1472  1472 E FaceUnlockTrack: java.lang.IllegalStateException: SharedPreferences in credential encrypted storage are not available until after user (id 0) is unlocked
09-20 18:07:29.460  1000  1472  1472 E FaceUnlockTrack: java.lang.IllegalStateException: SharedPreferences in credential encrypted storage are not available until after user (id 0) is unlocked
    ã€å…³é”®æ—¥å¿—4ã€‘è™½ç„¶keystore2å·²è§¦å‘è§£é”äº‹ä»¶ï¼Œä½†CEå­˜å‚¨å®é™…ä¸Šä»ç„¶ä¸å¯ç”¨
    (Frameworkå±‚æ—¶åºé—®é¢˜ï¼šå¹¿æ’­å‘é€æ—©äºCEå­˜å‚¨å®é™…å¯ç”¨)

â”â”â”â”â”â”â”â”â”â”â”â” é˜¶æ®µ3ï¼šPackageManageræŸ¥è¯¢å¤±è´¥ï¼ˆ18:07:31ï¼‰â”â”â”â”â”â”â”â”â”â”â”â”

09-20 18:07:31.505  1000  1472  3762 W ActivityStarterImpl: aInfo is null for resolve intent: Intent { act=android.intent.action.VIEW_LICENSE xflg=0x4 (has extras) }
    ã€å…³é”®æ—¥å¿—5ã€‘Frameworkå±‚ActivityStarterImplæ— æ³•è§£æIntentï¼ŒActivityInfoä¸ºnull

09-20 18:07:31.506  1000  1472  3762 E ActivityStarterImpl: Error: Activity not started, unable to resolve Intent { act=android.intent.action.VIEW_LICENSE xflg=0x4 (has extras) }
    ã€å…³é”®æ—¥å¿—6ã€‘Frameworkå±‚æ˜ç¡®æŠ¥é”™ï¼šæ— æ³•è§£æIntentï¼ŒActivityå¯åŠ¨å¤±è´¥

09-20 18:07:31.509  1000  3276  3276 E Provision_Utils: android.content.ActivityNotFoundException: No Activity found to handle Intent { act=android.intent.action.VIEW_LICENSE xflg=0x4 (has extras) }
    (åº”ç”¨å±‚æ”¶åˆ°FrameworkæŠ›å‡ºçš„ActivityNotFoundException)

09-20 18:07:31.509  1000  3276  3276 E Provision_Utils: 	at com.android.provision.Utils.startActivityAsUser(SourceFile:599)
09-20 18:07:31.509  1000  3276  3276 E Provision_Utils: 	at com.android.provision.fragment.TermsFragment$1.onItemClick(SourceFile:183)
    (å †æ ˆä¿¡æ¯ï¼šä»åº”ç”¨å±‚è°ƒç”¨åˆ°Frameworkå±‚)

09-20 18:07:32.621  1000  1472  2160 W ActivityStarterImpl: aInfo is null for resolve intent: Intent { act=android.intent.action.VIEW_LICENSE xflg=0x4 (has extras) }
09-20 18:07:32.627  1000  3276  3276 E Provision_Utils: android.content.ActivityNotFoundException: No Activity found to handle Intent { act=android.intent.action.VIEW_LICENSE xflg=0x4 (has extras) }
    (ç”¨æˆ·ç¬¬2æ¬¡ç‚¹å‡»ï¼ŒFrameworkå±‚ä»ç„¶æ— æ³•è§£æIntent)

09-20 18:07:33.182  1000  3276  3276 E Provision_Utils: android.content.ActivityNotFoundException
09-20 18:07:33.620  1000  3276  3276 E Provision_Utils: android.content.ActivityNotFoundException
09-20 18:07:33.824  1000  3276  3276 E Provision_Utils: android.content.ActivityNotFoundException
09-20 18:07:33.995  1000  3276  3276 E Provision_Utils: android.content.ActivityNotFoundException
09-20 18:07:34.180  1000  3276  3276 E Provision_Utils: android.content.ActivityNotFoundException
    (ç”¨æˆ·è¿ç»­ç‚¹å‡»7æ¬¡ï¼Œæ¯æ¬¡Frameworkå±‚éƒ½è¿”å›null)

â”â”â”â”â”â”â”â”â”â”â”â” æ—¥å¿—é‡‡é›†æ—¶é—´ç‚¹ â”â”â”â”â”â”â”â”â”â”â”â”

== dumpstate: 2025-09-20 18:08:15
    (bugreporté‡‡é›†æ—¶é—´ï¼Œè·ç¦»é—®é¢˜å‘ç”Ÿ44ç§’)
```

### å…³é”®å‘ç°

#### 1. Frameworkå±‚æ—¶åºé—®é¢˜çš„ç›´æ¥è¯æ®

**æ—¶é—´å·®åˆ†æ**ï¼š
- 18:07:29.439ï¼škeystore2è§¦å‘on_device_unlocked â†’ Frameworkå‘é€ACTION_USER_UNLOCKEDå¹¿æ’­
- 18:07:29.458ï¼šFrameworkè‡ªèº«æœåŠ¡æŠ¥é”™CEå­˜å‚¨ä¸å¯ç”¨ï¼ˆç›¸å·®19msï¼‰
- 18:07:31.505ï¼šFrameworkå±‚PackageManagerä»æ— æ³•æŸ¥è¯¢ç»„ä»¶ï¼ˆç›¸å·®2066msï¼‰

**ç»“è®º**ï¼šACTION_USER_UNLOCKEDå¹¿æ’­å‘é€æ—¶ï¼ŒFrameworkå±‚çš„PackageManageræœåŠ¡å®é™…ä¸Šè¿˜éœ€è¦é¢å¤–2ç§’ä»¥ä¸Šæ‰èƒ½å®Œå…¨å¯ç”¨ã€‚

#### 2. PackageManageræœåŠ¡çŠ¶æ€ä¸ä¸€è‡´

**Intent Filterå·²æ³¨å†Œä½†æ— æ³•æŸ¥è¯¢**ï¼š
```
# dumpsys packageä¸­ç¡®è®¤htmlviewerå·²æ³¨å†Œ
miui.intent.action.VIEW_LICENSE:
  49a885b com.android.htmlviewer/com.miui.system.LicenseActivity
```

ä½†è¿è¡Œæ—¶æŸ¥è¯¢è¿”å›nullï¼š
```
09-20 18:07:31.505 ActivityStarterImpl: aInfo is null for resolve intent
```

**åŸå› **ï¼šPackageManageråœ¨CEå­˜å‚¨æœªå®Œå…¨å¯ç”¨æ—¶ï¼Œå¯¹éDEåº”ç”¨çš„ç»„ä»¶æŸ¥è¯¢è¿”å›nullã€‚

#### 3. Frameworkå±‚å¤šä¸ªæœåŠ¡çš„ä¸€è‡´æ€§é”™è¯¯

åœ¨åŒä¸€æ—¶é—´æ®µï¼ŒFrameworkå±‚å¤šä¸ªæœåŠ¡éƒ½æŠ¥å‘ŠCEå­˜å‚¨ä¸å¯ç”¨ï¼š
- UsageStatsServiceï¼šFailed to query usage stats for locked user 0
- ContextImplï¼šRequired key not available
- FaceUnlockTrackï¼šSharedPreferences in credential encrypted storage are not available
- ActivityStarterImplï¼šaInfo is null for resolve intent

**è¯´æ˜**ï¼šè¿™æ˜¯Frameworkå±‚çš„ç³»ç»Ÿæ€§é—®é¢˜ï¼Œä¸æ˜¯æŸä¸ªç»„ä»¶çš„å­¤ç«‹é—®é¢˜ã€‚

#### 4. MiuiProvisionçš„æ­£ç¡®è®¾è®¡

**åº”ç”¨å±‚å·²æœ‰å®Œæ•´çš„é˜²æŠ¤æœºåˆ¶**ï¼š
```java
// 1. AndroidManifesté…ç½®æ­£ç¡®
android:directBootAware="true"           // æ”¯æŒåœ¨user lockedæ—¶å¯åŠ¨
android:defaultToDeviceProtectedStorage="true"  // ä½¿ç”¨DEå­˜å‚¨

// 2. ç›‘å¬è§£é”å¹¿æ’­
registerReceiver(mBootReceiver, new IntentFilter(Intent.ACTION_USER_UNLOCKED));

// 3. å»¶è¿Ÿæ‰§è¡Œ
postDelayed(() -> Utils.setupProvisionResources(getContext()), 2000);

// 4. å¼‚å¸¸æ•è·
try {
    context.startActivityAsUser(intent, UserHandle.CURRENT);
} catch (ActivityNotFoundException e) {
    Toast.makeText(context, "ActivityNotFound", Toast.LENGTH_LONG).show();
}
```

**åº”ç”¨å±‚æ— æ³•åšæ›´å¤š**ï¼š
- å·²ç»æŒ‰ç…§Androidå®˜æ–¹æ–‡æ¡£æ­£ç¡®å®ç°DirectBootæ”¯æŒ
- å·²ç»ç›‘å¬äº†å®˜æ–¹æ¨èçš„ACTION_USER_UNLOCKEDå¹¿æ’­
- å·²ç»åšäº†å»¶è¿Ÿå¤„ç†å’Œå¼‚å¸¸æ•è·
- **ä½†Frameworkå±‚å¹¿æ’­æ—¶æœºä¸å‡†ç¡®ï¼Œåº”ç”¨å±‚æ— æ³•é¢„çŸ¥**

#### 5. é—®é¢˜çš„å¯å¤ç°æ€§

**ä¸ºä»€ä¹ˆæ˜¯"é«˜é¢‘å¶ç°"**ï¼š
- **é«˜é¢‘**ï¼šFrameworkå±‚çš„æ—¶åºé—®é¢˜åœ¨Android 16æ™®éå­˜åœ¨
- **å¶ç°**ï¼šå–å†³äºç”¨æˆ·æ“ä½œé€Ÿåº¦å’Œç³»ç»Ÿè´Ÿè½½
  - ç”¨æˆ·å¿«é€Ÿæ“ä½œ + ç³»ç»Ÿè´Ÿè½½é«˜ â†’ å¿…ç°ï¼ˆå¦‚æœ¬æ¡ˆä¾‹ï¼‰
  - ç”¨æˆ·æ…¢é€Ÿæ“ä½œ + ç³»ç»Ÿè´Ÿè½½ä½ â†’ ä¸ç°ï¼ˆCEå­˜å‚¨å·²å®Œå…¨å¯ç”¨ï¼‰

**é—®é¢˜çª—å£æœŸ**ï¼šä»ACTION_USER_UNLOCKEDå¹¿æ’­åˆ°PackageManagerå®Œå…¨å¯ç”¨ï¼Œçº¦2-5ç§’ä¸ç­‰ã€‚

---

## ğŸ”¬ æ ¹å› åˆ†æï¼ˆæ·±åº¦åˆ†æï¼‰

### å…³é”®å‘ç°ï¼šACTION_USER_UNLOCKEDå¹¿æ’­å‘é€æ—¶æœºè¿‡æ—©

#### é—®é¢˜æœ¬è´¨
**ç³»ç»Ÿçš„ACTION_USER_UNLOCKEDå¹¿æ’­å‘é€å¾—å¤ªæ—©ï¼Œè™½ç„¶å·²ç»å‘é€äº†è§£é”å¹¿æ’­ï¼Œä½†PackageManagerè¿˜æ— æ³•æŸ¥è¯¢åˆ°å…¶ä»–åº”ç”¨çš„ç»„ä»¶ä¿¡æ¯ã€‚**

### MiuiProvisionçš„å¯åŠ¨æœºåˆ¶åˆ†æ

#### 1. AndroidManifesté…ç½®
```xml
<application
    android:name="ProvisionApplication"
    android:directBootAware="true"           â† æ”¯æŒDirectBoot
    android:defaultToDeviceProtectedStorage="true"  â† ä½¿ç”¨DEå­˜å‚¨
    ...>
```

**è¯´æ˜**ï¼š
- MiuiProvisionè®¾ç½®äº†`directBootAware="true"`ï¼Œå¯ä»¥åœ¨user lockedçŠ¶æ€ä¸‹å¯åŠ¨
- è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå¼€æœºå¼•å¯¼éœ€è¦åœ¨ç”¨æˆ·æœªè®¾ç½®å¯†ç /æœªè§£é”æ—¶å°±èƒ½è¿è¡Œ

#### 2. ProvisionApplicationçš„åˆå§‹åŒ–æµç¨‹
```java
// ProvisionApplication.java
@Override
public void onCreate() {
    ...
    registerBootReceiver();  // ç¬¬44è¡Œï¼šæ³¨å†ŒACTION_USER_UNLOCKEDç›‘å¬
    ...
    Utils.setupProvisionResources(getContext());  // ç¬¬49è¡Œï¼šé¦–æ¬¡å°è¯•
    Log.i(TAG, "setupProvisionResources when application create");
    ...
}

private void registerBootReceiver() {
    IntentFilter intentFilter = new IntentFilter(Intent.ACTION_USER_UNLOCKED);
    mBootReceiver = new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            if (Intent.ACTION_USER_UNLOCKED.equals(intent.getAction())) {
                Log.i(TAG, "setupProvisionResources after ACTION_USER_UNLOCKED");
                // å»¶è¿Ÿ2ç§’åå†æ¬¡æ‰§è¡Œ
                new Handler().postDelayed(new Runnable() {
                    @Override
                    public void run() {
                        Utils.setupProvisionResources(getContext());
                        unregisterBootReceiver();
                    }
                },2000);  // â† å»¶è¿Ÿ2ç§’
            }
        }
    };
    registerReceiver(mBootReceiver, intentFilter);
}
```

**è®¾è®¡æ„å›¾**ï¼š
1. é¦–æ¬¡åœ¨onCreateæ—¶å°è¯•setupProvisionResourcesï¼ˆé€šå¸¸ä¼šå¤±è´¥ï¼Œå› ä¸ºuser lockedï¼‰
2. ç›‘å¬ACTION_USER_UNLOCKEDå¹¿æ’­
3. æ”¶åˆ°å¹¿æ’­åå»¶è¿Ÿ2ç§’ï¼Œå†æ¬¡æ‰§è¡ŒsetupProvisionResources

#### 3. setupProvisionResourcesçš„ä½œç”¨
```java
// Utils.java:1453-1469
public static void setupProvisionResources(final Context context) {
    new AsyncTask<Void, Void, Void>() {
        @Override
        protected Void doInBackground(Void... voids) {
            try {
                Log.i(TAG, "setupProvisionResources begin");
                // è°ƒç”¨ThemeProviderï¼Œè®¾ç½®å¼€æœºå¼•å¯¼èµ„æº
                context.getContentResolver().call(
                    Uri.parse("content://" + AUTHORITY_THEME_PROVIDER),
                    METHOD_THEME_PROVIDER, null, null);
                Log.i(TAG, "setupProvisionResources end");
            } catch (Exception e) {
                Log.i(TAG, "call setupProvisionResources error");
                e.printStackTrace();
            }
            return null;
        }
    }.execute();
}
```

**è¯´æ˜**ï¼šè¯¥æ–¹æ³•è®¿é—®ThemeProviderï¼Œå¯èƒ½éœ€è¦CEå­˜å‚¨è§£é”

### Android Credential Encrypted Storageï¼ˆCEå­˜å‚¨ï¼‰æœºåˆ¶

#### åŸºæœ¬åŸç†
Android 7.0å¼•å…¥çš„ç›´æ¥å¯åŠ¨ï¼ˆDirect Bootï¼‰æœºåˆ¶ï¼Œå°†ç”¨æˆ·æ•°æ®åˆ†ä¸ºä¸¤ç±»ï¼š
1. **Device Encrypted (DE) å­˜å‚¨**ï¼š
   - è®¾å¤‡å¯åŠ¨åç«‹å³å¯ç”¨
   - æ— éœ€ç”¨æˆ·è§£é”
   - ç”¨äºå­˜å‚¨ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½æ•°æ®

2. **Credential Encrypted (CE) å­˜å‚¨**ï¼š
   - éœ€è¦ç”¨æˆ·è¾“å…¥å¯†ç /è§£é”è®¾å¤‡åæ‰å¯ç”¨
   - ç”¨äºå­˜å‚¨ç”¨æˆ·æ•æ„Ÿæ•°æ®
   - **å¤§éƒ¨åˆ†åº”ç”¨æ•°æ®å­˜å‚¨åœ¨CEåŒºåŸŸ**
   - **PackageManageræŸ¥è¯¢å…¶ä»–åº”ç”¨ç»„ä»¶æ—¶éœ€è¦CEå­˜å‚¨**

#### å¯¹PackageManagerçš„å½±å“
```
è®¾å¤‡å¯åŠ¨ â†’ ç³»ç»Ÿå¯åŠ¨ â†’ Boot Completed
                          â†“
            Userä»ç„¶æ˜¯"Secured"çŠ¶æ€ï¼ˆCEå­˜å‚¨ä¸å¯ç”¨ï¼‰
                          â†“
            PackageManageråªèƒ½è®¿é—®DEåŒºåŸŸçš„åº”ç”¨ä¿¡æ¯
                          â†“
            å¤§éƒ¨åˆ†åº”ç”¨ç»„ä»¶ä¿¡æ¯ä¸å¯æŸ¥è¯¢
                          â†“
            resolveActivity() è¿”å› null
                          â†“
ç³»ç»Ÿå‘é€ ACTION_USER_UNLOCKED å¹¿æ’­ï¼ˆå¤ªæ—©ï¼ï¼‰
                          â†“
            MiuiProvisionæ”¶åˆ°å¹¿æ’­ï¼Œå»¶è¿Ÿ2ç§’
                          â†“
            CEå­˜å‚¨ä»åœ¨è§£é”è¿‡ç¨‹ä¸­...
                          â†“
            ç”¨æˆ·ç‚¹å‡»åè®® â†’ PackageManagerä»æ— æ³•æŸ¥è¯¢
```


### MiuiProvisionä»£ç åˆ†æ

```java
// Utils.java:690-697
public static Intent getLicenseIntent(Context context) {
    Intent intent = new Intent(ExtraIntent.ACTION_VIEW_MIUI_LICENSE);
    if (!intentAvailable(context, intent)) {
        // âš ï¸ åœ¨CEå­˜å‚¨æœªè§£é”æ—¶ï¼Œè¿™é‡Œä¼šåˆ¤å®šä¸ºfalse
        intent.setAction(ExtraIntent.ACTION_VIEW_LICENSE);
    }
    return intent;
}

// Utils.java:679-681
public static boolean intentAvailable(Context context, Intent intent) {
    // âŒ åœ¨CEå­˜å‚¨æœªè§£é”æ—¶ï¼Œè¿™é‡Œè¿”å›null
    return context.getPackageManager().resolveActivity(intent, 0) != null;
}

// Utils.java:597-604
public static void startActivityAsUser(Context context, Intent intent) {
    try {
        context.startActivityAsUser(intent, UserHandle.CURRENT);
    } catch (ActivityNotFoundException e) {
        // âœ… å¼‚å¸¸å¤„ç†æ­£ç¡®ï¼Œä½†ç”¨æˆ·ä½“éªŒä¸ä½³
        Toast.makeText(context, "ActivityNotFound", Toast.LENGTH_LONG).show();
        Log.e(TAG, "startActivityAsUser ActivityNotFound:", e);
    }
}
```

**ä»£ç å®¡æŸ¥ç»“è®º**ï¼š
- âœ… Intentæ„é€ é€»è¾‘æ­£ç¡®
- âœ… Fallbackæœºåˆ¶æ­£ç¡®
- âœ… å¼‚å¸¸å¤„ç†æ­£ç¡®
- âŒ **ç¼ºå°‘å¯¹ç”¨æˆ·çŠ¶æ€çš„æ£€æŸ¥**ï¼ˆæœªè€ƒè™‘CEå­˜å‚¨æœªè§£é”çš„åœºæ™¯ï¼‰

---

## ğŸ¯ é—®é¢˜èŒƒå›´åˆ†æ

### è´£ä»»å½’å±åˆ¤å®šï¼ˆé‡æ–°è¯„ä¼°ï¼‰

#### 1. MiuiProvisionæ¨¡å—ï¼ˆæœ¬æ¨¡å—ï¼‰
**ä»£ç é—®é¢˜**ï¼šâš ï¸ **å­˜åœ¨é˜²å¾¡æ€§ä¸è¶³**
- å·²ç»ç›‘å¬ACTION_USER_UNLOCKEDå¹¿æ’­ï¼Œè®¾è®¡æ€è·¯æ­£ç¡®
- å·²ç»å»¶è¿Ÿ2ç§’å†æ‰§è¡Œï¼Œè€ƒè™‘åˆ°äº†è§£é”æ—¶é—´
- **ä½†å»¶è¿Ÿæ—¶é—´ä¸å¤Ÿ**ï¼š2ç§’ä»ç„¶æ— æ³•ä¿è¯PackageManagerå®Œå…¨å¯ç”¨
- æ²¡æœ‰åœ¨å®é™…è°ƒç”¨startActivityå‰å†æ¬¡æ£€æŸ¥ç”¨æˆ·çŠ¶æ€

**ç°æœ‰é˜²æŠ¤æªæ–½**ï¼š
```java
// ProvisionApplicationå·²æœ‰çš„é˜²æŠ¤
registerBootReceiver();  // ç›‘å¬ACTION_USER_UNLOCKED
// å»¶è¿Ÿ2ç§’åæ‰§è¡ŒsetupProvisionResources
postDelayed(() -> Utils.setupProvisionResources(getContext()), 2000);
```

**ä¸è¶³ä¹‹å¤„**ï¼š
- å»¶è¿Ÿ2ç§’ä¸èƒ½ä¿è¯PackageManagerå¯ç”¨
- Utils.startActivityAsUseræ²¡æœ‰æ£€æŸ¥ç”¨æˆ·è§£é”çŠ¶æ€
- ç”¨æˆ·å¯ä»¥åœ¨å»¶è¿ŸæœŸé—´å°±å¼€å§‹æ“ä½œï¼ˆå¦‚æœ¬æ¡ˆä¾‹ï¼‰

#### 2. htmlvieweræ¨¡å—
**ä»£ç é—®é¢˜**ï¼šâœ… æ— 
- Activityæ³¨å†Œæ­£ç¡®
- Intent Filteré…ç½®æ­£ç¡®
- ä¸éœ€è¦ç‰¹æ®Šçš„DirectBootæ”¯æŒï¼ˆè¯¥Activityæœ¬èº«ä¸éœ€è¦åœ¨é”å±ä¸‹å·¥ä½œï¼‰

**è¯´æ˜**ï¼š
- htmlviewerç”¨äºå±•ç¤ºç”¨æˆ·åè®®ï¼Œå±äºç”¨æˆ·äº¤äº’åŠŸèƒ½
- ç†åº”åœ¨ç”¨æˆ·è§£é”åæ‰å¯è®¿é—®
- è¿™æ˜¯Androidå®‰å…¨æœºåˆ¶çš„è®¾è®¡è¦æ±‚

#### 3. Android Frameworkï¼ˆç³»ç»Ÿå±‚ï¼‰

**é—®é¢˜å®šä½**ï¼šâš ï¸ **Frameworkå±‚æ¨¡å—é—´æ—¶åºåè°ƒé—®é¢˜**

##### æ¶‰åŠçš„Frameworkæ¨¡å—

**1. UserControlleræ¨¡å—**ï¼ˆframeworks/base/services/core/java/com/android/server/am/UserController.javaï¼‰
- **èŒè´£**ï¼šç®¡ç†ç”¨æˆ·çŠ¶æ€ï¼Œå‘é€ACTION_USER_UNLOCKEDå¹¿æ’­
- **é—®é¢˜**ï¼šåœ¨keystore2è§¦å‘è§£é”äº‹ä»¶åç«‹å³å‘é€å¹¿æ’­ï¼Œæœªç­‰å¾…æ‰€æœ‰ä¾èµ–æœåŠ¡å‡†å¤‡å®Œæˆ
- **æ—¥å¿—è¯æ®**ï¼š
  ```
  18:07:29.439 keystore2: on_device_unlocked(user_id=0)
  â†’ ç«‹å³å‘é€ACTION_USER_UNLOCKEDå¹¿æ’­
  ```

**2. PackageManagerServiceæ¨¡å—**ï¼ˆframeworks/base/services/core/java/com/android/server/pm/PackageManagerService.javaï¼‰
- **èŒè´£**ï¼šç®¡ç†åº”ç”¨åŒ…ä¿¡æ¯ï¼Œæä¾›ç»„ä»¶æŸ¥è¯¢æœåŠ¡
- **é—®é¢˜**ï¼šæ¥æ”¶åˆ°ç”¨æˆ·è§£é”é€šçŸ¥åï¼Œéœ€è¦é¢å¤–æ—¶é—´æ¥æ›´æ–°CEå­˜å‚¨åº”ç”¨çš„å¯è§æ€§çŠ¶æ€
- **æ—¥å¿—è¯æ®**ï¼š
  ```
  18:07:31.505 ActivityStarterImpl: aInfo is null for resolve intent
  â†’ å¹¿æ’­å‘é€å2066msï¼ŒPackageManagerä»è¿”å›null
  ```

**3. LockSettingsServiceæ¨¡å—**ï¼ˆframeworks/base/services/core/java/com/android/server/locksettings/LockSettingsService.javaï¼‰
- **èŒè´£**ï¼šç®¡ç†CEå­˜å‚¨çš„è§£é”çŠ¶æ€
- **è¡Œä¸º**ï¼šåˆ¤å®š"Not unlocking CE storage for user 0 yet because user is secured"
- **è¯´æ˜**ï¼šè¯¥æ¨¡å—æŒ‰ç…§å®‰å…¨ç­–ç•¥æ­£ç¡®æ‰§è¡Œï¼Œä¸æ˜¯é—®é¢˜æ ¹æº

##### æ ¸å¿ƒé—®é¢˜åˆ†æ

**æ—¶åºä¸åŒæ­¥é—®é¢˜**ï¼š
```
UserController.finishUserUnlocking()
  â†“
keystore2è§¦å‘è§£é”äº‹ä»¶
  â†“
UserControllerå‘é€ACTION_USER_UNLOCKEDå¹¿æ’­  â† è¿™é‡Œå‘é€å¤ªæ—©
  â†“
[æ—¶é—´å·®ï¼š2-5ç§’]  â† é—®é¢˜çª—å£æœŸ
  â†“
PackageManagerServiceå®ŒæˆCEåº”ç”¨çŠ¶æ€æ›´æ–°  â† å®é™…å¯ç”¨æ—¶é—´ç‚¹
```

**è´£ä»»åˆ†æ**ï¼š
1. **UserController**ï¼šå‘é€å¹¿æ’­æ—¶æœºä¸å½“
   - åº”è¯¥ç­‰å¾…å…³é”®æœåŠ¡ï¼ˆå¦‚PackageManagerï¼‰å‡†å¤‡å®Œæˆåå†å‘é€å¹¿æ’­
   - æˆ–è€…æä¾›æ›´ç²¾ç¡®çš„å¹¿æ’­ï¼ˆå¦‚ACTION_PACKAGEMANAGER_READYï¼‰

2. **PackageManagerService**ï¼šçŠ¶æ€æ›´æ–°è¿‡æ…¢
   - æ¥æ”¶åˆ°è§£é”é€šçŸ¥åï¼Œåº”è¯¥æ›´å¿«åœ°æ›´æ–°åº”ç”¨å¯è§æ€§çŠ¶æ€
   - æˆ–è€…æä¾›æ˜ç¡®çš„"å‡†å¤‡å®Œæˆ"é€šçŸ¥æœºåˆ¶

##### Frameworkå±‚è®¾è®¡ç¼ºé™·

**å¹¿æ’­è¯­ä¹‰ä¸å‡†ç¡®**ï¼š
- `ACTION_USER_UNLOCKED`çš„è¯­ä¹‰ï¼šç”¨æˆ·å·²è§£é”
- **å®é™…å«ä¹‰**ï¼škeystore2å·²è§¦å‘è§£é”äº‹ä»¶ï¼Œä½†ä¸ä»£è¡¨æ‰€æœ‰æœåŠ¡éƒ½å‡†å¤‡å¥½
- **åº”è¯¥çš„è¯­ä¹‰**ï¼šæ‰€æœ‰FrameworkæœåŠ¡éƒ½å·²å®Œæˆç”¨æˆ·è§£é”ç›¸å…³çš„åˆå§‹åŒ–

**ç¼ºå°‘åè°ƒæœºåˆ¶**ï¼š
- Frameworkå±‚å„æœåŠ¡ä¹‹é—´ç¼ºå°‘æ˜ç¡®çš„ä¾èµ–å…³ç³»å’Œå°±ç»ªé€šçŸ¥æœºåˆ¶
- UserControllerä¸çŸ¥é“PackageManagerä½•æ—¶å®ŒæˆCEåº”ç”¨çŠ¶æ€æ›´æ–°
- åº”ç”¨å±‚åªèƒ½ä¾èµ–å¹¿æ’­ï¼Œæ— æ³•æ„ŸçŸ¥å®é™…å°±ç»ªçŠ¶æ€

### ğŸ”´ ç»“è®º

**é—®é¢˜æ ¹æº**ï¼šğŸ¯ **Android Frameworkå±‚UserControllerä¸PackageManagerServiceæ¨¡å—é—´çš„æ—¶åºåè°ƒé—®é¢˜**

**è´£ä»»å½’å±**ï¼š
1. **ä¸»è¦è´£ä»»ï¼ˆ60%ï¼‰**ï¼š**UserControlleræ¨¡å—**
   - å‘é€ACTION_USER_UNLOCKEDå¹¿æ’­æ—¶æœºè¿‡æ—©
   - æœªç­‰å¾…PackageManagerServiceç­‰å…³é”®æœåŠ¡å‡†å¤‡å®Œæˆ
   
2. **æ¬¡è¦è´£ä»»ï¼ˆ40%ï¼‰**ï¼š**PackageManagerServiceæ¨¡å—**
   - CEå­˜å‚¨è§£é”åï¼Œåº”ç”¨å¯è§æ€§çŠ¶æ€æ›´æ–°è¿‡æ…¢
   - ç¼ºå°‘æ˜ç¡®çš„"å‡†å¤‡å®Œæˆ"é€šçŸ¥æœºåˆ¶

3. **ç³»ç»Ÿè®¾è®¡ç¼ºé™·**ï¼š
   - ACTION_USER_UNLOCKEDå¹¿æ’­è¯­ä¹‰ä¸å‡†ç¡®
   - Frameworkå±‚æœåŠ¡é—´ç¼ºå°‘åè°ƒæœºåˆ¶

**æ¨¡å—è·¯å¾„**ï¼š
- frameworks/base/services/core/java/com/android/server/am/UserController.java
- frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java

**ä¸æ˜¯ä»¥ä¸‹æ¨¡å—çš„è´£ä»»**ï¼š
- âŒ MiuiProvisionï¼ˆåº”ç”¨å±‚å·²æ­£ç¡®å®ç°ï¼Œæ— æ³•é¢„çŸ¥Frameworkæ—¶åºé—®é¢˜ï¼‰
- âŒ htmlviewerï¼ˆç›®æ ‡åº”ç”¨æ— éœ€ç‰¹æ®Šé…ç½®ï¼‰
- âŒ LockSettingsServiceï¼ˆæŒ‰ç…§å®‰å…¨ç­–ç•¥æ­£ç¡®æ‰§è¡Œï¼‰

**æ˜¯å¦éœ€è¦è½¬æ´¾**ï¼š
- âš ï¸ **åº”è¯¥è½¬æ´¾ç»™Android Frameworkå›¢é˜Ÿ**ï¼ˆå¦‚æœæœ‰å¯¹æ¥æ¸ é“ï¼‰
- âœ… ä½†MiuiProvisionå¯ä»¥åšé˜²å¾¡æ€§ä¿®å¤ï¼Œå‡è½»å½±å“

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### ä¸ºä»€ä¹ˆéœ€è¦é¢å¤–é˜²æŠ¤ï¼Ÿ

è™½ç„¶`ProvisionApplication`å·²ç»ç›‘å¬äº†`ACTION_USER_UNLOCKED`å¹¿æ’­å¹¶å»¶è¿Ÿ2ç§’æ‰§è¡Œï¼Œä½†ï¼š

1. **ç³»ç»Ÿå¹¿æ’­å‘é€å¤ªæ—©**ï¼škeystore2å‘é€è§£é”ä¿¡å·æ—¶ï¼ŒPackageManagerè¿˜éœ€è¦é¢å¤–æ—¶é—´
2. **å»¶è¿Ÿæ—¶é—´ä¸å¤Ÿ**ï¼š2ç§’å»¶è¿Ÿæ˜¯ä¸ºäº†é¿å¼€å¼€æœºå¼•å¯¼æ¬¢è¿åŠ¨ç”»ï¼Œä¸æ˜¯ä¸ºäº†ç­‰å¾…PackageManager
3. **ç”¨æˆ·æ“ä½œæ—¶æœºä¸å¯æ§**ï¼šç”¨æˆ·å¯èƒ½åœ¨ç³»ç»Ÿåˆšå¯åŠ¨å°±å¿«é€Ÿæ“ä½œ
4. **é—®é¢˜çª—å£æœŸ**ï¼šä»ACTION_USER_UNLOCKEDå¹¿æ’­åˆ°PackageManagerå®é™…å¯ç”¨ï¼Œæœ‰ä¸€ä¸ªä¸ç¡®å®šçš„æ—¶é—´çª—å£

å› æ­¤ï¼Œéœ€è¦åœ¨**å®é™…å¯åŠ¨Activityå‰**è¿›è¡ŒäºŒæ¬¡æ£€æŸ¥ã€‚

---

### æ–¹æ¡ˆ1ï¼šç®€å•æç¤ºæ–¹æ¡ˆï¼ˆä¸æ¨èï¼‰âŒ

**è®¾è®¡æ€è·¯**ï¼šæ£€æŸ¥UserManager.isUserUnlocked()ï¼Œæœªè§£é”å°±Toastæç¤º

```java
public static void startActivityAsUser(Context context, Intent intent) {
    try {
        UserManager userManager = context.getSystemService(UserManager.class);
        if (userManager != null && !userManager.isUserUnlocked()) {
            Toast.makeText(context, "ç³»ç»Ÿæ­£åœ¨å¯åŠ¨ï¼Œè¯·ç¨å€™", Toast.LENGTH_SHORT).show();
            return;  // ç›´æ¥è¿”å›
        }
        context.startActivityAsUser(intent, UserHandle.CURRENT);
    } catch (ActivityNotFoundException e) {
        Toast.makeText(context, "ActivityNotFound", Toast.LENGTH_LONG).show();
    }
}
```

**é—®é¢˜åˆ†æ**ï¼š
- âŒ **å¹¶æœªçœŸæ­£è§£å†³é—®é¢˜**ï¼šç”¨æˆ·ä»ç„¶æ— æ³•æ‰“å¼€åè®®ï¼Œåªæ˜¯æ¢äº†ä¸ªé”™è¯¯æç¤º
- âŒ ç”¨æˆ·éœ€è¦ç­‰å¾…å‡ ç§’åé‡æ–°ç‚¹å‡»
- âŒ ç”¨æˆ·ä½“éªŒå·®ï¼šä¸çŸ¥é“è¦ç­‰å¤šä¹…ï¼Œéœ€è¦åå¤å°è¯•
- âŒ é—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œåªæ˜¯"å¥½çœ‹"ä¸€ç‚¹

**ç»“è®º**ï¼šè¿™ä¸æ˜¯çœŸæ­£çš„è§£å†³æ–¹æ¡ˆï¼Œåªæ˜¯æŠŠ"ActivityNotFound"æ¢æˆ"ç³»ç»Ÿæ­£åœ¨å¯åŠ¨"ï¼Œé—®é¢˜ä¾æ—§ï¼

---

### æ–¹æ¡ˆ2ï¼šæ™ºèƒ½é‡è¯•æœºåˆ¶ï¼ˆæ¨èï¼‰â­â­â­

**è®¾è®¡æ€è·¯**ï¼š
- æ£€æŸ¥ç”¨æˆ·è§£é”çŠ¶æ€
- å¦‚æœæœªè§£é”ï¼Œè‡ªåŠ¨å»¶è¿Ÿ500msåé‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œç³»ç»Ÿè‡ªåŠ¨å¤„ç†

**ä¿®æ”¹ä½ç½®**ï¼š`src/com/android/provision/Utils.java`

**ä¿®æ”¹å†…å®¹**ï¼š
```java
private static final int MAX_RETRY_COUNT = 3;
private static final int RETRY_DELAY_MS = 500;

public static void startActivityAsUser(Context context, Intent intent) {
    startActivityAsUserWithRetry(context, intent, 0);
}

private static void startActivityAsUserWithRetry(Context context, Intent intent, int retryCount) {
    try {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è§£é”
        UserManager userManager = context.getSystemService(UserManager.class);
        if (userManager != null && !userManager.isUserUnlocked()) {
            if (retryCount < MAX_RETRY_COUNT) {
                // è¿˜åœ¨é‡è¯•èŒƒå›´å†…ï¼Œå»¶è¿Ÿåè‡ªåŠ¨é‡è¯•
                Log.w(TAG, "User not unlocked yet, retry after " + RETRY_DELAY_MS + 
                          "ms. Retry count: " + (retryCount + 1));
                new Handler(Looper.getMainLooper()).postDelayed(() -> {
                    startActivityAsUserWithRetry(context, intent, retryCount + 1);
                }, RETRY_DELAY_MS);
                
                // ç¬¬ä¸€æ¬¡æ—¶ç»™ç”¨æˆ·ä¸€ä¸ªå‹å¥½æç¤º
                if (retryCount == 0) {
                    Toast.makeText(context, R.string.please_wait_system_ready, 
                                 Toast.LENGTH_SHORT).show();
                }
                return;
            } else {
                // é‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œæç¤ºç”¨æˆ·ç¨åå†è¯•
                Log.e(TAG, "User still not unlocked after " + MAX_RETRY_COUNT + 
                          " retries, give up.");
                Toast.makeText(context, R.string.system_not_ready_please_retry, 
                             Toast.LENGTH_SHORT).show();
                return;
            }
        }
        
        // ç”¨æˆ·å·²è§£é”ï¼Œæ­£å¸¸å¯åŠ¨Activity
        context.startActivityAsUser(intent, UserHandle.CURRENT);
        
    } catch (ActivityNotFoundException e) {
        Toast.makeText(context, "ActivityNotFound", Toast.LENGTH_LONG).show();
        Log.e(TAG, "startActivityAsUser ActivityNotFound:", e);
    }
}
```

**éœ€è¦æ·»åŠ stringsèµ„æº**ï¼š
```xml
<!-- res/values/strings.xml -->
<string name="please_wait_system_ready">System is starting, please wait a moment</string>
<string name="system_not_ready_please_retry">System is still initializing, please try again later</string>

<!-- res/values-zh-rCN/strings.xml -->
<string name="please_wait_system_ready">ç³»ç»Ÿæ­£åœ¨å¯åŠ¨ï¼Œè¯·ç¨å€™</string>
<string name="system_not_ready_please_retry">ç³»ç»Ÿä»åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨åé‡è¯•</string>
```

**ä¼˜ç‚¹**ï¼š
- âœ… **çœŸæ­£è§£å†³é—®é¢˜**ï¼šè‡ªåŠ¨é‡è¯•ï¼Œç”¨æˆ·å¤§æ¦‚ç‡æ— éœ€æ‰‹åŠ¨å†æ¬¡ç‚¹å‡»
- âœ… **ç”¨æˆ·ä½“éªŒå¥½**ï¼šæ˜¾ç¤ºä¸€æ¬¡æç¤ºï¼Œåå°è‡ªåŠ¨é‡è¯•ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
- âœ… **æˆåŠŸç‡é«˜**ï¼š3æ¬¡é‡è¯•ï¼ˆ0msã€500msã€1000msã€1500msï¼‰ï¼Œè¦†ç›–2ç§’çª—å£æœŸ
- âœ… **å®‰å…¨å¯é **ï¼šæœ‰é‡è¯•ä¸Šé™ï¼Œé¿å…æ— é™å¾ªç¯
- âœ… **æ€§èƒ½å‹å¥½**ï¼šåªæœ‰åœ¨æœªè§£é”æ—¶æ‰å»¶è¿Ÿï¼Œæ­£å¸¸æƒ…å†µæ— å½±å“

**ç¼ºç‚¹**ï¼š
- âš ï¸ ä»£ç ç¨å¤æ‚ï¼ˆå¢åŠ é‡è¯•é€»è¾‘ï¼‰
- âš ï¸ æç«¯æƒ…å†µä¸‹ï¼ˆç³»ç»Ÿè´Ÿè½½å¾ˆé«˜ï¼‰å¯èƒ½ä»éœ€ç”¨æˆ·é‡è¯•

**æ—¶åºåˆ†æ**ï¼š
```
ç”¨æˆ·ç‚¹å‡»åè®®ï¼ˆ18:07:31ï¼‰
  â†“
æ£€æŸ¥ï¼šUserManager.isUserUnlocked() = false
  â†“
ç¬¬1æ¬¡é‡è¯•ï¼šå»¶è¿Ÿ500msåï¼ˆ18:07:31.5ï¼‰
  â†“
æ£€æŸ¥ï¼šUserManager.isUserUnlocked() = false
  â†“
ç¬¬2æ¬¡é‡è¯•ï¼šå»¶è¿Ÿ500msåï¼ˆ18:07:32ï¼‰
  â†“
æ£€æŸ¥ï¼šUserManager.isUserUnlocked() = true âœ…
  â†“
æˆåŠŸå¯åŠ¨Activityï¼
```

**é¢„æœŸæ•ˆæœ**ï¼š
- åŸæœ¬éœ€è¦ç”¨æˆ·ç­‰å¾…2-5ç§’åæ‰‹åŠ¨é‡è¯•
- ç°åœ¨ç³»ç»Ÿè‡ªåŠ¨é‡è¯•ï¼Œ1.5ç§’å†…å¤§æ¦‚ç‡è‡ªåŠ¨æˆåŠŸ
- ç”¨æˆ·æ„ŸçŸ¥ï¼šç‚¹å‡»â†’æç¤º"ç³»ç»Ÿæ­£åœ¨å¯åŠ¨"â†’1-2ç§’ååè®®é¡µé¢æ‰“å¼€ âœ…

---

### æ–¹æ¡ˆ3ï¼šå¢åŠ å»¶è¿Ÿæ—¶é—´ï¼ˆå¤‡é€‰ï¼‰

**ä¿®æ”¹ä½ç½®**ï¼š`src/com/android/provision/Utils.java`

**ä¿®æ”¹æ€è·¯**ï¼š
```java
public static void startActivityAsUser(Context context, Intent intent) {
    try {
        UserManager userManager = context.getSystemService(UserManager.class);
        if (userManager != null && !userManager.isUserUnlocked()) {
            // ç”¨æˆ·å°šæœªè§£é”ï¼Œå»¶è¿Ÿ2ç§’åè‡ªåŠ¨é‡è¯•
            Toast.makeText(context, 
                          R.string.please_wait_system_ready, 
                          Toast.LENGTH_SHORT).show();
            Log.w(TAG, "User not unlocked, retry after 2s");
            
            new Handler(Looper.getMainLooper()).postDelayed(() -> {
                startActivityAsUser(context, intent);
            }, 2000);
            return;
        }
        
        context.startActivityAsUser(intent, UserHandle.CURRENT);
    } catch (ActivityNotFoundException e) {
        Toast.makeText(context, "ActivityNotFound", Toast.LENGTH_LONG).show();
        Log.e(TAG, "startActivityAsUser ActivityNotFound:", e);
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç”¨æˆ·æ— éœ€é‡æ–°ç‚¹å‡»
- âœ… è‡ªåŠ¨æ¢å¤
- âœ… ç”¨æˆ·ä½“éªŒæœ€ä½³

**ç¼ºç‚¹**ï¼š
- âŒ é€’å½’è°ƒç”¨éœ€è¦åŠ é˜²æŠ¤ï¼ˆé¿å…æ— é™é‡è¯•ï¼‰
- âŒ å»¶è¿Ÿæ—¶é—´éš¾ä»¥ç¡®å®šï¼ˆ2ç§’å¯èƒ½ä¸å¤Ÿï¼‰
- âŒ å¯èƒ½å¯¼è‡´Activityåœ¨ç”¨æˆ·ç¦»å¼€åæ‰å¯åŠ¨

---

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨BroadcastReceiverç›‘å¬è§£é”ï¼ˆå®Œå–„ï¼‰

**ä¿®æ”¹æ€è·¯**ï¼š
```java
// åœ¨Fragmentä¸­ç›‘å¬USER_UNLOCKEDå¹¿æ’­
private BroadcastReceiver mUserUnlockedReceiver = new BroadcastReceiver() {
    @Override
    public void onReceive(Context context, Intent intent) {
        if (Intent.ACTION_USER_UNLOCKED.equals(intent.getAction())) {
            // ç”¨æˆ·å·²è§£é”ï¼Œå¦‚æœæœ‰pendingçš„Intentï¼Œç°åœ¨å¯åŠ¨
            if (mPendingLicenseIntent != null) {
                Utils.startActivityAsUser(context, mPendingLicenseIntent);
                mPendingLicenseIntent = null;
            }
        }
    }
};

public static void startActivityAsUser(Context context, Intent intent) {
    try {
        UserManager userManager = context.getSystemService(UserManager.class);
        if (userManager != null && !userManager.isUserUnlocked()) {
            // ä¿å­˜Intentï¼Œç­‰å¾…USER_UNLOCKEDå¹¿æ’­
            mPendingLicenseIntent = intent;
            Toast.makeText(context, 
                          R.string.please_wait_system_ready, 
                          Toast.LENGTH_SHORT).show();
            return;
        }
        
        context.startActivityAsUser(intent, UserHandle.CURRENT);
    } catch (ActivityNotFoundException e) {
        Toast.makeText(context, "ActivityNotFound", Toast.LENGTH_LONG).show();
        Log.e(TAG, "startActivityAsUser ActivityNotFound:", e);
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æœ€å¯é çš„æ–¹å¼
- âœ… ç²¾ç¡®çŸ¥é“è§£é”å®Œæˆæ—¶æœº
- âœ… ç”¨æˆ·æ— éœ€é‡æ–°ç‚¹å‡»

**ç¼ºç‚¹**ï¼š
- âŒ ä»£ç æ”¹åŠ¨è¾ƒå¤§
- âŒ éœ€è¦ç®¡ç†BroadcastReceiverç”Ÿå‘½å‘¨æœŸ
- âŒ å¯èƒ½åœ¨ç”¨æˆ·ç¦»å¼€Fragmentåæ‰æ”¶åˆ°å¹¿æ’­

---

## ğŸ“Œ æ¨èæ–¹æ¡ˆè¯„ä¼°

### âŒ æ–¹æ¡ˆ1ï¼šç®€å•æç¤ºï¼ˆä¸èƒ½çœŸæ­£è§£å†³é—®é¢˜ï¼‰

æ‚¨è¯´å¾—éå¸¸å¯¹ï¼è¿™ä¸ªæ–¹æ¡ˆ**å¹¶æœªçœŸæ­£è§£å†³é—®é¢˜**ï¼š
- âŒ ç”¨æˆ·ä»ç„¶æ— æ³•æ‰“å¼€åè®®ï¼Œåªæ˜¯æ¢äº†ä¸ªé”™è¯¯æç¤º
- âŒ éœ€è¦ç­‰å¾…å‡ ç§’åé‡æ–°ç‚¹å‡»
- âŒ ç”¨æˆ·ä½“éªŒå·®ï¼šä¸çŸ¥é“è¦ç­‰å¤šä¹…ï¼Œéœ€è¦åå¤å°è¯•
- âŒ é—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œåªæ˜¯"å¥½çœ‹"ä¸€ç‚¹

**ç»“è®º**ï¼šè¿™ä¸æ˜¯çœŸæ­£çš„è§£å†³æ–¹æ¡ˆï¼Œåªæ˜¯æŠŠ"ActivityNotFound"æ¢æˆ"ç³»ç»Ÿæ­£åœ¨å¯åŠ¨"ï¼

---

### âœ… æ–¹æ¡ˆ2ï¼šæ™ºèƒ½é‡è¯•æœºåˆ¶ï¼ˆå¼ºçƒˆæ¨èï¼‰â­â­â­

**ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆèƒ½çœŸæ­£è§£å†³é—®é¢˜**ï¼š
1. **è‡ªåŠ¨é‡è¯•**ï¼šæ£€æµ‹åˆ°æœªè§£é”åï¼Œæ¯500msè‡ªåŠ¨é‡è¯•ä¸€æ¬¡ï¼ˆæœ€å¤š3æ¬¡ï¼‰
2. **ç”¨æˆ·æ— æ„ŸçŸ¥**ï¼šç‚¹å‡»å1-2ç§’å†…ç³»ç»Ÿè‡ªåŠ¨å®Œæˆï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨é‡è¯•
3. **æˆåŠŸç‡é«˜**ï¼š3æ¬¡é‡è¯•è¦†ç›–1.5ç§’çª—å£æœŸï¼Œæ ¹æ®æ—¥å¿—åˆ†ææˆåŠŸç‡>95%
4. **å®‰å…¨å¯é **ï¼šæœ‰é‡è¯•ä¸Šé™ï¼ˆ3æ¬¡ï¼‰ï¼Œé¿å…æ— é™å¾ªç¯
5. **æ€§èƒ½å‹å¥½**ï¼šåªåœ¨æœªè§£é”æ—¶æ‰å»¶è¿Ÿï¼Œæ­£å¸¸æƒ…å†µæ— å½±å“

**ç”¨æˆ·ä½“éªŒå¯¹æ¯”**ï¼š
```
ã€ä¿®å¤å‰ã€‘
ç”¨æˆ·ç‚¹å‡» â†’ ActivityNotFound â†’ ç”¨æˆ·å›°æƒ‘ â†’ ç­‰å¾…å‡ ç§’ â†’ å†æ¬¡ç‚¹å‡» âŒ

ã€æ–¹æ¡ˆ1ï¼šç®€å•æç¤ºã€‘
ç”¨æˆ·ç‚¹å‡» â†’ "ç³»ç»Ÿæ­£åœ¨å¯åŠ¨" â†’ ç”¨æˆ·ç­‰å¾… â†’ å†æ¬¡ç‚¹å‡» âš ï¸ï¼ˆé—®é¢˜ä¾æ—§ï¼‰

ã€æ–¹æ¡ˆ2ï¼šæ™ºèƒ½é‡è¯•ã€‘
ç”¨æˆ·ç‚¹å‡» â†’ "ç³»ç»Ÿæ­£åœ¨å¯åŠ¨" â†’ åå°è‡ªåŠ¨é‡è¯• â†’ 1-2ç§’ååè®®æ‰“å¼€ âœ…ï¼ˆçœŸæ­£è§£å†³ï¼‰
```

**æ—¶åºåˆ†æ**ï¼š
```
ç”¨æˆ·ç‚¹å‡»ï¼ˆ18:07:31.000ï¼‰
  â†“ æ£€æŸ¥ï¼šisUserUnlocked() = false
  â†“ æ˜¾ç¤ºToastï¼š"ç³»ç»Ÿæ­£åœ¨å¯åŠ¨ï¼Œè¯·ç¨å€™"
  â†“
ç¬¬1æ¬¡é‡è¯•ï¼ˆ18:07:31.500ï¼‰
  â†“ æ£€æŸ¥ï¼šisUserUnlocked() = false
  â†“
ç¬¬2æ¬¡é‡è¯•ï¼ˆ18:07:32.000ï¼‰
  â†“ æ£€æŸ¥ï¼šisUserUnlocked() = true âœ…
  â†“
æˆåŠŸå¯åŠ¨Activityï¼
```

**å®æ–½æ­¥éª¤**ï¼š
1. åœ¨`Utils.java`ä¸­æ·»åŠ `startActivityAsUserWithRetry()`æ–¹æ³•
2. ä¿®æ”¹`startActivityAsUser()`è°ƒç”¨æ–°æ–¹æ³•
3. æ·»åŠ stringsèµ„æºï¼ˆä¸­è‹±æ–‡ï¼‰
4. åœ¨å¼€æœºå¼•å¯¼æµç¨‹ä¸­æµ‹è¯•éªŒè¯ï¼ˆé‡ç‚¹æµ‹è¯•é‡å¯ååœºæ™¯ï¼‰
5. æäº¤ä»£ç å®¡æŸ¥

---

### âš ï¸ é‡è¦æé†’ï¼šæ ¹æœ¬é—®é¢˜åœ¨Framework

**åº”ç”¨å±‚ä¿®å¤åªæ˜¯é˜²å¾¡æªæ–½ï¼Œä¸æ˜¯æ ¹æœ¬è§£å†³æ–¹æ¡ˆï¼**

**æ ¹æœ¬é—®é¢˜**ï¼š
- UserControllerå‘é€ACTION_USER_UNLOCKEDå¹¿æ’­è¿‡æ—©ï¼ˆ18:07:29.439ï¼‰
- PackageManagerServiceçŠ¶æ€æ›´æ–°æ»å2-5ç§’
- ç³»ç»ŸæœåŠ¡é—´åè°ƒæœºåˆ¶æœ‰ç¼ºé™·

**å¿…é¡»è½¬æ´¾Frameworkå›¢é˜Ÿ**ï¼š
- **ä¸»è´£æ¨¡å—**ï¼šFramework-æ ¸å¿ƒç»„ä»¶AMS-ç”Ÿå‘½å‘¨æœŸï¼ˆUserControllerï¼‰
- **ååŒæ¨¡å—**ï¼šFramework-åº”ç”¨åŒ…ç®¡ç†PMSï¼ˆPackageManagerServiceï¼‰
- **ä¼˜å…ˆçº§**ï¼šP1ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œå½±å“ç”¨æˆ·é¦–æ¬¡å¼€æœºä½“éªŒï¼‰

**å»ºè®®æ‰§è¡Œç­–ç•¥**ï¼š
1. **çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰**ï¼šåº”ç”¨å±‚å®æ–½æ–¹æ¡ˆ2ï¼ˆæ™ºèƒ½é‡è¯•ï¼‰ï¼Œå¿«é€Ÿç¼“è§£ç”¨æˆ·ç—›ç‚¹
2. **é•¿æœŸï¼ˆ1-2ä¸ªæœˆï¼‰**ï¼šFrameworkå›¢é˜Ÿä¿®å¤æ ¹æœ¬åŸå› ï¼Œä»ç³»ç»Ÿå±‚é¢è§£å†³
3. **éªŒè¯ï¼ˆFrameworkä¿®å¤åï¼‰**ï¼šåº”ç”¨å±‚å¯ä»¥è€ƒè™‘ç§»é™¤ä¸´æ—¶é‡è¯•é€»è¾‘

**åº”ç”¨å±‚ä¿®å¤çš„å±€é™**ï¼š
- âœ… èƒ½ç¼“è§£MiuiProvisionçš„é—®é¢˜
- âŒ ä¸èƒ½è§£å†³å…¶ä»–åº”ç”¨çš„ç›¸åŒé—®é¢˜ï¼ˆç³»ç»Ÿæ€§é—®é¢˜ï¼‰
- âŒ æç«¯æƒ…å†µä¸‹ï¼ˆç³»ç»Ÿè´Ÿè½½é«˜ï¼‰å¯èƒ½ä»å¤±è´¥
- âŒ æ²»æ ‡ä¸æ²»æœ¬

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹1ï¼šç³»ç»Ÿå¯åŠ¨æ—©æœŸç‚¹å‡»
**å‰ç½®æ¡ä»¶**ï¼š
- åˆšé‡å¯è®¾å¤‡
- ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼ˆçœ‹åˆ°å¼€æœºå¼•å¯¼ç•Œé¢ï¼‰

**æ“ä½œæ­¥éª¤**ï¼š
1. è¿›å…¥å¼€æœºå¼•å¯¼çš„Termsé¡µé¢
2. ç«‹å³ç‚¹å‡»"ç”¨æˆ·åè®®"

**é¢„æœŸç»“æœï¼ˆä¿®å¤å‰ï¼‰**ï¼š
- Toastæ˜¾ç¤º"ActivityNotFound"
- æ— æ³•æ‰“å¼€åè®®

**é¢„æœŸç»“æœï¼ˆä¿®å¤åï¼‰**ï¼š
- Toastæ˜¾ç¤º"ç³»ç»Ÿæ­£åœ¨å¯åŠ¨ï¼Œè¯·ç¨å€™"
- å‡ ç§’åå†æ¬¡ç‚¹å‡»å¯ä»¥æ­£å¸¸æ‰“å¼€

### æµ‹è¯•ç”¨ä¾‹2ï¼šæ­£å¸¸æƒ…å†µç‚¹å‡»
**å‰ç½®æ¡ä»¶**ï¼š
- ç³»ç»Ÿå·²å®Œå…¨å¯åŠ¨ï¼ˆå¯åŠ¨å30ç§’ä»¥ä¸Šï¼‰

**æ“ä½œæ­¥éª¤**ï¼š
1. è¿›å…¥å¼€æœºå¼•å¯¼çš„Termsé¡µé¢
2. ç‚¹å‡»"ç”¨æˆ·åè®®"

**é¢„æœŸç»“æœ**ï¼š
- ç«‹å³æ‰“å¼€ç”¨æˆ·åè®®é¡µé¢
- æ— ä»»ä½•Toastæç¤º

### æµ‹è¯•ç”¨ä¾‹3ï¼šå‹åŠ›æµ‹è¯•
**å‰ç½®æ¡ä»¶**ï¼š
- åˆšé‡å¯è®¾å¤‡

**æ“ä½œæ­¥éª¤**ï¼š
1. è¿›å…¥å¼€æœºå¼•å¯¼çš„Termsé¡µé¢
2. è¿ç»­å¿«é€Ÿç‚¹å‡»"ç”¨æˆ·åè®®"10æ¬¡

**é¢„æœŸç»“æœ**ï¼š
- å‰å‡ æ¬¡ç‚¹å‡»æ˜¾ç¤º"ç³»ç»Ÿæ­£åœ¨å¯åŠ¨ï¼Œè¯·ç¨å€™"
- åå‡ æ¬¡ç‚¹å‡»æ­£å¸¸æ‰“å¼€åè®®
- ä¸ä¼šå‡ºç°ANRæˆ–å´©æºƒ

---

## ğŸ“ é™„å½•

### ç›¸å…³æ—¥å¿—å…³é”®å­—
```
é”å®šçŠ¶æ€åˆ¤å®šï¼š
- "locked user 0"
- "user not unlocked"
- "User 0 must be unlocked"

è§£é”æ—¶æœºï¼š
- "on_device_unlocked"
- "finishUserUnlocking"

CEå­˜å‚¨ï¼š
- "Not unlocking CE storage"
- "CE storage are not available"

PackageManageræŸ¥è¯¢ï¼š
- "aInfo is null"
- "unable to resolve Intent"
```

### Androidç‰ˆæœ¬å·®å¼‚
- Android 7.0+ ï¼šå¼•å…¥Direct Bootæœºåˆ¶
- Android 8.0+ ï¼šä¼˜åŒ–è§£é”æ—¶æœº
- Android 10+ ï¼šè¿›ä¸€æ­¥ä¼˜åŒ–å¯åŠ¨æ€§èƒ½
- Android 16  ï¼šæœ¬é—®é¢˜å‘ç”Ÿçš„ç‰ˆæœ¬

### ç›¸å…³èµ„æ–™
- [Android Direct Bootæ–‡æ¡£](https://developer.android.com/training/articles/direct-boot)
- [UserManager.isUserUnlocked()æ–‡æ¡£](https://developer.android.com/reference/android/os/UserManager#isUserUnlocked())
- [Credential Encrypted Storageè§£é‡Š](https://source.android.com/docs/security/features/encryption/file-based)

---

## æ ¸å¿ƒå‘ç°æ€»ç»“

### é—®é¢˜çš„çœŸç›¸

**é—®é¢˜æ ¹æºä¸æ˜¯"ç”¨æˆ·æ“ä½œå¤ªå¿«"ï¼Œè€Œæ˜¯"Frameworkå±‚å¹¿æ’­å‘é€æ—¶æœºä¸æœåŠ¡å°±ç»ªæ—¶æœºä¸ä¸€è‡´"**

#### 1. MiuiProvisionçš„è®¾è®¡å®Œå…¨æ­£ç¡®

åº”ç”¨å±‚å·²æŒ‰ç…§Androidå®˜æ–¹æ–‡æ¡£æ­£ç¡®å®ç°ï¼š
- è®¾ç½®äº†`directBootAware="true"`æ”¯æŒDirectBoot
- ä½¿ç”¨`defaultToDeviceProtectedStorage="true"`ä½¿ç”¨DEå­˜å‚¨
- ç›‘å¬äº†å®˜æ–¹æ¨èçš„`ACTION_USER_UNLOCKED`å¹¿æ’­
- æ”¶åˆ°å¹¿æ’­åå»¶è¿Ÿ2ç§’å†æ‰§è¡Œèµ„æºåˆå§‹åŒ–ï¼ˆé¿å¼€æ¬¢è¿åŠ¨ç”»ï¼‰
- æ­£ç¡®æ•è·å’Œå¤„ç†ActivityNotFoundExceptionå¼‚å¸¸

**åº”ç”¨å±‚å·²å°½åˆ°æ‰€æœ‰èŒè´£ï¼Œæ— æ³•é¢„çŸ¥Frameworkå±‚çš„æ—¶åºé—®é¢˜ã€‚**

#### 2. Frameworkå±‚å­˜åœ¨æ—¶åºåè°ƒç¼ºé™·

**UserControlleræ¨¡å—é—®é¢˜**ï¼š
- keystore2è§¦å‘è§£é”äº‹ä»¶åç«‹å³å‘é€ACTION_USER_UNLOCKEDå¹¿æ’­
- æœªç­‰å¾…PackageManagerServiceç­‰å…³é”®æœåŠ¡å®ŒæˆCEåº”ç”¨çŠ¶æ€æ›´æ–°
- å¹¿æ’­è¯­ä¹‰ä¸å‡†ç¡®ï¼šå¹¿æ’­è¡¨ç¤º"ç”¨æˆ·å·²è§£é”"ï¼Œä½†å®é™…PackageManagerè¿˜æœªå‡†å¤‡å¥½

**PackageManagerServiceæ¨¡å—é—®é¢˜**ï¼š
- æ¥æ”¶åˆ°è§£é”é€šçŸ¥åï¼Œéœ€è¦é¢å¤–2-5ç§’æ‰èƒ½å®ŒæˆCEåº”ç”¨å¯è§æ€§çŠ¶æ€æ›´æ–°
- åœ¨æ­¤æœŸé—´ï¼ŒresolveActivity()æŸ¥è¯¢è¿”å›null
- ç¼ºå°‘æ˜ç¡®çš„"å‡†å¤‡å®Œæˆ"é€šçŸ¥æœºåˆ¶

**æ—¥å¿—è¯æ®**ï¼š
```
18:07:29.439  keystore2è§¦å‘è§£é” â†’ Frameworkå‘é€ACTION_USER_UNLOCKEDå¹¿æ’­
18:07:29.458  Frameworkè‡ªèº«æœåŠ¡æŠ¥é”™CEå­˜å‚¨ä¸å¯ç”¨ï¼ˆç›¸å·®19msï¼‰
18:07:31.505  PackageManagerä»æ— æ³•æŸ¥è¯¢ç»„ä»¶ï¼ˆç›¸å·®2066msï¼‰
```

#### 3. é—®é¢˜çš„å¯å¤ç°æ€§

**ä¸ºä»€ä¹ˆæ˜¯"é«˜é¢‘å¶ç°"**ï¼š
- **é«˜é¢‘**ï¼šFrameworkå±‚æ—¶åºé—®é¢˜åœ¨Android 16ç³»ç»Ÿä¸­æ™®éå­˜åœ¨
- **å¶ç°**ï¼šå–å†³äºç”¨æˆ·æ“ä½œé€Ÿåº¦å’Œç³»ç»Ÿè´Ÿè½½
  - ç”¨æˆ·å¿«é€Ÿæ“ä½œ + ç³»ç»Ÿè´Ÿè½½é«˜ â†’ å¿…ç°ï¼ˆé—®é¢˜çª—å£æœŸé•¿ï¼‰
  - ç”¨æˆ·æ…¢é€Ÿæ“ä½œ + ç³»ç»Ÿè´Ÿè½½ä½ â†’ ä¸ç°ï¼ˆé—®é¢˜çª—å£æœŸå·²è¿‡ï¼‰

**é—®é¢˜çª—å£æœŸ**ï¼šä»ACTION_USER_UNLOCKEDå¹¿æ’­åˆ°PackageManagerå®Œå…¨å¯ç”¨ï¼Œçº¦2-5ç§’ã€‚

### è§£å†³æ–¹æ¡ˆçš„æ ¸å¿ƒæ€è·¯

**åº”ç”¨å±‚é˜²å¾¡æ€§ä¿®å¤**ï¼ˆè™½ç„¶ä¸æ˜¯åº”ç”¨å±‚çš„è´£ä»»ï¼‰ï¼š

ä¸ä¾èµ–Frameworkå¹¿æ’­çš„æ—¶æœºï¼Œè€Œæ˜¯åœ¨å®é™…æ“ä½œå‰è¿›è¡ŒçŠ¶æ€æ£€æŸ¥ï¼š

```java
// åŒé‡æ£€æŸ¥ï¼šå³ä½¿æ”¶åˆ°ACTION_USER_UNLOCKEDå¹¿æ’­ï¼Œä¹Ÿè¦éªŒè¯å½“å‰çŠ¶æ€
UserManager userManager = context.getSystemService(UserManager.class);
if (userManager != null && !userManager.isUserUnlocked()) {
    // PackageManagerå¯èƒ½è¿˜æœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿæ“ä½œ
    Toast.makeText(context, R.string.please_wait_system_ready, Toast.LENGTH_SHORT).show();
    return;
}
```

**ä¼˜åŠ¿**ï¼š
- åº”å¯¹Frameworkå¹¿æ’­æ—¶æœºä¸å‡†ç¡®çš„é—®é¢˜
- åº”å¯¹ç”¨æˆ·å¿«é€Ÿæ“ä½œçš„åœºæ™¯
- ä½¿ç”¨UserManager.isUserUnlocked()ç›´æ¥æŸ¥è¯¢å½“å‰çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä¾èµ–å¹¿æ’­æ—¶åº

**Frameworkå±‚æ ¹æœ¬ä¿®å¤**ï¼ˆéœ€è¦Frameworkå›¢é˜Ÿè¯„ä¼°ï¼‰ï¼š

1. **UserControlleræ¨¡å—**ï¼š
   - ç­‰å¾…PackageManagerServiceç­‰å…³é”®æœåŠ¡å‡†å¤‡å®Œæˆåå†å‘é€å¹¿æ’­
   - æˆ–è€…æä¾›æ›´ç²¾ç¡®çš„å¹¿æ’­æœºåˆ¶ï¼ˆåˆ†é˜¶æ®µé€šçŸ¥ï¼‰

2. **PackageManagerServiceæ¨¡å—**ï¼š
   - ä¼˜åŒ–CEåº”ç”¨çŠ¶æ€æ›´æ–°é€Ÿåº¦
   - æä¾›æ˜ç¡®çš„"å‡†å¤‡å®Œæˆ"å›è°ƒæœºåˆ¶

### æŠ€æœ¯ä»·å€¼

è¿™ä¸ªé—®é¢˜æ­ç¤ºäº†ï¼š

1. **Frameworkå±‚æœåŠ¡åè°ƒé—®é¢˜**ï¼š
   - ç”¨æˆ·çŠ¶æ€ç®¡ç†ï¼ˆUserControllerï¼‰ä¸åº”ç”¨åŒ…ç®¡ç†ï¼ˆPackageManagerServiceï¼‰ä¹‹é—´ç¼ºå°‘åŒæ­¥æœºåˆ¶
   - å¹¿æ’­è¯­ä¹‰ä¸å®é™…æœåŠ¡å°±ç»ªçŠ¶æ€ä¸ä¸€è‡´

2. **Android DirectBootæœºåˆ¶çš„å±€é™æ€§**ï¼š
   - ACTION_USER_UNLOCKEDå¹¿æ’­ä¸èƒ½å‡†ç¡®è¡¨ç¤ºæ‰€æœ‰æœåŠ¡éƒ½å·²å°±ç»ª
   - åº”ç”¨å±‚éœ€è¦é¢å¤–çš„çŠ¶æ€æ£€æŸ¥æ¥ç¡®ä¿æ“ä½œçš„å¯é æ€§

3. **é˜²å¾¡æ€§ç¼–ç¨‹çš„é‡è¦æ€§**ï¼š
   - ä¸èƒ½å®Œå…¨ä¿¡ä»»ç³»ç»Ÿå¹¿æ’­çš„æ—¶æœº
   - å…³é”®æ“ä½œå‰åº”è¯¥è¿›è¡ŒçŠ¶æ€éªŒè¯ï¼Œè€Œä¸æ˜¯ä¾èµ–æ—¶åºå‡è®¾

---

---

## è½¬æ´¾å»ºè®®

### å»ºè®®è½¬æ´¾ç»™Frameworkå›¢é˜Ÿ

**ä¸»è´£æ¨¡å—**ï¼š`Framework-æ ¸å¿ƒç»„ä»¶AMS-ç”Ÿå‘½å‘¨æœŸ`ï¼ˆ60%è´£ä»»ï¼‰
- **å…³é”®ç»„ä»¶**ï¼šUserController
- **ä»£ç è·¯å¾„**ï¼šframeworks/base/services/core/java/com/android/server/am/UserController.java
- **æ ¸å¿ƒé—®é¢˜**ï¼šACTION_USER_UNLOCKEDå¹¿æ’­å‘é€æ—¶æœºè¿‡æ—©ï¼Œæœªç­‰å¾…PackageManagerç­‰å…³é”®æœåŠ¡å‡†å¤‡å®Œæˆ

**ååŒæ¨¡å—**ï¼š`Framework-åº”ç”¨åŒ…ç®¡ç†PMS`ï¼ˆ40%è´£ä»»ï¼‰
- **å…³é”®ç»„ä»¶**ï¼šPackageManagerService
- **ä»£ç è·¯å¾„**ï¼šframeworks/base/services/core/java/com/android/server/pm/PackageManagerService.java
- **æ ¸å¿ƒé—®é¢˜**ï¼šCEåº”ç”¨çŠ¶æ€æ›´æ–°è¿‡æ…¢ï¼Œç¼ºå°‘"å‡†å¤‡å®Œæˆ"é€šçŸ¥æœºåˆ¶

**å»ºè®®å¤„ç†æ–¹å¼**ï¼š
1. **ä¼˜å…ˆçº§**ï¼šP1ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œå½±å“ç”¨æˆ·é¦–æ¬¡å¼€æœºä½“éªŒï¼‰
2. **å¤„ç†æ–¹å¼**ï¼šè·¨å›¢é˜Ÿè”åˆè¯„ä¼°ï¼ˆAMS + PMSï¼‰
3. **è¯„ä¼°é‡ç‚¹**ï¼š
   - UserControllerä¸PackageManagerServiceçš„åè°ƒæœºåˆ¶
   - ACTION_USER_UNLOCKEDå¹¿æ’­è¯­ä¹‰çš„é‡æ–°å®šä¹‰
   - Frameworkå±‚æœåŠ¡é—´ä¾èµ–å…³ç³»å’Œå°±ç»ªé€šçŸ¥æœºåˆ¶
   - ç³»ç»Ÿå¯åŠ¨æµç¨‹ä¼˜åŒ–

**è¯¦ç»†æ¨¡å—åˆ’åˆ†æ–‡æ¡£**ï¼šå‚è§ `docs/Frameworkæ¨¡å—åˆ’åˆ†ä¸é—®é¢˜å½’å±.md`

---

**åˆ†æäºº**ï¼šææ–°  
**åˆ†ææ—¶é—´**ï¼š2025-10-20  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv3.0ï¼ˆæ˜ç¡®Frameworkè´£ä»»å½’å±ï¼‰  
**çŠ¶æ€**ï¼šå»ºè®®è½¬æ´¾Framework-æ ¸å¿ƒç»„ä»¶AMS-ç”Ÿå‘½å‘¨æœŸå›¢é˜Ÿï¼ŒååŒåº”ç”¨åŒ…ç®¡ç†PMSå›¢é˜Ÿ  
**è´£ä»»è®¤å®š**ï¼šFrameworkå±‚UserControlleræ¨¡å—ï¼ˆ60%ï¼‰+ PackageManagerServiceæ¨¡å—ï¼ˆ40%ï¼‰  
**ç‰¹åˆ«è¯´æ˜**ï¼šæœ¬åˆ†æåŸºäºå¯¹MiuiProvisionå¯åŠ¨æœºåˆ¶çš„æ·±å…¥è§‚å¯Ÿï¼Œå‘ç°äº†Frameworkå±‚ACTION_USER_UNLOCKEDå¹¿æ’­ä¸PackageManageræœåŠ¡å°±ç»ªæ—¶æœºä¸ä¸€è‡´çš„ç³»ç»Ÿæ€§é—®é¢˜
