---
layout: default
title: 6. 质量保证 (Quality Assurance)
parent: 模块解析
---



# 6. 质量保证 (Quality Assurance)

## 6.1 代码质量

### 6.1.1 代码规范

#### 命名规范

**类命名规范**:
```java
// ✅ 正确：大驼峰，名词
public class LanguagePickerActivity { }
public class UserManagerHelper { }
public class PreLoadManager { }

// ❌ 错误
public class languagepicker { }  // 小写
public class PickLanguage { }    // 动词开头
```

**方法命名规范**:
```java
// ✅ 正确：小驼峰，动词开头
public void initView() { }
public boolean isAvailable() { }
public String getLanguageName() { }
public void setLanguageCode(String code) { }

// ❌ 错误
public void View() { }           // 缺少动词
public boolean Available() { }   // 大驼峰
```

**变量命名规范**:
```java
// ✅ 正确：小驼峰，有意义
private StateMachine mStateMachine;         // 成员变量m前缀
private static PreLoadManager sInstance;    // 静态变量s前缀
private final int MAX_RETRY_COUNT = 3;      // 常量大写+下划线

// ❌ 错误
private StateMachine sm;        // 缩写不清晰
private int a, b, c;            // 无意义命名
```

**资源命名规范**:
```xml
<!-- ✅ 正确：小写+下划线 -->
<string name="language_picker_title">选择语言</string>
<dimen name="text_size_large">18sp</dimen>
<color name="primary_text_color">#000000</color>
<drawable name="ic_language_selector" />

<!-- ❌ 错误 -->
<string name="LanguageTitle">选择语言</string>  <!-- 大驼峰 -->
<dimen name="textSize">18sp</dimen>              <!-- 驼峰命名 -->
```

#### 注释规范

**类注释**:
```java
/**
 * 预加载管理器
 * 
 * 负责管理图片、布局、逻辑的预加载，提升应用启动性能。
 * 支持：
 * - 图片预加载（ImagePreLoader）
 * - 布局预加载（LayoutPreLoader）
 * - 逻辑预加载（LogicLoader）
 * 
 * @author MIUI Team
 * @since 1.0
 */
public class PreLoadManager {
    // ...
}
```

**方法注释**:
```java
/**
 * 预加载指定Activity的资源
 * 
 * 该方法会预加载当前Activity前后各2个页面的资源，包括：
 * 1. 图片资源
 * 2. 布局文件
 * 3. 业务逻辑
 * 
 * @param activityCls 当前Activity的Class对象
 * @throws IllegalArgumentException 如果activityCls为null
 */
public void run(Class activityCls) {
    if (activityCls == null) {
        throw new IllegalArgumentException("activityCls cannot be null");
    }
    createPreLoadList(activityCls);
    preLoad();
}
```

**关键代码注释**:
```java
public void transitToNext() {
    // 离开当前状态
    mCurrentState.onLeave();
    
    // 将当前状态压入栈（支持回退）
    if (mCurrentState.canBackTo()) {
        mStateStack.add(mCurrentState);
    }
    
    // 查找下一个可用状态（跳过不可用的状态）
    State nextState = getNextAvailableState(mCurrentState);
    if (nextState != null) {
        mCurrentState = nextState;
        mCurrentState.onEnter(canGoBack, true);
        saveState();  // 持久化当前状态
    } else {
        // 所有状态完成，结束引导流程
        finishSetup(true);
    }
}
```

#### 格式规范

**缩进与换行**:
```java
// ✅ 正确：4个空格缩进
public class Example {
    private int value;
    
    public void method() {
        if (condition) {
            // 代码
        }
    }
}

// 每行不超过120字符，超出需换行
String longString = "这是一个很长的字符串，超过了120个字符的限制，" +
    "所以需要换行处理，保持代码的可读性";
```

**空格规范**:
```java
// ✅ 正确
if (condition) {
    int result = a + b;
}

for (int i = 0; i < 10; i++) {
    // ...
}

// ❌ 错误
if(condition){              // 缺少空格
    int result=a+b;         // 运算符两侧缺少空格
}
```

**import顺序**:
```java
// 1. Android imports
import android.app.Activity;
import android.content.Context;

// 2. Third-party imports
import androidx.annotation.NonNull;

// 3. Java imports
import java.util.List;
import java.util.ArrayList;

// 4. Project imports
import com.android.provision.Utils;
```

#### 代码审查

**Code Review检查清单**:
- [ ] 代码功能是否符合需求
- [ ] 是否遵循命名规范
- [ ] 是否有充分的注释
- [ ] 是否有潜在的内存泄漏
- [ ] 是否有异常处理
- [ ] 是否有单元测试
- [ ] 性能是否有优化空间
- [ ] 安全性是否考虑充分

**Review工具**:
- **Gerrit**: 代码审查平台
- **GitHub Pull Request**: PR审查
- **Phabricator**: Facebook开源的审查工具

---

### 6.1.2 静态分析

#### Lint检查

**Lint配置**:
```gradle
// app/build.gradle第48行
lintOptions {
    abortOnError false  // 不因Lint错误中断构建
    
    // 推荐配置
    checkReleaseBuilds true
    checkAllWarnings true
    warningsAsErrors false
    
    // 禁用某些检查
    disable 'InvalidPackage', 'OldTargetApi'
    
    // 设置baseline
    baseline file("lint-baseline.xml")
}
```

**常见Lint问题**:
```java
// ⚠️ Lint警告：未使用的资源
// @drawable/unused_image

// ⚠️ Lint警告：硬编码字符串
TextView textView = findViewById(R.id.text);
textView.setText("Hello");  // 应使用string资源

// ✅ 正确
textView.setText(R.string.hello);

// ⚠️ Lint警告：可能的内存泄漏
public class MainActivity extends Activity {
    private Handler mHandler = new Handler();  // 内部类持有外部引用
}

// ✅ 正确：使用静态内部类+WeakReference
private static class MyHandler extends Handler {
    private WeakReference<MainActivity> mActivity;
    // ...
}
```

**运行Lint检查**:
```bash
# 运行Lint检查
./gradlew lint

# 查看报告
open app/build/reports/lint-results.html

# 生成Lint基线
./gradlew lintDebug -PupdateLintBaseline=true
```

#### FindBugs/SpotBugs

**SpotBugs配置**:
```gradle
plugins {
    id 'com.github.spotbugs' version '5.0.13'
}

spotbugs {
    toolVersion = '4.7.3'
    ignoreFailures = false
    effort = 'max'
    reportLevel = 'high'
}

tasks.withType(com.github.spotbugs.snom.SpotBugsTask) {
    reports {
        html.enabled = true
        xml.enabled = false
    }
}
```

**常见问题检测**:
- **NP_**: Null Pointer异常
- **RCN_**: 冗余的null检查
- **DE_**: 可能导致死锁
- **IS_**: 不安全的字符串比较
- **DM_**: 可疑的方法调用

#### PMD

**PMD配置**:
```gradle
apply plugin: 'pmd'

pmd {
    consoleOutput = true
    toolVersion = "6.48.0"
    ruleSets = []
    ruleSetFiles = files("config/pmd/pmd-ruleset.xml")
}

task pmd(type: Pmd) {
    source 'src'
    include '**/*.java'
    exclude '**/gen/**'
    
    reports {
        xml.enabled = false
        html.enabled = true
        html.destination file("$project.buildDir/reports/pmd/pmd.html")
    }
}
```

**检查规则**:
- 代码复杂度
- 未使用的变量
- 空try-catch块
- 过长的方法
- 重复代码

#### SonarQube

**SonarQube集成**:
```gradle
plugins {
    id "org.sonarqube" version "3.5.0"
}

sonarqube {
    properties {
        property "sonar.projectKey", "MiuiProvision"
        property "sonar.projectName", "MIUI Provision"
        property "sonar.host.url", "http://sonarqube.example.com"
        property "sonar.login", "your-token"
        
        property "sonar.sources", "src"
        property "sonar.java.binaries", "build/classes"
        property "sonar.java.libraries", "libs/*.jar"
        
        property "sonar.coverage.jacoco.xmlReportPaths", 
            "build/reports/jacoco/test/jacocoTestReport.xml"
    }
}
```

**质量门禁**:
```yaml
# sonar-project.properties
sonar.qualitygate.wait=true
sonar.qualitygate.timeout=300

# 质量指标
sonar.coverage.minimum=80%
sonar.duplications.maximum=3%
sonar.issues.maximum=0
```

---

### 6.1.3 复杂度控制

#### 圈复杂度

**圈复杂度定义**:
- **1-10**: 简单方法，风险低
- **11-20**: 中等复杂度，需要注意
- **21-50**: 复杂方法，建议重构
- **50+**: 高风险，必须重构

**计算示例**:
```java
// 圈复杂度 = 11（过高）
public boolean isAvailable(boolean toNext) {
    if (Utils.isMiSansSupportLanguages()) {          // +1
        if (FontStyleFragment.getFontList(context).size() == 2) {  // +1
            if (!Utils.isFoldDevice()) {             // +1
                if (!Utils.isInProvisionState(context)) {  // +1
                    if (toNext) {                    // +1
                        return checkSomething();     // +1
                    } else {
                        return checkOther();         // +1
                    }
                }
            }
        }
    }
    return false;
}

// ✅ 重构后：圈复杂度 = 5
public boolean isAvailable(boolean toNext) {
    if (!meetsBasicRequirements()) {
        return false;
    }
    return toNext ? checkSomething() : checkOther();
}

private boolean meetsBasicRequirements() {
    return Utils.isMiSansSupportLanguages()
        && FontStyleFragment.getFontList(context).size() == 2
        && !Utils.isFoldDevice()
        && !Utils.isInProvisionState(context);
}
```

#### 认知复杂度

**认知复杂度评估**:
```java
// ❌ 高认知复杂度
public void processData() {
    if (data != null) {
        if (data.isValid()) {
            for (Item item : data.getItems()) {
                if (item.isEnabled()) {
                    if (item.getType() == TYPE_A) {
                        processTypeA(item);
                    } else if (item.getType() == TYPE_B) {
                        processTypeB(item);
                    } else {
                        processTypeC(item);
                    }
                }
            }
        }
    }
}

// ✅ 降低认知复杂度
public void processData() {
    if (!isDataValid()) {
        return;
    }
    
    data.getItems().stream()
        .filter(Item::isEnabled)
        .forEach(this::processItem);
}

private boolean isDataValid() {
    return data != null && data.isValid();
}

private void processItem(Item item) {
    switch (item.getType()) {
        case TYPE_A: processTypeA(item); break;
        case TYPE_B: processTypeB(item); break;
        default: processTypeC(item); break;
    }
}
```

#### 代码行数控制

**方法行数限制**:
- **建议**: 每个方法不超过50行
- **警告**: 超过100行需要重构
- **严重**: 超过200行必须拆分

**类行数限制**:
- **建议**: 每个类不超过500行
- **警告**: 超过1000行需要重构
- **严重**: 超过2000行必须拆分

**重构策略**:
```java
// ❌ 过长的方法（200+行）
public void init() {
    // 100行初始化代码
    // 50行配置代码
    // 50行UI设置代码
}

// ✅ 拆分为多个方法
public void init() {
    initializeComponents();
    configureSettings();
    setupUI();
}

private void initializeComponents() {
    // 组件初始化
}

private void configureSettings() {
    // 配置设置
}

private void setupUI() {
    // UI设置
}
```

#### 重构建议

**重构技巧**:
1. **提取方法**: 将复杂逻辑提取为独立方法
2. **引入参数对象**: 多参数合并为对象
3. **用多态替代条件**: 使用策略模式
4. **分解大类**: 拆分为多个职责单一的类

```java
// 1. 提取方法
// Before
public void process() {
    // 50行逻辑A
    // 50行逻辑B
}

// After
public void process() {
    processA();
    processB();
}

// 2. 引入参数对象
// Before
public void create(String name, int age, String email, String phone, String address) { }

// After
public void create(UserInfo userInfo) { }

// 3. 用多态替代条件
// Before
public void handle(int type) {
    if (type == TYPE_A) { /* ... */ }
    else if (type == TYPE_B) { /* ... */ }
    else { /* ... */ }
}

// After
interface Handler {
    void handle();
}
class TypeAHandler implements Handler { }
class TypeBHandler implements Handler { }
```

---

## 6.2 测试策略

### 6.2.1 单元测试

#### JUnit框架

**JUnit 4基础**:
```java
import org.junit.Test;
import org.junit.Before;
import org.junit.After;
import static org.junit.Assert.*;

public class UtilsTest {
    
    @Before
    public void setUp() {
        // 测试前准备
    }
    
    @After
    public void tearDown() {
        // 测试后清理
    }
    
    @Test
    public void testIsTabletDevice() {
        boolean result = Utils.isTabletDevice();
        assertNotNull(result);
    }
    
    @Test(expected = NullPointerException.class)
    public void testNullInput() {
        Utils.processData(null);
    }
    
    @Test(timeout = 1000)
    public void testPerformance() {
        // 必须在1秒内完成
        Utils.heavyOperation();
    }
}
```

**JUnit 5 (Jupiter)**:
```java
import org.junit.jupiter.api.*;
import static org.junit.jupiter.api.Assertions.*;

@DisplayName("PreLoadManager测试")
class PreLoadManagerTest {
    
    private PreLoadManager preLoadManager;
    
    @BeforeEach
    void setUp() {
        preLoadManager = PreLoadManager.get();
    }
    
    @AfterEach
    void tearDown() {
        preLoadManager.clear();
    }
    
    @Test
    @DisplayName("测试预加载功能")
    void testPreLoad() {
        // Given
        Class activityClass = LanguagePickerActivity.class;
        
        // When
        preLoadManager.run(activityClass);
        
        // Then
        assertNotNull(preLoadManager.getImagePreLoader());
        assertNotNull(preLoadManager.getLayoutPreLoader());
    }
    
    @Test
    @Disabled("暂时禁用")
    void testDisabled() {
        // 暂时不执行
    }
    
    @RepeatedTest(5)
    void testRepeated() {
        // 重复执行5次
    }
    
    @ParameterizedTest
    @ValueSource(ints = {1, 2, 3, 4, 5})
    void testWithParameter(int value) {
        assertTrue(value > 0);
    }
}
```

#### Mock测试

**Mockito使用**:
```java
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import static org.mockito.Mockito.*;

public class StateMachineTest {
    
    @Mock
    private Context mockContext;
    
    @Mock
    private State mockState;
    
    private StateMachine stateMachine;
    
    @Before
    public void setUp() {
        MockitoAnnotations.initMocks(this);
        stateMachine = new StateMachine(mockContext);
    }
    
    @Test
    public void testTransitToNext() {
        // 设置Mock行为
        when(mockState.isAvailable(true)).thenReturn(true);
        when(mockState.canBackTo()).thenReturn(true);
        
        // 执行测试
        stateMachine.transitToNext();
        
        // 验证调用
        verify(mockState).onLeave();
        verify(mockState).isAvailable(true);
        verify(mockState, times(1)).onEnter(anyBoolean(), eq(true));
    }
    
    @Test
    public void testStateNotAvailable() {
        // 状态不可用
        when(mockState.isAvailable(true)).thenReturn(false);
        
        stateMachine.transitToNext();
        
        // 验证onEnter未被调用
        verify(mockState, never()).onEnter(anyBoolean(), anyBoolean());
    }
}
```

**PowerMock（测试静态方法）**:
```java
@RunWith(PowerMockRunner.class)
@PrepareForTest({Utils.class, Build.class})
public class UtilsStaticTest {
    
    @Test
    public void testStaticMethod() {
        // Mock静态方法
        PowerMockito.mockStatic(Utils.class);
        when(Utils.isTabletDevice()).thenReturn(true);
        
        // 测试
        boolean result = Utils.isTabletDevice();
        assertTrue(result);
        
        // 验证
        PowerMockito.verifyStatic(Utils.class);
        Utils.isTabletDevice();
    }
}
```

#### 测试覆盖率

**JaCoCo配置**:
```gradle
apply plugin: 'jacoco'

jacoco {
    toolVersion = "0.8.8"
}

tasks.withType(Test) {
    jacoco.includeNoLocationClasses = true
    jacoco.excludes = ['jdk.internal.*']
}

task jacocoTestReport(type: JacocoReport, dependsOn: 'testDebugUnitTest') {
    reports {
        xml.enabled = true
        html.enabled = true
    }
    
    def fileFilter = [
        '**/R.class',
        '**/R$*.class',
        '**/BuildConfig.*',
        '**/Manifest*.*',
        '**/*Test*.*',
        'android/**/*.*'
    ]
    
    def debugTree = fileTree(dir: "$project.buildDir/intermediates/javac/debug", excludes: fileFilter)
    def mainSrc = "$project.projectDir/src/main/java"
    
    sourceDirectories.setFrom(files([mainSrc]))
    classDirectories.setFrom(files([debugTree]))
    executionData.setFrom(fileTree(dir: project.buildDir, includes: [
        'jacoco/testDebugUnitTest.exec',
        'outputs/code-coverage/connected/*coverage.ec'
    ]))
}
```

**覆盖率报告**:
```bash
# 运行测试并生成覆盖率报告
./gradlew testDebugUnitTest jacocoTestReport

# 查看报告
open app/build/reports/jacoco/jacocoTestReport/html/index.html
```

**覆盖率目标**:
- **最低要求**: 60%
- **推荐目标**: 80%
- **优秀标准**: 90%+

#### TDD实践

**测试驱动开发流程**:
```
1. 红色：编写失败的测试
   ↓
2. 绿色：编写最少代码使测试通过
   ↓
3. 重构：优化代码
   ↓
4. 重复
```

**TDD示例**:
```java
// 1. 先写测试（失败）
@Test
public void testCalculateTotal() {
    ShoppingCart cart = new ShoppingCart();
    cart.addItem(new Item("Apple", 10.0));
    cart.addItem(new Item("Banana", 5.0));
    
    assertEquals(15.0, cart.calculateTotal(), 0.01);
}

// 2. 实现功能（通过）
public class ShoppingCart {
    private List<Item> items = new ArrayList<>();
    
    public void addItem(Item item) {
        items.add(item);
    }
    
    public double calculateTotal() {
        return items.stream()
            .mapToDouble(Item::getPrice)
            .sum();
    }
}

// 3. 重构（优化）
public double calculateTotal() {
    return items.stream()
        .mapToDouble(Item::getPrice)
        .reduce(0.0, Double::sum);
}
```

---

### 6.2.2 集成测试

#### 模块集成测试

**AndroidX Test框架**:
```gradle
dependencies {
    androidTestImplementation 'androidx.test:core:1.5.0'
    androidTestImplementation 'androidx.test:runner:1.5.2'
    androidTestImplementation 'androidx.test:rules:1.5.0'
    androidTestImplementation 'androidx.test.ext:junit:1.1.5'
}
```

**Activity测试**:
```java
@RunWith(AndroidJUnit4.class)
@LargeTest
public class LanguagePickerActivityTest {
    
    @Rule
    public ActivityScenarioRule<LanguagePickerActivity> activityRule =
        new ActivityScenarioRule<>(LanguagePickerActivity.class);
    
    @Test
    public void testActivityLaunch() {
        activityRule.getScenario().onActivity(activity -> {
            assertNotNull(activity);
            assertTrue(activity.isFinishing() == false);
        });
    }
    
    @Test
    public void testLanguageSelection() {
        activityRule.getScenario().onActivity(activity -> {
            // 测试语言选择功能
            activity.selectLanguage("zh_CN");
            assertEquals("zh_CN", activity.getSelectedLanguage());
        });
    }
}
```

#### API测试

**Retrofit API测试**:
```java
@RunWith(AndroidJUnit4.class)
public class NetworkApiTest {
    
    private NetRequestor netRequestor;
    private MockWebServer mockWebServer;
    
    @Before
    public void setUp() throws IOException {
        mockWebServer = new MockWebServer();
        mockWebServer.start();
        
        netRequestor = new NetRequestor(mockWebServer.url("/").toString());
    }
    
    @After
    public void tearDown() throws IOException {
        mockWebServer.shutdown();
    }
    
    @Test
    public void testGetRequest() throws Exception {
        // 模拟服务器响应
        String responseBody = "{\"status\":\"success\"}";
        mockWebServer.enqueue(new MockResponse()
            .setResponseCode(200)
            .setBody(responseBody));
        
        // 发送请求
        Response response = netRequestor.get("/api/data");
        
        // 验证结果
        assertEquals(200, response.getCode());
        assertEquals("success", response.getStatus());
        
        // 验证请求
        RecordedRequest request = mockWebServer.takeRequest();
        assertEquals("/api/data", request.getPath());
        assertEquals("GET", request.getMethod());
    }
}
```

#### 数据库测试

**Room数据库测试**:
```java
@RunWith(AndroidJUnit4.class)
public class ProvisionDatabaseTest {
    
    private ProvisionDBHelper dbHelper;
    private SQLiteDatabase database;
    
    @Before
    public void setUp() {
        Context context = ApplicationProvider.getApplicationContext();
        dbHelper = new ProvisionDBHelper(context);
        database = dbHelper.getWritableDatabase();
    }
    
    @After
    public void tearDown() {
        database.close();
        dbHelper.close();
    }
    
    @Test
    public void testInsertAndQuery() {
        // 插入数据
        ContentValues values = new ContentValues();
        values.put("package", "com.example.app");
        values.put("className", "MainActivity");
        long id = database.insert("appdata", null, values);
        
        assertTrue(id > 0);
        
        // 查询数据
        Cursor cursor = database.query(
            "appdata",
            new String[]{"package", "className"},
            "app_id = ?",
            new String[]{String.valueOf(id)},
            null, null, null
        );
        
        assertTrue(cursor.moveToFirst());
        assertEquals("com.example.app", cursor.getString(0));
        assertEquals("MainActivity", cursor.getString(1));
        cursor.close();
    }
}
```

#### 端到端测试

**用户流程测试**:
```java
@RunWith(AndroidJUnit4.class)
@LargeTest
public class ProvisionE2ETest {
    
    @Rule
    public ActivityScenarioRule<DefaultActivity> activityRule =
        new ActivityScenarioRule<>(DefaultActivity.class);
    
    @Test
    public void testCompleteProvisionFlow() {
        // 1. 启动欢迎页
        onView(withId(R.id.welcome_text))
            .check(matches(isDisplayed()));
        
        // 2. 选择语言
        onView(withId(R.id.next_button)).perform(click());
        onView(withText("简体中文")).perform(click());
        onView(withId(R.id.confirm_button)).perform(click());
        
        // 3. 选择输入法
        onView(withText("百度输入法")).perform(click());
        onView(withId(R.id.next_button)).perform(click());
        
        // 4. 同意条款
        onView(withId(R.id.terms_checkbox)).perform(click());
        onView(withId(R.id.agree_button)).perform(click());
        
        // 5. 验证完成
        onView(withId(R.id.congratulation_text))
            .check(matches(isDisplayed()));
    }
}
```

---

### 6.2.3 UI测试

#### Espresso框架

**Espresso基础**:
```gradle
dependencies {
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
    androidTestImplementation 'androidx.test.espresso:espresso-intents:3.5.1'
    androidTestImplementation 'androidx.test.espresso:espresso-contrib:3.5.1'
}
```

**基本UI测试**:
```java
@RunWith(AndroidJUnit4.class)
public class LanguagePickerUITest {
    
    @Rule
    public ActivityScenarioRule<LanguagePickerActivity> activityRule =
        new ActivityScenarioRule<>(LanguagePickerActivity.class);
    
    @Test
    public void testLanguageListDisplayed() {
        // 检查RecyclerView显示
        onView(withId(R.id.language_list))
            .check(matches(isDisplayed()));
    }
    
    @Test
    public void testSelectLanguage() {
        // 点击语言项
        onView(withText("English"))
            .perform(click());
        
        // 验证选中状态
        onView(withText("English"))
            .check(matches(hasDescendant(withId(R.id.check_icon))));
    }
    
    @Test
    public void testConfirmButton() {
        // 选择语言
        onView(withText("简体中文")).perform(click());
        
        // 点击确认
        onView(withId(R.id.confirm_button))
            .check(matches(isEnabled()))
            .perform(click());
        
        // 验证Activity结束
        assertTrue(activityRule.getScenario().getState()
            .isAtLeast(Lifecycle.State.DESTROYED));
    }
}
```

**RecyclerView测试**:
```java
@Test
public void testRecyclerViewScroll() {
    // 滚动到指定位置
    onView(withId(R.id.language_list))
        .perform(RecyclerViewActions.scrollToPosition(10));
    
    // 滚动到包含特定文本的项
    onView(withId(R.id.language_list))
        .perform(RecyclerViewActions.scrollTo(
            hasDescendant(withText("日本語"))
        ));
    
    // 点击指定位置的项
    onView(withId(R.id.language_list))
        .perform(RecyclerViewActions.actionOnItemAtPosition(5, click()));
}
```

#### UI Automator

**跨应用测试**:
```java
@RunWith(AndroidJUnit4.class)
@SdkSuppress(minSdkVersion = 18)
public class CrossAppTest {
    
    private UiDevice device;
    
    @Before
    public void setUp() {
        device = UiDevice.getInstance(
            InstrumentationRegistry.getInstrumentation());
    }
    
    @Test
    public void testOpenSettings() throws UiObjectNotFoundException {
        // 启动Provision
        Context context = ApplicationProvider.getApplicationContext();
        Intent intent = context.getPackageManager()
            .getLaunchIntentForPackage("com.android.provision");
        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);
        context.startActivity(intent);
        
        device.wait(Until.hasObject(By.pkg("com.android.provision")), 5000);
        
        // 跳转到系统Settings
        UiObject settingsButton = device.findObject(
            new UiSelector().text("设置").className("android.widget.Button"));
        settingsButton.click();
        
        // 验证Settings打开
        device.wait(Until.hasObject(By.pkg("com.android.settings")), 5000);
        assertTrue(device.hasObject(By.pkg("com.android.settings")));
    }
}
```

#### 自动化测试

**测试套件**:
```java
@RunWith(Suite.class)
@Suite.SuiteClasses({
    LanguagePickerUITest.class,
    InputMethodUITest.class,
    TermsUITest.class,
    FingerprintUITest.class
})
public class ProvisionUITestSuite {
    // 测试套件
}
```

**运行自动化测试**:
```bash
# 运行所有UI测试
./gradlew connectedAndroidTest

# 运行指定测试类
./gradlew connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.android.provision.LanguagePickerUITest

# 运行指定测试方法
./gradlew connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.android.provision.LanguagePickerUITest#testSelectLanguage

# 查看测试报告
open app/build/reports/androidTests/connected/index.html
```

#### 回归测试

**回归测试策略**:
1. **冒烟测试**: 核心功能快速验证
2. **全量回归**: 所有测试用例执行
3. **选择性回归**: 变更影响的测试用例

**自动化回归**:
```yaml
# .github/workflows/regression-test.yml
name: Regression Test

on:
  pull_request:
    branches: [master, develop]

jobs:
  test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          
      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest
        
      - name: Run UI Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          script: ./gradlew connectedAndroidTest
          
      - name: Upload Test Reports
        uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: test-reports
          path: app/build/reports/
```

---

## 6.3 持续集成

### 6.3.1 CI/CD流程

#### 流程定义

**完整CI/CD流水线**:
```
代码提交 → 代码检查 → 单元测试 → 构建 → UI测试 → 代码分析 → 部署
```

**Jenkins Pipeline**:
```groovy
pipeline {
    agent any
    
    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/miui/provision.git'
            }
        }
        
        stage('Lint Check') {
            steps {
                sh './gradlew lint'
            }
        }
        
        stage('Unit Test') {
            steps {
                sh './gradlew testDebugUnitTest'
            }
        }
        
        stage('Build') {
            steps {
                sh './gradlew assembleDebug'
            }
        }
        
        stage('UI Test') {
            steps {
                sh './gradlew connectedAndroidTest'
            }
        }
        
        stage('Code Analysis') {
            steps {
                sh './gradlew sonarqube'
            }
        }
        
        stage('Archive') {
            steps {
                archiveArtifacts artifacts: 'app/build/outputs/**/*.apk'
            }
        }
    }
    
    post {
        always {
            junit 'app/build/test-results/**/*.xml'
            publishHTML([
                reportDir: 'app/build/reports/tests',
                reportFiles: 'index.html',
                reportName: 'Test Report'
            ])
        }
        
        failure {
            emailext(
                subject: "Build Failed: ${env.JOB_NAME}",
                body: "Build failed. Check console output.",
                to: 'team@example.com'
            )
        }
    }
}
```

### 6.3.2 自动化构建

**Gradle构建优化**:
```gradle
// gradle.properties
org.gradle.jvmargs=-Xmx4096m -Dfile.encoding=UTF-8
org.gradle.parallel=true
org.gradle.caching=true
org.gradle.configureondemand=true

android.enableJetifier=false
android.useAndroidX=true
```

**多渠道打包**:
```gradle
android {
    flavorDimensions 'deviceType', 'region'
    
    productFlavors {
        phone {
            dimension 'deviceType'
        }
        tablet {
            dimension 'deviceType'
        }
        cn {
            dimension 'region'
        }
        global {
            dimension 'region'
        }
    }
}
```

### 6.3.3 质量门禁

**质量标准**:
- ✅ 代码覆盖率 ≥ 80%
- ✅ 静态分析无高危问题
- ✅ 安全扫描无已知漏洞
- ✅ 性能测试满足SLA
- ✅ 所有测试用例通过

**门禁配置**:
```groovy
// 质量门禁检查
task qualityGate {
    doLast {
        // 检查覆盖率
        def coverage = getCoverageRate()
        if (coverage < 0.8) {
            throw new GradleException("Coverage ${coverage} < 80%")
        }
        
        // 检查Lint
        def lintErrors = getLintErrors()
        if (lintErrors > 0) {
            throw new GradleException("${lintErrors} lint errors found")
        }
        
        // 检查测试
        def testFailures = getTestFailures()
        if (testFailures > 0) {
            throw new GradleException("${testFailures} test failures")
        }
    }
}
```

---

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2025-10-17
- **最后更新**: 2025-10-17
- **文档状态**: 正式版
- **维护者**: MIUI开发团队
- **相关文档**:
  - [00-模块解析大纲.md](./00-模块解析大纲.md)
  - [05-性能优化.md](./05-性能优化.md)
  - [07-安全与合规.md](./07-安全与合规.md)

