---
layout: default
title: 9. 国际化与本地化 (Internationalization & Localization)
parent: 模块解析
---



# 9. 国际化与本地化 (Internationalization & Localization)

## 9.1 多语言支持

### 9.1.1 语言资源管理

**资源目录结构**:
```
res/
├── values/                    # 默认资源（英文）
│   ├── strings.xml
│   └── arrays.xml
├── values-zh-rCN/             # 简体中文
│   ├── strings.xml
│   └── arrays.xml
├── values-zh-rTW/             # 繁体中文
│   ├── strings.xml
│   └── arrays.xml
├── values-ja/                 # 日语
│   ├── strings.xml
│   └── arrays.xml
├── values-ko/                 # 韩语
│   ├── strings.xml
│   └── arrays.xml
├── values-ar/                 # 阿拉伯语（RTL）
│   ├── strings.xml
│   └── arrays.xml
└── values-hi/                 # 印地语
    ├── strings.xml
    └── arrays.xml
```

**字符串资源示例**:
```xml
<!-- values/strings.xml -->
<resources>
    <string name="app_name">Provision</string>
    <string name="language_picker_title">Choose your language</string>
    <string name="next">Next</string>
    <string name="terms_and_conditions">Terms and Conditions</string>
</resources>

<!-- values-zh-rCN/strings.xml -->
<resources>
    <string name="app_name">开机引导</string>
    <string name="language_picker_title">选择语言</string>
    <string name="next">下一步</string>
    <string name="terms_and_conditions">条款与条件</string>
</resources>
```

### 9.1.2 语言切换

**语言选择实现** (LanguagePickerFragment.java:357-383):
```java
private void setLanguage(int selectedPosition) {
    try {
        IActivityManager am = ActivityManagerNative.getDefault();
        Configuration config = am.getConfiguration();
        LocaleList locales = config.getLocales();
        Locale locale = mAdapter.getItem(selectedPosition).getLocale();
        
        boolean needChangeLocale;
        if(locales.size() == 1){
            Log.d(TAG, "old: "+locales.get(0).toString()+" select:" + locale.toString());
            needChangeLocale = !locales.get(0).equals(locale);
        }else {
            needChangeLocale = true;
        }
        
        Log.d(TAG, "needChangeLocal "+needChangeLocale);
        if(needChangeLocale){
            config.setLocale(locale);
            config.userSetLocale = true;
            am.updatePersistentConfiguration(config);
        }
        
        // 触发Settings Provider数据变更
        BackupManager.dataChanged("com.android.providers.settings");
    } catch (RemoteException e) {
        Log.e(TAG, "update default language failure", e);
    }
}
```

**国际版地区初始化** (LocalePickerFragment.java:290-301):
```java
private void setLocale(String locale) {
    PreferenceManager.getDefaultSharedPreferences(mActivity).edit()
        .putString(PREF_SELECTED_LOCALE, locale).apply();
    Log.v(TAG, "setLocale locale = " + locale);
    Utils.recordCountryCodeOnce(locale);
    
    // 初始化定制环境
    boolean suc = MiuiInit.initCustEnvironment(locale, mMiuiInitObserver);
    if (!suc) {
        Log.w(TAG, "involke initCustEnvironment failed");
    }
}
```

### 9.1.3 本地化工具

**本地化脚本** (localization_tools/ProvisionLocalization.py):
```python
#!/usr/bin/python3
# 功能：从源目录复制本地化字符串到目标目录
# 使用：python3 copy_string.py -s <源目录> -d <目标目录> -n <字符串名列表> -f <文件列表>

def add_or_update_strings_for_file_by_list(src_path, dst_path, key_list):
    """添加或更新指定的字符串"""
    src_dom_tree = parse(src_path)
    src_map = get_all_string_node_map(src_dom_tree.documentElement)
    
    # 检查是否需要创建目标文件
    for src_key in key_list:
        if src_key in src_map:
            if not os.path.exists(dst_path):
                create_empty_resource_xml(dst_path)
            break
    
    # 更新字符串
    dst_dom_tree = parse(dst_path)
    dst_map = get_all_string_node_map(dst_dom_tree.documentElement)
    need_write = False
    strings = ""
    delete_map = {}
    
    for src_key in key_list:
        if src_key in src_map:
            need_write = True
            strings = strings + "    " + html.unescape(src_map.get(src_key).toxml()) + "\n"
            if src_key in dst_map:
                delete_map[src_key] = dst_map.get(src_key).nodeName
    
    if need_write:
        append_or_delete_strings_for_file(dst_path, strings, delete_map)
```

---

## 9.2 地区适配

### 9.2.1 国内版与国际版

**构建配置差异** (app/build.gradle):
```gradle
productFlavors {
    // 设备类型维度
    phone { dimension 'deviceType' }
    tablet { dimension 'deviceType' }
    fold { dimension 'deviceType' }
    
    // 地区维度
    cn { dimension 'region' }      // 国内版
    global { dimension 'region' }  // 国际版
}

// 组合变体：phoneCn, phoneGlobal, tabletCn, tabletGlobal, foldCn, foldGlobal
```

**国际版特殊处理** (ProvisionApplication.java:45-47):
```java
if (Build.IS_INTERNATIONAL_BUILD) {
    MccHelper.getInstance().init(this);  // MCC（Mobile Country Code）辅助类
}
```

**MCC辅助类** (MccHelper.java):
```java
public class MccHelper {
    private static final String TAG = "MccHelper";
    private static MccHelper sInstance;
    private Context mContext;
    
    public static MccHelper getInstance() {
        if (sInstance == null) {
            synchronized (MccHelper.class) {
                if (sInstance == null) {
                    sInstance = new MccHelper();
                }
            }
        }
        return sInstance;
    }
    
    public void init(Context context) {
        mContext = context.getApplicationContext();
        // 根据MCC设置地区相关配置
        setupRegionConfig();
    }
    
    private void setupRegionConfig() {
        TelephonyManager tm = (TelephonyManager) mContext.getSystemService(Context.TELEPHONY_SERVICE);
        String mcc = tm.getSimCountryIso();
        Log.i(TAG, "MCC: " + mcc);
        
        // 根据MCC设置区域配置
        if ("cn".equalsIgnoreCase(mcc)) {
            // 中国大陆
            setupChinaMainland();
        } else if ("tw".equalsIgnoreCase(mcc)) {
            // 中国台湾
            setupTaiwan();
        } else if ("in".equalsIgnoreCase(mcc)) {
            // 印度
            setupIndia();
        }
        // ... 其他地区
    }
}
```

### 9.2.2 货币时区

**时区设置**:
```java
public class TimeZoneHelper {
    
    /**
     * 根据地区设置时区
     */
    public static void setupTimeZone(Context context, String countryCode) {
        TimeZone timeZone = getTimeZoneForCountry(countryCode);
        if (timeZone != null) {
            AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);
            alarmManager.setTimeZone(timeZone.getID());
            
            // 广播时区变更
            Intent intent = new Intent(Intent.ACTION_TIMEZONE_CHANGED);
            intent.putExtra("time-zone", timeZone.getID());
            context.sendBroadcastAsUser(intent, UserHandle.ALL);
        }
    }
    
    private static TimeZone getTimeZoneForCountry(String countryCode) {
        switch (countryCode.toUpperCase()) {
            case "CN": return TimeZone.getTimeZone("Asia/Shanghai");
            case "US": return TimeZone.getTimeZone("America/New_York");
            case "JP": return TimeZone.getTimeZone("Asia/Tokyo");
            case "GB": return TimeZone.getTimeZone("Europe/London");
            default: return TimeZone.getDefault();
        }
    }
}
```

**货币格式**:
```java
public class CurrencyHelper {
    
    /**
     * 格式化货币
     */
    public static String formatCurrency(double amount, Locale locale) {
        NumberFormat format = NumberFormat.getCurrencyInstance(locale);
        return format.format(amount);
    }
}

// 使用示例
String price = CurrencyHelper.formatCurrency(99.99, Locale.US);     // $99.99
String price = CurrencyHelper.formatCurrency(99.99, Locale.CHINA);  // ¥99.99
```

### 9.2.3 法律合规

**地区合规配置**:
```java
public class ComplianceHelper {
    
    /**
     * 检查是否需要GDPR合规
     */
    public static boolean requiresGDPR(Context context) {
        String countryCode = getCountryCode(context);
        // 欧盟成员国列表
        String[] euCountries = {"AT", "BE", "BG", "HR", "CY", "CZ", "DK", "EE", 
            "FI", "FR", "DE", "GR", "HU", "IE", "IT", "LV", "LT", "LU", "MT", 
            "NL", "PL", "PT", "RO", "SK", "SI", "ES", "SE"};
        
        return Arrays.asList(euCountries).contains(countryCode);
    }
    
    /**
     * 检查是否需要CCPA合规（加州消费者隐私法）
     */
    public static boolean requiresCCPA(Context context) {
        String stateCode = getStateCode(context);
        return "CA".equals(stateCode);  // California
    }
}
```

---

## 9.3 RTL支持

### 9.3.1 布局镜像

**RTL布局配置**:
```xml
<!-- AndroidManifest.xml -->
<application
    android:supportsRtl="true">
    ...
</application>
```

**RTL兼容布局**:
```xml
<!-- 使用start/end代替left/right -->
<LinearLayout
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:paddingStart="16dp"
    android:paddingEnd="16dp">
    
    <ImageView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginEnd="8dp" />
    
    <TextView
        android:layout_width="0dp"
        android:layout_height="wrap_content"
        android:layout_weight="1"
        android:textAlignment="viewStart" />
</LinearLayout>
```

### 9.3.2 文本方向

**代码中处理RTL**:
```java
public class RTLHelper {
    
    /**
     * 检查是否RTL布局
     */
    public static boolean isRTL(Context context) {
        Configuration config = context.getResources().getConfiguration();
        return config.getLayoutDirection() == View.LAYOUT_DIRECTION_RTL;
    }
    
    /**
     * 设置文本方向
     */
    public static void setTextDirection(TextView textView) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR1) {
            textView.setTextDirection(View.TEXT_DIRECTION_LOCALE);
        }
    }
}
```

### 9.3.3 图标镜像

**RTL资源配置**:
```
res/
├── drawable/
│   └── ic_arrow_forward.xml        # LTR图标（向右箭头）
├── drawable-ldrtl/
│   └── ic_arrow_forward.xml        # RTL图标（向左箭头）
```

**代码中镜像图标**:
```java
// 自动镜像
imageView.setImageResource(R.drawable.ic_arrow_forward);

// 手动控制镜像
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
    drawable.setAutoMirrored(true);
}
```

---

## 9.4 字体与排版

### 9.4.1 字体选择

**MiSans字体支持** (Utils.java):
```java
public static boolean isMiSansSupportLanguages() {
    String language = Locale.getDefault().getLanguage();
    // MiSans支持的语言
    return "zh".equals(language) ||  // 中文
           "en".equals(language) ||  // 英文
           "ja".equals(language) ||  // 日语
           "ko".equals(language);    // 韩语
}
```

**字体配置**:
```xml
<!-- res/values/styles.xml -->
<style name="AppTheme" parent="Theme.AppCompat">
    <item name="android:fontFamily">@font/mi_sans</item>
</style>

<!-- res/values-ar/styles.xml -->
<style name="AppTheme" parent="Theme.AppCompat">
    <item name="android:fontFamily">@font/noto_sans_arabic</item>
</style>
```

### 9.4.2 文本缩放

**支持系统字体缩放**:
```java
public class FontScaleHelper {
    
    /**
     * 获取字体缩放比例
     */
    public static float getFontScale(Context context) {
        return context.getResources().getConfiguration().fontScale;
    }
    
    /**
     * 限制字体最大缩放
     */
    public static void limitFontScale(Context context, float maxScale) {
        Configuration config = context.getResources().getConfiguration();
        if (config.fontScale > maxScale) {
            config.fontScale = maxScale;
            DisplayMetrics metrics = context.getResources().getDisplayMetrics();
            metrics.scaledDensity = metrics.density * config.fontScale;
            context.getResources().updateConfiguration(config, metrics);
        }
    }
}
```

### 9.4.3 排版优化

**文本排版规则**:
```xml
<!-- 中文排版 -->
<TextView
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:lineSpacingMultiplier="1.2"
    android:letterSpacing="0.05"
    android:textAlignment="viewStart" />

<!-- 阿拉伯文排版 -->
<TextView
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:lineSpacingMultiplier="1.5"
    android:textAlignment="viewEnd"
    android:textDirection="locale" />
```

---

## 9.5 国际化最佳实践

### 9.5.1 字符串资源

**规范**:
1. 所有用户可见文本必须使用字符串资源
2. 字符串名称使用小写+下划线
3. 使用占位符处理动态内容
4. 支持复数形式

```xml
<!-- 占位符 -->
<string name="welcome_message">Welcome, %s!</string>

<!-- 复数形式 -->
<plurals name="notification_count">
    <item quantity="one">You have %d notification</item>
    <item quantity="other">You have %d notifications</item>
</plurals>

<!-- 使用xliff命名空间标记不翻译内容 -->
<string name="app_version">Version <xliff:g id="version">%s</xliff:g></string>
```

### 9.5.2 格式化

**日期时间格式化**:
```java
// 使用Locale相关的格式化
DateFormat dateFormat = DateFormat.getDateInstance(DateFormat.LONG, locale);
String date = dateFormat.format(new Date());

// 中文：2025年10月17日
// 英文：October 17, 2025
```

**数字格式化**:
```java
NumberFormat numberFormat = NumberFormat.getNumberInstance(locale);
String number = numberFormat.format(1234567.89);

// 中文：1,234,567.89
// 德语：1.234.567,89
```

### 9.5.3 测试策略

**本地化测试**:
```java
@Test
public void testMultipleLocales() {
    Locale[] locales = {
        Locale.ENGLISH,
        Locale.SIMPLIFIED_CHINESE,
        Locale.TRADITIONAL_CHINESE,
        new Locale("ar"),  // 阿拉伯语
        new Locale("hi")   // 印地语
    };
    
    for (Locale locale : locales) {
        Locale.setDefault(locale);
        // 测试各语言下的功能
        testLanguageSelection();
        testTermsDisplay();
    }
}
```

**伪本地化测试**:
```xml
<!-- 使用伪本地化发现硬编码文本 -->
<!-- values-en-rXA/strings.xml -->
<resources>
    <string name="app_name">[Þŕöṽîšîöñ one two]</string>
</resources>
```

---

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2025-10-17
- **最后更新**: 2025-10-17
- **文档状态**: 正式版
- **维护者**: MIUI开发团队

