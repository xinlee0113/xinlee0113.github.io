---
layout: default
title: 字体设置逻辑分析
parent: 模块解析
---



# 字体设置逻辑分析

## 1. 概述

本文档分析MiuiProvisionAosp项目中两个关键的字体设置流程：
1. **GMS跳转字体设置（系统设置）的逻辑**
2. **MIUI开机引导里面字体设置页面的进入逻辑**

---

## 2. GMS跳转字体设置逻辑

### 2.1 整体流程

```
GMS SetupWizard
    ↓ (通过wizard_script.xml配置)
    ↓ action: com.android.setupwizard.OEM_POST_SETUP
    ↓
OemPostActivity
    ↓ (完成引导，发送广播)
    ↓
系统设置完成
```

### 2.2 Wizard Script配置机制

#### 配置文件位置
`res_gte_v34/raw/wizard_script.xml`

#### 关键配置点

```xml
<!-- MIUI自定义流程 -->
<WizardAction
    id="miui_second"
    wizard:uri="intent:#Intent;action=com.android.provision.global.SECOND;end">
    <result wizard:action="oem_post_setup"/>
</WizardAction>

<!-- OEM完成入口点 -->
<WizardAction id="oem_post_setup"
    wizard:uri="intent:#Intent;action=com.android.setupwizard.OEM_POST_SETUP;end" />
```

**逻辑说明**：
1. GMS完成所有标准流程（网络连接、账号登录、Google服务等）后
2. 通过`miui_second`调用MIUI自定义的第二阶段引导（`GlobalDefaultActivity`）
3. MIUI第二阶段完成后，触发`oem_post_setup`动作
4. 系统通过Intent Action `com.android.setupwizard.OEM_POST_SETUP`启动`OemPostActivity`

### 2.3 OemPostActivity接收处理

#### 文件位置
`src/com/android/provision/global/OemPostActivity.java`

#### AndroidManifest注册
```xml:210:214:global/AndroidManifest.xml
<activity android:name=".global.OemPostActivity"
          android:excludeFromRecents="true"
          android:screenOrientation="portrait"
          android:exported="true"
          android:configChanges="mcc|mnc|keyboardHidden|locale|layoutDirection|fontScale">
    <intent-filter>
        <action android:name="com.android.setupwizard.OEM_POST_SETUP" />
        <category android:name="android.intent.category.DEFAULT" />
    </intent-filter>
</activity>
```

#### 核心处理逻辑
```java:42:74:src/com/android/provision/global/OemPostActivity.java
@Override
protected void onCreate(Bundle savedInstanceState) {
    Log.d(TAG, "onCreate: ");
    super.onCreate(savedInstanceState);
    
    // 1. 检查运营商配置
    CspAutoSwitchManager.checkTailLandRing(getApplicationContext());
    
    // 2. 恢复状态栏和沉浸模式
    Utils.enableStatusBar(this, true);
    ImmersiveUtils.disableImmersion(this);
    
    // 3. 设置定时器
    setAlarm();
    
    // 4. 发送Provision完成广播
    Utils.sendProvisionCompleteBroadcast(this);
    
    // 5. 停止异常服务
    stopAbnormalService();
    
    // 6. 处理Trustonic支持
    if (MccHelper.getInstance().isSupportTrustonic(ProvisionApplication.getContext())){
        UserManagerHelper.getInstance().disableUserSpace(false);
    }
    
    // 7. 重试设置全局输入法
    if (!Utils.isCustSupportImeConfig(this)) {
        new InputMethodHelper(this).retrySetGlobalInputMethod();
    }
    
    // 8. 跳转到下一个页面（返回GMS）
    Utils.goToNextPage(this, getIntent(), RESULT_OK);
    
    // ... 省略其他逻辑
    
    // 9. 设置Provision完成标记
    Utils.setupProvisionComplete(this);
```

**关键点**：
- OemPostActivity是GMS引导流程的**最后一环**
- 不处理字体设置本身，而是完成系统配置和清理工作
- 字体设置发生在`miui_second`阶段（GlobalDefaultActivity）中

---

## 3. MIUI开机引导字体设置页面进入逻辑

### 3.1 整体流程架构

```
GlobalDefaultActivity (状态机管理器)
    ↓
StateMachine
    ↓ (状态流转)
    ↓
FontState
    ↓ (启动Activity)
    ↓
FontStyleActivity
    ↓ (加载Fragment)
    ↓
FontStyleFragment
    ↓ (用户操作)
    ↓
FontStyleUtils.setLocalFontId()
    ↓
系统字体应用
```

### 3.2 状态机定义（GlobalDefaultActivity）

#### 文件位置
`src/com/android/provision/global/GlobalDefaultActivity.java`

#### 状态机初始化
```java:889:1005:src/com/android/provision/global/GlobalDefaultActivity.java
private void init() {
    mStates = new SparseArray<StateInfo>();
    mStateStack = new ArrayList<State>();

    State accountState = State.create("AccountState");
    State cloudServiceState = State.create("CloudServiceState")
            .setPackageName("com.miui.cloudservice")
            .setClassName("com.miui.cloudservice.ui.ProvisionSettingActivity");
    State findDeviceState = State.create("FindDeviceState")
            .setPackageName("com.miui.cloudservice")
            .setClassName("com.miui.cloudservice.ui.FindDeviceSettingsActivity");
    State cloudBackupState = State.create("CloudBackupState")
            .setPackageName("com.miui.cloudbackup")
            .setClassName("com.miui.cloudbackup.ui.ProvisionRestoreActivity");
    State fingerprintState = State.create("FingerprintState").setTargetClass(FingerprintActivity.class);
    State otherState = State.create("OtherState").setTargetClass(OtherSettingsActivity.class);
    State parentalControlState = ParentalControlState.create();
    
    // 字体设置状态定义
    State fontState = State.create("FontState").setTargetClass(FontStyleActivity.class);
    
    State carouselState = State.create("CarouselState").setTargetClass(CarouselSettingActivity.class);
    State locationInState = State.create("LocationInState").setTargetClass(LocationInformationActivity.class);
    State homeState = State.create("HomeSettingsState").setTargetClass(HomeSettingsActivity.class);
    State themePickerState = State.create("ThemePickerState")
            .setPackageName("com.android.thememanager")
            .setClassName("com.android.thememanager.activity.ThemeProvisionActivity");
    State congratulationState = State.create("CongratulationState").setTargetClass(CongratulationActivity.class);

    // 状态流转链路
    addState(accountState);
    setNextState(accountState, cloudServiceState);
    
    addState(cloudServiceState);
    setNextState(cloudServiceState, findDeviceState);
    
    addState(findDeviceState);
    setNextState(findDeviceState, cloudBackupState);
    
    addState(cloudBackupState);
    setNextState(cloudBackupState, fingerprintState);
    
    addState(fingerprintState);
    setNextState(fingerprintState, otherState);
    
    addState(otherState);
    setNextState(otherState, parentalControlState);
    
    // 家长控制 → 字体设置
    addState(parentalControlState);
    setNextState(parentalControlState, fontState);
    
    // 字体设置 → 推荐内容
    addState(fontState);
    setNextState(fontState, carouselState);
    
    addState(carouselState);
    setNextState(carouselState, locationInState);
    
    addState(locationInState);
    setNextState(locationInState, homeState);
    
    addState(homeState);
    setNextState(homeState, themePickerState);
    
    addState(themePickerState);
    setNextState(themePickerState, recommendedState);
    
    // ... 后续状态
    
    mCompleteState = congratulationState;
    mCurrentState = accountState;
}
```

**完整状态流转序列**：
```
Account登录 
  → Cloud Service 
  → Find Device 
  → Cloud Backup 
  → Fingerprint 
  → Other Settings 
  → Parental Control 
  → **Font Settings**  ← 字体设置在此环节
  → Carousel 
  → Location Information 
  → Home Settings 
  → Theme Picker 
  → Recommended Apps 
  → Boot Video 
  → Gesture Tutorial 
  → Navigation Mode Picker 
  → Recent Task Style 
  → Congratulation
```

### 3.3 FontStyleActivity页面

#### 文件位置
`src/com/android/provision/activities/FontStyleActivity.java`

#### Activity定义
```java:11:49:src/com/android/provision/activities/FontStyleActivity.java
public class FontStyleActivity extends BaseActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        // 设置动画视图（Lottie动画）
        setAnimationView("font.json");
        // 设置副标题
        setSubTitle(R.string.font_settings_sub_title);
    }

    @Override
    protected Fragment getFragment() {
        return new FontStyleFragment();
    }

    @Override
    protected String getFragmentTag() {
        return FontStyleFragment.class.getSimpleName();
    }

    @Override
    protected int getLogoDrawableId() {
        return R.drawable.logo_other;
    }

    @Override
    protected int getTitleStringId() {
        return R.string.font_settings_title;  // "Font settings"
    }

    @Override
    protected CharSequence getListDescCharSequence() {
        return null;
    }

    @Override
    public boolean hasSubTitle() {
        return true;
    }
}
```

#### AndroidManifest注册
```xml:210:214:global/AndroidManifest.xml
<activity android:name=".activities.FontStyleActivity"
    android:excludeFromRecents="true"
    android:screenOrientation="portrait"
    android:configChanges="mcc|mnc|keyboardHidden|locale|layoutDirection|fontScale">
</activity>
```

**关键特性**：
- 继承自`BaseActivity`，统一处理标题、动画、返回按钮等UI框架
- 使用Lottie动画（`font.json`）作为页面装饰
- 主要业务逻辑在`FontStyleFragment`中实现

### 3.4 FontStyleFragment核心逻辑

#### 文件位置
`src/com/android/provision/fragment/FontStyleFragment.java`

#### 1) 字体选项初始化

```java:163:171:src/com/android/provision/fragment/FontStyleFragment.java
@Override
public void onActivityCreated(Bundle savedInstanceState) {
    super.onActivityCreated(savedInstanceState);
    ArrayList<FontInfo> fontList = new ArrayList<FontInfo>();
    // 默认字体（Roboto）
    fontList.add(new FontInfo(getResources().getString(R.string.default_font)));
    // 推荐字体（MiSans）
    fontList.add(new FontInfo(getResources().getString(R.string.recommend_font), 
                              getResources().getString(R.string.recommended_font_mark)));
    mAdapter = new FontAdapter(getActivity(), fontList);
    restoreSelectedFont();
    mRecyclerView.setAdapter(mAdapter);
}
```

#### 2) 获取可用字体列表

```java:354:390:src/com/android/provision/fragment/FontStyleFragment.java
/**
 * 获取字体列表
 */
public void getFonts(Context context) {
    ThreadUtils.postOnBackgroundThread(() -> {
        try {
            List<LocalFontModel> ret = getFontList(context);
            Log.i(TAG, " res.isEmpty ? " + ret.isEmpty());
            if (!ret.isEmpty()) {
                Message message = new Message();
                message.what = GET_FONTS;
                HashMap<String, Object> hashMap = new HashMap<>();
                hashMap.put("fontList", ret);
                message.obj = hashMap;
                mHander.sendMessage(message);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    });
}

/**
 * 获取字体列表，建议放在非主线程执行
 */
public static List<LocalFontModel> getFontList(Context context) {
    List<LocalFontModel> ret = new ArrayList<>();
    try {
        // 通过ContentProvider调用ThemeManager获取字体列表
        Bundle bundle = context.getContentResolver().call(
            Uri.parse(URI), 
            METHOD_GET_FONTS,  // "getFonts"
            null, 
            null
        );
        Log.i(TAG, " bundle is " + bundle);
        if (bundle == null) return ret;
        String resultJson = bundle.getString("result");
        Log.i(TAG, "getFonts json:" + resultJson);
        if (resultJson == null) return ret;
        ret = getFontsResult(resultJson);
    } catch (Exception e){
        e.printStackTrace();
    }
    return ret;
}
```

**说明**：
- 通过ContentProvider调用`com.android.thememanager.theme_provider`
- 调用方法`getFonts`获取本地可用字体列表
- 解析JSON格式的字体信息（包含fontId）

#### 3) 字体选择与预览

```java:252:264:src/com/android/provision/fragment/FontStyleFragment.java
itemView.setOnClickListener(v -> {
    if (!info.toString().equals(mSelectedFont)) {
        mSelectedFont = info.toString();
        // 选择字体后的逻辑
        if (TextUtils.equals(mSelectedFont, getResources().getString(R.string.default_font))) {
            mCurrentFontId = DEFAULT_FONT_ID;  // "10"
        } else {
            mCurrentFontId = MISANS_FONT_ID;  // 动态获取的MiSans字体ID
        }
        setFontCheckState();
        notifyDataSetChanged();
    }
});
```

```java:291:314:src/com/android/provision/fragment/FontStyleFragment.java
private void setFontCheckState(){
    setTextViewFont(mUseCaseTitle, MEDIUM);
    setTextViewFont(mUseCaseText, REGULAR);
    setTextViewFont(mUseCaseNumber, REGULAR);
    setTextViewFont(mUseCaseSymbol, REGULAR);
}

private void setTextViewFont(TextView textView, int weight) {
    Typeface typeface = null;
    if (mCurrentFontId != null && !mCurrentFontId.equals(DEFAULT_FONT_ID)) {
        Log.i(TAG, " set misans");
        // 1.当前是MiSans
        if (typeface == null) {
            typeface = FontWeightUtils.getVarTypeface(weight, FONT_TYPE);
        }
    } else {
        Log.i(TAG, " set roboto");
        // 2.当前是Roboto
        if (typeface == null) {
            typeface = FontWeightUtils.getVarTypeface(weight, ROBOTO_REGULAR);
        }
    }
    textView.setTypeface(typeface);
}
```

**预览机制**：
- 页面上方显示字体预览区域（包含标题、正文、数字、符号）
- 用户点击字体选项时，立即更新预览区域的字体样式
- 使用`FontWeightUtils.getVarTypeface()`动态加载字体

#### 4) 应用字体设置

```java:172:191:src/com/android/provision/fragment/FontStyleFragment.java
private View.OnClickListener mNextClickListener = new View.OnClickListener() {

    @Override
    public void onClick(View v) {
        Log.i(TAG, " in mNextClickListener and mCurrentFontId is " + mCurrentFontId);
        if (mCurrentFontId != null && !mCurrentFontId.equals(DEFAULT_FONT_ID)) {
            Log.i(TAG, " MISANS_FONT_ID is " + MISANS_FONT_ID);
            // 应用MiSans字体
            FontStyleUtils.setLocalFontId(ProvisionApplication.getContext(), MISANS_FONT_ID);
        } else {
            // 应用默认字体（Roboto）
            FontStyleUtils.setLocalFontId(ProvisionApplication.getContext(), DEFAULT_FONT_ID);
        }
        DefaultPreferenceHelper.setFirstSetFont(false);
        handleNext();
    }
};

private void handleNext() {
    getActivity().setResult(android.app.Activity.RESULT_OK);
    getActivity().finish();
}
```

### 3.5 FontStyleUtils工具类

#### 文件位置
`src/com/android/provision/utils/FontStyleUtils.java`

#### 核心方法

```java:25:57:src/com/android/provision/utils/FontStyleUtils.java
/**
 * 应用全局字体
 */
public static void applyFont(final Context context, final String fontId) {
    ThreadUtils.postOnBackgroundThread(() -> {
        final boolean[] result = {false};
        Bundle extras = new Bundle();
        extras.putString("fontId", fontId);
        try {
            // 通过ContentProvider调用ThemeManager应用字体
            Bundle bundle = context.getContentResolver().call(
                Uri.parse(URI),  // "content://com.android.thememanager.theme_provider"
                METHOD_APPLY_FONT,  // "applyFont"
                null, 
                extras
            );
            Log.i(TAG, " bundle is " + bundle);
            result[0] = bundle.getBoolean("applyResult");
            Log.i(TAG, " result[0] is " + result[0]);
            DefaultPreferenceHelper.setFirstSetFont(false);
        } catch (Exception e) {
            result[0] = false;
            e.printStackTrace();
        }
    });
}

public static String getLocalFontId(Context context) {
    SharedPreferences sharedPreferences = context.getSharedPreferences(LOCAL_FONT_SP, Context.MODE_PRIVATE);
    return sharedPreferences.getString(CURRENT_FONT_ID, DEFAULT_FONT_ID);
}

public static void setLocalFontId(Context context, String currentId) {
    SharedPreferences sharedPreferences = context.getSharedPreferences(LOCAL_FONT_SP, Context.MODE_PRIVATE);
    SharedPreferences.Editor editor = sharedPreferences.edit();
    editor.putString(CURRENT_FONT_ID, currentId);
    editor.apply();
}
```

**关键机制**：
- 通过`ContentProvider`与系统主题管理器（ThemeManager）通信
- `applyFont()`方法负责实际应用字体到系统
- 字体ID存储在SharedPreferences中（`LOCAL_FONT_SP`）

---

## 4. 技术架构总结

### 4.1 状态机模式

GlobalDefaultActivity采用**状态机模式**管理整个引导流程：

```java
class StateMachine {
    private State mCurrentState;          // 当前状态
    private ArrayList<State> mStateStack; // 状态栈（支持返回）
    private State mCompleteState;         // 完成状态
    
    // 状态流转核心方法
    void transitToNextState()     // 前进到下一状态
    void transitToPreviousState() // 返回到上一状态
    void transitToOthers()        // 跳转到指定状态
}
```

**优势**：
- 解耦各个引导页面，每个State独立管理
- 灵活控制流程顺序和可用性（通过`isAvailable()`）
- 支持返回操作，维护状态栈

### 4.2 ContentProvider跨进程通信

字体设置通过ContentProvider与ThemeManager通信：

```
MiuiProvision (client)
    ↓ ContentResolver.call()
    ↓ content://com.android.thememanager.theme_provider
    ↓
ThemeManager (server)
    ↓ 处理字体应用逻辑
    ↓ 修改系统字体配置
    ↓
System Server
    ↓ 更新Configuration
    ↓
All Apps
```

**优势**：
- 进程隔离，Provision不需要直接操作系统字体
- ThemeManager集中管理字体资源和应用逻辑
- 通过Bundle传递参数和结果

### 4.3 字体预览机制

使用`FontWeightUtils`和`Typeface`实现动态字体预览：

```java
// 获取可变字体（支持不同字重）
Typeface typeface = FontWeightUtils.getVarTypeface(weight, fontType);
textView.setTypeface(typeface);
```

**实现原理**：
- 支持Variable Fonts（可变字体）技术
- 通过`Folme.FontType.MIUI`指定MIUI自定义字体类型
- 实时切换不同字重（MEDIUM=380, REGULAR=330）

---

## 5. 关键配置文件

### 5.1 字符串资源

```xml:529:536:res/values/strings.xml
<string name="font_use_case_text_example">Body</string>
<string name="font_use_case_symbol_example">&quot;\@ # % &amp; * () _ + - =&quot;</string>
<string name="recommend_font">MiSans</string>
<string name="font_settings_title">Font settings</string>
<string name="recommended_font_mark">Recommended</string>
<string name="font_use_case_number_example"><xliff:g id="number_1" refersto="1">%1$d</xliff:g> ...</string>
<string name="font_settings_sub_title">Select system font</string>
<string name="select_font_modele_tips" product="default">You can always select a new font in Themes</string>
```

### 5.2 布局文件

`res/layout/fragment_font_style.xml`
- 字体预览区域（ll_title_content）
- 字体列表区域（font_lyt_content, recyclerView）
- 适配不同设备（xun、spark、flare等折叠屏设备）

### 5.3 动画资源

`assets/font.json`
- Lottie动画格式
- 展示字体"A"图标和圆形背景动画效果

---

## 6. 流程时序图

### 6.1 GMS到MIUI流程

```
┌─────────────┐      ┌───────────────┐      ┌──────────────┐      ┌─────────────────┐
│ GMS         │      │ wizard_script │      │ Global       │      │ OemPost         │
│ SetupWizard │      │               │      │ DefaultAct   │      │ Activity        │
└──────┬──────┘      └───────┬───────┘      └──────┬───────┘      └────────┬────────┘
       │                     │                     │                       │
       │  1. GMS流程完成      │                     │                       │
       ├─────────────────────>│                     │                       │
       │                     │  2. miui_second     │                       │
       │                     ├─────────────────────>│                       │
       │                     │                     │  3. 字体设置等流程     │
       │                     │                     │◄──────────────────────┤
       │                     │                     │                       │
       │                     │  4. oem_post_setup  │                       │
       │                     ├─────────────────────┼──────────────────────>│
       │                     │                     │                       │
       │                     │                     │  5. 发送Provision完成  │
       │                     │                     │         广播           │
       │◄────────────────────┴─────────────────────┴───────────────────────┤
       │  6. 返回GMS继续流程  │                     │                       │
       │                     │                     │                       │
```

### 6.2 字体设置页面内部流程

```
┌────────────┐     ┌─────────────┐     ┌─────────────┐     ┌──────────────┐
│ State      │     │ FontStyle   │     │ FontStyle   │     │ FontStyle    │
│ Machine    │     │ Activity    │     │ Fragment    │     │ Utils        │
└─────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬───────┘
      │                   │                   │                   │
      │ 1. transitToNextState()              │                   │
      │   (fontState)     │                   │                   │
      ├───────────────────>│                   │                   │
      │                   │ 2. onCreate()     │                   │
      │                   │   setAnimationView()                  │
      │                   ├───────────────────>│                   │
      │                   │                   │ 3. getFonts()     │
      │                   │                   ├───────────────────>│
      │                   │                   │                   │
      │                   │                   │ 4. 返回字体列表    │
      │                   │                   │◄───────────────────┤
      │                   │                   │                   │
      │                   │                   │ 5. 显示字体列表    │
      │                   │                   │   (Default + MiSans)
      │                   │                   │                   │
      │                   │                   │ 6. 用户点击选择    │
      │                   │                   │◄───────────────────┤
      │                   │                   │                   │
      │                   │                   │ 7. 实时预览字体    │
      │                   │                   │   setFontCheckState()
      │                   │                   │                   │
      │                   │                   │ 8. 点击Next按钮    │
      │                   │                   │◄───────────────────┤
      │                   │                   │                   │
      │                   │                   │ 9. setLocalFontId()
      │                   │                   ├───────────────────>│
      │                   │                   │                   │
      │                   │                   │ 10. 保存到SP      │
      │                   │                   │   (下次生效)       │
      │                   │                   │◄───────────────────┤
      │                   │                   │                   │
      │                   │ 11. finish()      │                   │
      │                   │◄──────────────────┤                   │
      │                   │                   │                   │
      │ 12. onActivityResult()               │                   │
      │     transitToNextState()             │                   │
      │     (下一个State)  │                   │                   │
      │                   │                   │                   │
```

---

## 7. 注意事项与限制

### 7.1 字体应用时机

当前实现中，字体选择**仅保存到SharedPreferences**，并未立即调用`FontStyleUtils.applyFont()`：

```java:177:182:src/com/android/provision/fragment/FontStyleFragment.java
if (mCurrentFontId != null && !mCurrentFontId.equals(DEFAULT_FONT_ID)) {
    Log.i(TAG, " MISANS_FONT_ID is " + MISANS_FONT_ID);
    FontStyleUtils.setLocalFontId(ProvisionApplication.getContext(), MISANS_FONT_ID);
} else {
    FontStyleUtils.setLocalFontId(ProvisionApplication.getContext(), DEFAULT_FONT_ID);
}
```

**原因推测**：
- 避免在引导过程中重启应用（应用字体需要重启）
- 在引导完成后统一应用所有设置
- 可能在其他地方（如OemPostActivity或系统启动时）读取并应用

### 7.2 字体来源限制

目前仅支持两种字体：
1. **Default Font (Roboto)** - 字体ID: "10"
2. **MiSans** - 字体ID: 动态获取（通过ThemeManager获取）

不支持用户自定义字体或下载字体。

### 7.3 设备适配

代码中针对特定设备做了UI适配：

```java:105:160:src/com/android/provision/fragment/FontStyleFragment.java
String device = SystemProperties.get("ro.product.device", "UNKNOWN");
boolean isXun = "xun".equals(device);
boolean isSpark = "spark".equals(device);
boolean isFlare = "flare".equals(device);
boolean isTabletLand = OobeUtil.isTabletLand(getActivity().getApplicationContext());

if (isXun && isTabletLand) {
    // xun设备横屏模式的尺寸调整
    llContent.getLayoutParams().width = (int) (screenWidth * 0.41f);
    llContent.getLayoutParams().height = (int) (screenHeight * 0.23f);
    // ...
}

if ((isSpark || isFlare) && isTabletLand) {
    // spark/flare设备横屏模式的尺寸调整
    llContent.getLayoutParams().height = (int) (screenHeight * 0.21f);
    // ...
}
```

**适配设备**：
- `xun` - 折叠屏设备
- `spark` - 平板设备
- `flare` - 平板设备

---

## 8. 相关文件清单

### 核心Java文件
```
src/com/android/provision/
├── global/
│   ├── GlobalDefaultActivity.java         # 状态机管理器
│   └── OemPostActivity.java                # GMS回调入口
├── activities/
│   └── FontStyleActivity.java              # 字体设置Activity
├── fragment/
│   └── FontStyleFragment.java              # 字体设置Fragment
└── utils/
    ├── FontStyleUtils.java                 # 字体工具类
    ├── FontWeightUtils.java                # 字体字重工具
    └── FontModel2JsonUtils.java            # 字体模型JSON转换
```

### 资源文件
```
res/
├── layout/
│   ├── fragment_font_style.xml             # 字体设置页面布局
│   └── font_list_item_view.xml             # 字体列表项布局
├── values/
│   ├── strings.xml                         # 字符串资源
│   └── dimens.xml                          # 尺寸资源
└── drawable/
    └── logo_other.webp                     # 页面Logo

assets/
└── font.json                               # Lottie动画配置

res_gte_v34/raw/
└── wizard_script.xml                       # GMS引导流程配置
```

### 配置文件
```
global/
└── AndroidManifest.xml                     # 全局版本Manifest

AndroidManifest.xml                         # 主Manifest
```

---

## 9. 总结

### GMS跳转逻辑核心
1. GMS通过`wizard_script.xml`配置文件驱动整个引导流程
2. `miui_second`动作触发MIUI自定义引导（包含字体设置）
3. `oem_post_setup`动作触发OemPostActivity完成引导

### MIUI字体设置逻辑核心
1. 采用状态机模式管理引导流程，字体设置是其中一个State
2. FontStyleActivity/Fragment负责UI展示和用户交互
3. FontStyleUtils通过ContentProvider与ThemeManager通信
4. 字体选择结果保存到SharedPreferences，后续统一应用

### 技术亮点
- **状态机模式**：灵活管理复杂引导流程
- **ContentProvider通信**：跨进程字体管理
- **实时预览**：Variable Fonts技术支持字体预览
- **设备适配**：针对折叠屏和平板设备优化UI

### 改进建议
1. 考虑在字体选择时立即应用（提升用户体验）
2. 支持更多字体选项（如Google Fonts）
3. 增加字体大小调节功能（当前仅支持字体样式）
4. 添加更详细的日志和错误处理机制


