---
layout: default
title: 开机引导界面跳转路线梳理
parent: 开机引导模块
grand_parent: 模块解析
---

# 开机引导界面跳转路线梳理

##  概述

基于代码分析，MIUI开机引导流程主要分为两个版本：
- **新版本引导流程** (`isNewGlobalOOBE()` = true)：国际版 + SDK >= 24
- **旧版本引导流程** (`isNewGlobalOOBE()` = false)：国内版或SDK < 24

##  主要流程分支

### 1. 新版本引导流程 (NewGlobalOOBE)

**条件**: `miui.os.Build.IS_INTERNATIONAL_BUILD && miui.os.Build.VERSION.SDK_INT >= 24`

#### 简化流程路径：
```
StartupState (启动页)
    ↓
LanguageState (语言选择)
    ↓
LocalePickerState (地区选择)
    ↓
ZonePickerState (时区选择)
    ↓
InputMethodState (输入法设置)
    ↓
TermsState (服务条款)
    ↓
TermsAndStatementState (条款声明)
    ↓
[支持MiMover] OtherState (基础设置)
    ↓
[支持MiMover] PrivacyCenterState (隐私中心)
    ↓
[支持MiMover] MiMoverState (数据迁移)
    ↓
ActivationState (激活)
    ↓
ActivateDeviceState (设备激活)
    ↓
[直接跳转到最终步骤]
    ↓
RecentTaskStyleState (最近任务样式)
    ↓
[折叠屏设备] KindTipState (温馨提示)
    ↓
RecommendedState (推荐应用)
    ↓
BootVideoState (开机视频)
    ↓
[完成引导]
```

### 2. 旧版本引导流程 (传统流程)

**条件**: `!isNewGlobalOOBE()`

#### 完整流程路径：
```
StartupState (启动页)
    ↓
LanguageState (语言选择)
    ↓
LocalePickerState (地区选择)
    ↓
ZonePickerState (时区选择)
    ↓
InputMethodState (输入法设置)
    ↓
WifiSetting (WiFi设置)
    ↓
FontSize (字体大小)
    ↓
TermsState (服务条款)
    ↓
TermsAndStatementState (条款声明)
    ↓
[支持MiMover] OtherState (基础设置)
    ↓
[支持MiMover] PrivacyCenterState (隐私中心)
    ↓
[支持MiMover] MiMoverState (数据迁移)
    ↓
ActivationState (激活)
    ↓
ActivateDeviceState (设备激活)
    ↓
MultiSimSettingsState (多卡设置)
    ↓
GoogleAccountState (Google账户)
    ↓
AccountState (小米账户)
    ↓
CloudBackupState (云备份)
    ↓
CloudServiceState (云服务)
    ↓
FindDeviceState (查找设备)
    ↓
FingerprintState (指纹设置)
    ↓
AIButtonState (AI按键)
    ↓
VoiceAssistState (语音助手)
    ↓
GestureTutorialState (手势教程)
    ↓
[支持MiMover] CMTermsState (CM条款)
    ↓
[不支持MiMover] OtherState (其他设置)
    ↓
[不支持MiMover] PrivacyCenterState (隐私中心)
    ↓
[不支持MiMover] CMTermsState (CM条款)
    ↓
CUTermsState (CU条款)
    ↓
ThemePickerState (主题选择)
    ↓
NavigationModePickerState (导航模式)
    ↓
RecentTaskStyleState (最近任务样式)
    ↓
[折叠屏设备] KindTipState (温馨提示)
    ↓
RecommendedState (推荐应用)
    ↓
BootVideoState (开机视频)
    ↓
[完成引导]
```

##  关键条件判断

### 1. 设备类型判断
- **折叠屏设备**: `Utils.isFlipDevice()` - 会额外显示KindTipState
- **平板设备**: `Utils.isTabletDevice()` - 影响某些界面显示
- **企业版设备**: `miui.enterprise.EnterpriseManagerStub.ENTERPRISE_ACTIVATED` - 简化流程

### 2. 功能支持判断
- **MiMover支持**: `Utils.supportMiMover(mContext)` - 影响数据迁移流程的显示
- **eSIM支持**: `Utils.isSupportEsimMode()` - 影响SIM卡相关流程
- **Google服务**: `Utils.isGoogleCoopeModels()` - 影响Google相关界面

### 3. 地区版本判断
- **国际版**: `miui.os.Build.IS_INTERNATIONAL_BUILD` - 决定是否使用新版本流程
- **国内版**: 使用完整的旧版本流程

### 4. 关键跳转逻辑

#### 条款后的跳转逻辑
```java
// 代码位置: DefaultActivity.java 第2265-2300行
if (Utils.supportMiMover(mContext)) {
    // 支持MiMover的情况
    setNextState(termsAndStatement, otherState);  // 条款 → 基础设置
    addState(otherState);
    setNextState(otherState, PrivacyCenterState);  // 基础设置 → 隐私中心
    addState(PrivacyCenterState);
    setNextState(PrivacyCenterState, miMoverState);  // 隐私中心 → 数据迁移
    addState(miMoverState);
    setNextState(miMoverState, activationState);  // 数据迁移 → 激活
} else {
    // 不支持MiMover的情况
    setNextState(termsAndStatement, activationState);  // 条款 → 激活
}
```

#### 新版本流程的WiFi设置
```java
// 代码位置: DefaultActivity.java 第2240-2251行
if (Utils.isNewGlobalOOBE()) {
    setNextState(inputMethodState, termsState);  // 输入法 → 条款 (跳过WiFi)
} else {
    setNextState(inputMethodState, wifiSetting);  // 输入法 → WiFi设置
    addState(wifiSetting);
    setNextState(wifiSetting, fontSize);  // WiFi → 字体大小
    addState(fontSize);
    setNextState(fontSize, termsState);  // 字体大小 → 条款
}
```

##  状态机机制

### StateMachine核心方法
- `transitToNext()`: 前进到下一个状态
- `transitToPrevious()`: 后退到上一个状态
- `getNextAvailableState()`: 获取下一个可用状态
- `isAvailable()`: 检查状态是否可用

### 状态跳转控制
- **RESULT_OK**: 前进到下一个状态
- **RESULT_CANCELED**: 后退到上一个状态
- **其他结果码**: 跳转到其他状态

##  特殊界面说明

### 1. StartupState (启动页)
- 初始状态，显示MIUI Logo
- 检查设备是否已完成引导
- 初始化各种服务和权限

### 2. LanguageState (语言选择)
- 支持多语言选择
- 影响后续界面的显示语言

### 3. OtherState (基础设置)
- **Activity**: `OtherSettingsActivity`
- **Fragment**: `OtherSettingsFragment`
- **功能**: 位置服务、用户体验、质量服务、闹钟、上传调试日志等基础设置
- **动画**: 使用`basic_settings.json`动画

### 4. MiMoverState (数据迁移)
- **Package**: `com.miui.huanji`
- **Activity**: `com.miui.huanji.provision.ui.ProvisionCTAActivity`
- **功能**: 换机数据迁移，检测周围设备进行极速激活
- **条件**: 需要`Utils.supportMiMover(mContext)`返回true

### 5. ActivationState (激活)
- **Package**: `com.android.updater`
- **Activity**: `com.android.updater.ActivationActivity`
- **功能**: 设备激活流程

### 6. ActivateDeviceState (设备激活)
- **Package**: `com.miui.cloudservice`
- **Activity**: `com.miui.cloudservice.ui.ActivateDeviceActivity`
- **功能**: 小米账户绑定和设备激活

### 7. RecommendedState (推荐应用)
- 根据地区和配置显示推荐应用
- 支持IronSource、Mi Apps等
- 根据`DefaultPreferenceHelper.getRecommendedOperation()`决定操作类型

### 8. BootVideoState (开机视频)
- 播放开机引导视频
- 引导流程的最后一个界面

##  流程优化点

### 新版本流程优势
1. **简化步骤**: 减少不必要的设置界面
2. **提升体验**: 快速完成基本配置
3. **减少摩擦**: 降低用户流失率

### 条件判断优化
1. **设备适配**: 根据设备类型调整流程
2. **功能检测**: 动态显示支持的功能
3. **地区适配**: 根据地区显示相应内容

##  流程统计

| 流程版本 | 界面数量 | 主要特点 | 关键差异 |
|---------|---------|---------|---------|
| **新版本流程** | ~12个 | 简化快速，跳过WiFi和字体设置 | 条款后直接进入基础设置→数据迁移 |
| **旧版本流程** | ~25个 | 完整详细，包含WiFi和字体设置 | 条款后进入完整的小米生态设置 |

### 关键流程对比

| 步骤 | 新版本流程 | 旧版本流程 |
|------|-----------|-----------|
| 语言选择后 | 地区选择 | 地区选择 |
| 输入法后 | **直接条款** | **WiFi设置 → 字体大小 → 条款** |
| 条款后 | **基础设置 → 数据迁移 → 激活** | **基础设置 → 数据迁移 → 激活** |
| 设备激活后 | **直接最终步骤** | **多卡设置 → Google账户 → 小米账户 → 云备份 → 云服务 → 查找设备 → 指纹 → AI按键 → 语音助手 → 手势教程 → 其他设置 → 隐私中心 → CM条款 → CU条款 → 主题选择 → 导航模式** |

##  调试建议

1. **日志跟踪**: 关注StateMachine的transitToNext日志
2. **状态检查**: 使用isAvailable()检查状态可用性
3. **条件验证**: 确认各种条件判断的正确性
4. **设备测试**: 在不同设备类型上测试流程

##  代码分析总结

### 核心跳转逻辑
基于`DefaultActivity.java`的`StateMachine.init()`方法分析：

1. **语言选择后的流程**：
   - 语言 → 地区 → 时区 → 输入法
   - 这是两个版本共同的起始流程

2. **输入法后的分支**：
   - **新版本**：输入法 → 条款（跳过WiFi和字体）
   - **旧版本**：输入法 → WiFi → 字体 → 条款

3. **条款后的分支**：
   - **支持MiMover**：条款 → 基础设置 → 隐私中心 → 数据迁移 → 激活
   - **不支持MiMover**：条款 → 激活

4. **设备激活后的分支**：
   - **新版本**：设备激活 → 直接跳转到最终步骤
   - **旧版本**：设备激活 → 完整的小米生态设置流程

### 关键代码位置
- **状态机初始化**: `DefaultActivity.java` 第2125-2383行
- **新版本判断**: `Utils.java` 第888-890行
- **MiMover支持**: `DefaultActivity.java` 第2265-2300行
- **条款后跳转**: `DefaultActivity.java` 第2265-2300行

---

*此文档完全基于当前代码分析生成，准确反映了MIUI开机引导的实际跳转逻辑*
