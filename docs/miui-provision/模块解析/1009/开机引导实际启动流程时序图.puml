@startuml 开机引导实际启动流程时序图

!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title 开机引导实际启动流程时序图\n基于ADB抓取数据分析

participant "ADB Shell" as ADB
participant "ActivityManager" as AM
participant "DefaultActivity" as DA
participant "ProvisionSettingActivity" as PSA
participant "WindowManager" as WM
participant "SurfaceFlinger" as SF

== ADB启动命令 ==
ADB -> AM: am start -W -n com.android.provision/.activities.DefaultActivity
note right: 启动时间: TotalTime=123ms\nWaitTime=129ms\nLaunchState=WARM

== ActivityManager处理 ==
AM -> AM: 检查应用状态
AM -> AM: 创建Task{23b2e25 #63}
note right: Task类型: home\n非可调整大小
AM -> DA: 启动DefaultActivity
AM -> AM: 记录ActivityRecord{218951562}

== DefaultActivity启动 ==
DA -> DA: onCreate()
DA -> DA: 检查deviceIsProvisioned()
DA -> DA: 初始化StateMachine
DA -> DA: 启动PreLoadManager
DA -> DA: 发送PROVISION_START_BROADCAST

== 状态机初始化 ==
DA -> DA: StateMachine.init()
DA -> DA: 添加所有状态
DA -> DA: 设置状态转换关系
DA -> DA: 启动startupState

== 启动页面显示 ==
DA -> DA: 显示StartupFragment
DA -> DA: 显示MIUI Logo
DA -> DA: 播放启动动画
note right: 使用startup.json动画

== 用户交互 ==
DA -> DA: 用户点击下一步
DA -> DA: run(RESULT_OK)
DA -> DA: transitToNext()

== 语言选择页面 ==
DA -> DA: 启动LanguagePickerActivity
DA -> DA: 显示语言选择界面
DA -> DA: 用户选择语言
DA -> DA: run(RESULT_OK)

== 地区选择页面 ==
DA -> DA: transitToNext()
DA -> DA: 启动LocalePickerActivity
DA -> DA: 显示地区选择界面
DA -> DA: 用户选择地区
DA -> DA: run(RESULT_OK)

== 时区选择页面 ==
DA -> DA: transitToNext()
DA -> DA: 启动ZonePickerActivity
DA -> DA: 显示时区选择界面
DA -> DA: 用户选择时区
DA -> DA: run(RESULT_OK)

== 输入法设置页面 ==
DA -> DA: transitToNext()
DA -> DA: 启动InputMethodActivity
DA -> DA: 显示输入法选择界面
DA -> DA: 用户选择输入法
DA -> DA: run(RESULT_OK)

== 条件分支判断 ==
DA -> DA: 检查Utils.isNewGlobalOOBE()
alt 新版本流程
    DA -> DA: 直接跳转到条款页面
    note right: 跳过WiFi和字体设置
else 旧版本流程
    DA -> DA: 启动WiFi设置页面
    DA -> DA: 用户连接WiFi
    DA -> DA: run(RESULT_OK)
    DA -> DA: 启动字体大小设置
    DA -> DA: 用户选择字体大小
    DA -> DA: run(RESULT_OK)
end

== 服务条款页面 ==
DA -> DA: 启动TermsActivity
DA -> DA: 显示服务条款界面
DA -> DA: 用户同意条款
DA -> DA: run(RESULT_OK)

== 条款声明页面 ==
DA -> DA: transitToNext()
DA -> DA: 启动TermsAndStatementActivity
DA -> DA: 显示条款声明界面
DA -> DA: 用户确认声明
DA -> DA: run(RESULT_OK)

== MiMover支持检查 ==
DA -> DA: 检查Utils.supportMiMover()
alt 支持MiMover
    DA -> DA: 启动OtherSettingsActivity
    DA -> DA: 用户完成基础设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动PrivacyCenterActivity
    DA -> DA: 用户完成隐私设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动MiMoverActivity
    DA -> DA: 用户完成数据迁移
    DA -> DA: run(RESULT_OK)
else 不支持MiMover
    DA -> DA: 直接跳转到激活页面
end

== 设备激活页面 ==
DA -> DA: 启动ActivationActivity
DA -> DA: 显示设备激活界面
DA -> DA: 用户完成激活
DA -> DA: run(RESULT_OK)

== 小米账户激活 ==
DA -> DA: 启动ActivateDeviceActivity
DA -> PSA: 启动ProvisionSettingActivity
note right: 当前显示: ProvisionSettingActivity\n状态: RESUMED\nTask: 23b2e25

== WindowManager处理 ==
PSA -> WM: 创建Window{6733ba8}
WM -> WM: 设置窗口属性
WM -> WM: 设置窗口大小
note right: 窗口大小: 1220x2712\nDPI: 520

== SurfaceFlinger处理 ==
WM -> SF: 创建Surface
SF -> SF: 设置Surface属性
SF -> SF: 开始渲染
note right: Surface名称: com.miui.cloudservice/\ncom.miui.cloudservice.ui.ProvisionSettingActivity

== 窗口动画 ==
WM -> WM: 开始窗口动画
WM -> WM: 设置动画属性
WM -> WM: 执行动画
note right: 动画类型: OPEN\n动画时间: 约150ms

== 焦点管理 ==
WM -> WM: 设置窗口焦点
WM -> WM: 更新焦点状态
note right: 当前焦点: Window{6733ba8}\nProvisionSettingActivity

== 用户交互 ==
PSA -> PSA: 显示账户绑定界面
PSA -> PSA: 用户登录账户
PSA -> PSA: 完成账户绑定
PSA -> DA: 返回激活结果
DA -> DA: run(RESULT_OK)

== 流程分支判断 ==
DA -> DA: 检查Utils.isNewGlobalOOBE()
alt 新版本流程
    DA -> DA: 直接跳转到最终步骤
    note right: 跳过详细设置
else 旧版本流程
    DA -> DA: 启动多卡设置
    DA -> DA: 用户完成SIM卡设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动Google账户设置
    DA -> DA: 用户完成Google设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动小米账户设置
    DA -> DA: 用户完成小米设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动云备份设置
    DA -> DA: 用户完成备份设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动云服务设置
    DA -> DA: 用户完成云服务设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动查找设备设置
    DA -> DA: 用户完成查找设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动指纹设置
    DA -> DA: 用户完成指纹设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动AI按键设置
    DA -> DA: 用户完成AI设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动语音助手设置
    DA -> DA: 用户完成语音设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动手势教程
    DA -> DA: 用户完成手势学习
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动其他设置
    DA -> DA: 用户完成其他设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动隐私中心
    DA -> DA: 用户完成隐私设置
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动CM条款
    DA -> DA: 用户同意CM条款
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动CU条款
    DA -> DA: 用户同意CU条款
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动主题选择
    DA -> DA: 用户选择主题
    DA -> DA: run(RESULT_OK)
    
    DA -> DA: 启动导航模式选择
    DA -> DA: 用户选择导航模式
    DA -> DA: run(RESULT_OK)
end

== 最终步骤 ==
DA -> DA: 启动RecentTaskStyleActivity
DA -> DA: 用户选择任务样式
DA -> DA: run(RESULT_OK)

alt 折叠屏设备
    DA -> DA: 启动KindTipActivity
    DA -> DA: 用户查看提示信息
    DA -> DA: run(RESULT_OK)
end

DA -> DA: 启动RecommendedActivity
DA -> DA: 用户选择推荐应用
DA -> DA: run(RESULT_OK)

DA -> DA: 启动BootVideoActivity
DA -> DA: 播放开机引导视频
DA -> DA: 视频播放完成
DA -> DA: run(RESULT_OK)

== 引导完成 ==
DA -> DA: transitToNext()
DA -> DA: 检查是否为完成状态
DA -> DA: 设置设备为已配置状态
DA -> DA: 发送PROVISION_COMPLETE_BROADCAST
DA -> DA: 启动OemPostActivity
DA -> DA: 完成引导流程
note right: 引导流程完成\n设备可正常使用

== 内存使用情况 ==
note over DA: 内存使用情况:\n总内存: 147,592 KB (PSS)\nNative Heap: 57,620 KB\nJava Heap: 20,876 KB\nGraphics: 11,624 KB\nActivities: 4个实例

@enduml

