---
layout: default
title: 4. 核心功能模块 (Core Features)
parent: MiuiProvision项目文档
---

# 4. 核心功能模块 (Core Features)

## 4.1 启动流程管理

### 4.1.1 状态机实现

#### StateMachine核心架构

**类定义**:
```java
// DefaultActivity.java第1900行
public static class StateMachine {
    private Context mContext;                      // 上下文
    private SparseArray<StateInfo> mStates;        // 状态注册表
    private State mCurrentState;                   // 当前状态
    private ArrayList<State> mStateStack;          // 状态栈(支持回退)
    
    public class StateInfo {
        private State current;  // 当前状态
        private State next;     // 下一个状态
    }
    
    public StateMachine(Context context) {
        mContext = context;
        init();  // 初始化状态机
        PreLoadManager.get().setCompleteDefaultActivityLoad();
    }
}
```

#### 状态定义

**State抽象基类**:
```java
public abstract class State {
    protected StateMachine mStateMachine;
    protected Context context;
    protected String packageName;
    protected String className;
    protected Class<?> targetClass;
    
    /**
     * 状态进入时调用
     * @param canGoBack 是否可以返回
     * @param toNext 是否向前
     */
    public abstract void onEnter(boolean canGoBack, boolean toNext);
    
    /**
     * 状态离开时调用
     */
    public abstract void onLeave();
    
    /**
     * 判断状态是否可用
     * @param toNext 是否向前
     * @return true表示可用
     */
    public abstract boolean isAvailable(boolean toNext);
    
    /**
     * 判断是否可以返回到此状态
     */
    public abstract boolean canBackTo();
    
    /**
     * 获取Intent
     */
    public abstract Intent getIntent();
}
```

**具体State实现列表**:
1. **StartupState**: 启动欢迎页 (第605行)
2. **LanguagePickerState**: 语言选择
3. **InputMethodState**: 输入法选择
4. **WiFiState**: WiFi配置
5. **FontSizeState**: 字体大小
6. **TermsState**: 条款同意
7. **MultiSimSettingsState**: 双卡设置
8. **GoogleAccountState**: Google账号
9. **AccountState**: 小米账号
10. **CloudBackupState**: 云备份
11. **CloudServiceState**: 云服务
12. **FindDeviceState**: 查找设备
13. **FingerprintState**: 指纹录入
14. **AIButtonState**: AI按钮
15. **VoiceAssistState**: 语音助手
16. **GestureTutorialState**: 手势教程
17. **CMTermsState**: 移动条款
18. **CUTermsState**: 联通条款
19. **ThemePickerState**: 主题选择
20. **NavigationModePickerState**: 导航方式
21. **RecentTaskStyleState**: 最近任务样式
22. **KindTipState**: 提示页
23. **RecommendedState**: 推荐应用
24. **BootVideoState**: 启动视频

#### 状态转换逻辑

**状态机初始化** (init方法，第2089行):
```java
private void init() {
    mStates = new SparseArray<>();
    mStateStack = new ArrayList<>();
    
    // 创建所有状态对象
    StartupState startupState = new StartupState();
    LanguagePickerState languagePickerState = new LanguagePickerState();
    InputMethodState inputMethodState = new InputMethodState();
    WiFiState wifiSetting = new WiFiState();
    FontSizeState fontSize = new FontSizeState();
    TermsAndStatementState termsAndStatement = new TermsAndStatementState();
    // ... 创建20+个State对象
    
    // 构建状态转换链
    addState(startupState);
    setNextState(startupState, languagePickerState);
    
    addState(languagePickerState);
    setNextState(languagePickerState, inputMethodState);
    
    addState(inputMethodState);
    // 根据版本选择不同的流程
    if (Utils.isNewGlobalOOBE()) {
        // 新版本流程：跳过WiFi和字体
        setNextState(inputMethodState, termsAndStatement);
    } else {
        // 旧版本流程：包含WiFi和字体
        setNextState(inputMethodState, wifiSetting);
        setNextState(wifiSetting, fontSize);
        setNextState(fontSize, termsAndStatement);
    }
    
    // 设置当前状态为StartupState
    mCurrentState = startupState;
}
```

**状态添加方法**:
```java
private void addState(State state) {
    state.setStateMachine(this);  // 设置状态机引用
    StateInfo stateInfo = new StateInfo(state);
    mStates.put(state.getClass().hashCode(), stateInfo);  // 注册状态
    PreLoadManager.get().addDefaultActivityClass(state);  // 预加载配置
}
```

**设置下一状态**:
```java
private void setNextState(State current, State next) {
    StateInfo stateInfo = mStates.get(current.getClass().hashCode());
    if (stateInfo != null) {
        stateInfo.next = next;
    }
}
```

#### 状态转换执行

**向前转换 (transitToNext)**:
```java
public void transitToNext() {
    // 离开当前状态
    mCurrentState.onLeave();
    
    // 将当前状态压入栈
    if (mCurrentState.canBackTo()) {
        mStateStack.add(mCurrentState);
    }
    
    // 查找下一个可用状态
    State nextState = getNextAvailableState(mCurrentState);
    if (nextState != null) {
        mCurrentState = nextState;
        int top = mStateStack.size() - 1;
        boolean canGoBack = top >= 0 && mStateStack.get(top).canBackTo();
        mCurrentState.onEnter(canGoBack, true);
        saveState();  // 保存状态到SharedPreferences
    } else {
        // 所有状态完成，结束引导
        finishSetup(true);
    }
}
```

**向后转换 (transitToPrevious)**:
```java
public void transitToPrevious() {
    mCurrentState.onLeave();
    
    if (!mStateStack.isEmpty()) {
        // 从栈中弹出上一个状态
        State prevState = mStateStack.remove(mStateStack.size() - 1);
        mCurrentState = prevState;
        
        int top = mStateStack.size() - 1;
        boolean canGoBack = top >= 0 && mStateStack.get(top).canBackTo();
        mCurrentState.onEnter(canGoBack, false);
        saveState();
    }
}
```

**获取下一个可用状态**:
```java
private State getNextAvailableState(State current) {
    StateInfo stateInfo = mStates.get(current.getClass().hashCode());
    if (stateInfo == null || stateInfo.next == null) {
        return null;
    }
    
    State next = stateInfo.next;
    // 检查状态是否可用
    while (next != null && !next.isAvailable(true)) {
        // 跳过不可用的状态，继续查找下一个
        StateInfo nextInfo = mStates.get(next.getClass().hashCode());
        if (nextInfo == null || nextInfo.next == null) {
            break;
        }
        next = nextInfo.next;
    }
    
    return (next != null && next.isAvailable(true)) ? next : null;
}
```

#### 状态持久化

**保存状态**:
```java
private void saveState() {
    SharedPreferences prefs = mContext.getSharedPreferences(
        "provision_state", Context.MODE_PRIVATE);
    prefs.edit()
        .putString("current_state", mCurrentState.getClass().getName())
        .putInt("stack_size", mStateStack.size())
        .apply();
}
```

**恢复状态**:
```java
private void restoreState() {
    SharedPreferences prefs = mContext.getSharedPreferences(
        "provision_state", Context.MODE_PRIVATE);
    String stateName = prefs.getString("current_state", null);
    
    if (stateName != null) {
        // 恢复到上次的状态
        StateInfo stateInfo = getStateInfo(stateName);
        if (stateInfo != null) {
            mCurrentState = stateInfo.current;
        }
    }
}
```

---

### 4.1.2 流程编排

#### 流程定义

**国内版完整流程** (不含MiMover):
```
StartupState (欢迎页)
  ↓
LanguagePickerState (语言选择)
  ↓
InputMethodState (输入法)
  ↓
WiFiState (WiFi配置) [新版本跳过]
  ↓
FontSizeState (字体大小) [新版本跳过]
  ↓
TermsAndStatementState (条款)
  ↓
OtherSettingsState (其他设置)
  ↓
PrivacyCenterState (隐私中心)
  ↓
ActivateDeviceState (激活设备)
  ↓
MultiSimSettingsState (双卡设置)
  ↓
GoogleAccountState (Google账号)
  ↓
AccountState (小米账号)
  ↓
CloudBackupState (云备份)
  ↓
CloudServiceState (云服务)
  ↓
FindDeviceState (查找设备)
  ↓
FingerprintState (指纹)
  ↓
AIButtonState (AI按钮)
  ↓
VoiceAssistState (语音助手)
  ↓
GestureTutorialState (手势教程)
  ↓
CMTermsState (移动条款)
  ↓
CUTermsState (联通条款)
  ↓
ThemePickerState (主题)
  ↓
NavigationModePickerState (导航方式)
  ↓
RecentTaskStyleState (最近任务)
  ↓
KindTipState (提示) [仅折叠屏]
  ↓
RecommendedState (推荐应用)
  ↓
BootVideoState (启动视频)
  ↓
Finish (完成引导)
```

#### 条件分支

**版本分支**:
```java
// 第2282行
if (Utils.isNewGlobalOOBE()) {
    // 新版本流程：省略WiFi和字体
    setNextState(inputMethodState, termsState);
} else {
    // 旧版本流程：包含完整步骤
    setNextState(inputMethodState, wifiSetting);
    setNextState(wifiSetting, fontSize);
    setNextState(fontSize, termsState);
}
```

**MiMover分支**:
```java
// 第2313行
if (Utils.supportMiMover(mContext)) {
    setNextState(gestureTutorialState, cmTermsState);
} else {
    setNextState(gestureTutorialState, otherState);
    addState(otherState);
    setNextState(otherState, PrivacyCenterState);
    addState(PrivacyCenterState);
    setNextState(PrivacyCenterState, cmTermsState);
}
```

**折叠屏分支**:
```java
// 第2338行
if (Utils.isFlipDevice()) {
    setNextState(recentTaskStyleState, kindtipState);
    addState(kindtipState);
    setNextState(kindtipState, recommendedState);
} else {
    setNextState(recentTaskStyleState, recommendedState);
}
```

#### 并行处理

**预加载并行**:
```java
// 在状态转换时，同时触发预加载
public void transitToNext() {
    // ... 状态转换逻辑
    
    // 并行触发预加载
    if (nextState != null && nextState.targetClass != null) {
        PreLoadManager.get().run(nextState.targetClass);
    }
}
```

#### 异常重试

**网络异常重试**:
```java
public class WiFiState extends State {
    private int retryCount = 0;
    private static final int MAX_RETRY = 3;
    
    @Override
    public void onEnter(boolean canGoBack, boolean toNext) {
        if (!NetworkUtils.isWifiConnected(context)) {
            if (retryCount < MAX_RETRY) {
                retryCount++;
                // 重试WiFi连接
                retryWifiConnection();
            } else {
                // 超过重试次数，跳过WiFi设置
                mStateMachine.transitToNext();
            }
        }
    }
}
```

---

### 4.1.3 异常处理

#### 异常捕获

**State异常捕获**:
```java
public abstract class State {
    public void onEnter(boolean canGoBack, boolean toNext) {
        try {
            if (isAvailable(toNext)) {
                Intent intent = getIntent();
                context.startActivityForResult(intent, REQUEST_CODE);
            } else {
                // 状态不可用，跳过
                mStateMachine.transitToNext();
            }
        } catch (Exception e) {
            Log.e(TAG, "State onEnter error: " + e.getMessage());
            handleException(e);
        }
    }
    
    protected void handleException(Exception e) {
        // 默认异常处理：跳过当前状态
        mStateMachine.transitToNext();
    }
}
```

#### 异常恢复

**状态恢复机制**:
```java
@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    
    if (deviceIsProvisioned()) {
        // 已完成引导，直接退出
        finishSetup(false);
        return;
    }
    
    mStateMachine = new StateMachine(this);
    
    // 从savedInstanceState恢复状态
    boolean enterCurrent = (savedInstanceState == null || 
        savedInstanceState.getBoolean(STATE_ENTER_CURRENTSTATE, true));
    
    mStateMachine.start(enterCurrent);
}

@Override
protected void onSaveInstanceState(Bundle outState) {
    super.onSaveInstanceState(outState);
    // 保存状态
    outState.putBoolean(STATE_ENTER_CURRENTSTATE, mEnterCurrent);
}
```

**异常返回监控**:
```java
// AbnormalBackService.java
public class AbnormalBackService extends Service {
    private int mAbnormalBackCount = 0;
    private static final int MAX_ABNORMAL_COUNT = 5;
    
    public void onBackPressed() {
        mAbnormalBackCount++;
        
        if (mAbnormalBackCount >= MAX_ABNORMAL_COUNT) {
            // 异常返回次数过多，提示用户
            showAbnormalDialog();
            mAbnormalBackCount = 0;
        }
    }
    
    private void showAbnormalDialog() {
        // 显示异常提示对话框
        AlertDialog dialog = new AlertDialog.Builder(context)
            .setTitle("提示")
            .setMessage("检测到您连续多次返回，是否需要跳过当前设置？")
            .setPositiveButton("跳过", (d, w) -> {
                // 跳过当前状态
                mStateMachine.transitToNext();
            })
            .setNegativeButton("继续", null)
            .create();
        dialog.show();
    }
}
```

#### 用户提示

**错误提示**:
```java
private void showErrorToast(String message) {
    Toast.makeText(context, message, Toast.LENGTH_SHORT).show();
}

private void showErrorDialog(String title, String message) {
    new AlertDialog.Builder(context)
        .setTitle(title)
        .setMessage(message)
        .setPositiveButton("确定", null)
        .show();
}
```

#### 日志记录

**状态转换日志**:
```java
private static final String TAG = "Provision_StateMachine";

public void transitToNext() {
    Log.i(TAG, "transitToNext: current=" + mCurrentState.getClass().getSimpleName());
    
    mCurrentState.onLeave();
    State nextState = getNextAvailableState(mCurrentState);
    
    if (nextState != null) {
        Log.i(TAG, "transitToNext: next=" + nextState.getClass().getSimpleName());
        mCurrentState = nextState;
        mCurrentState.onEnter(canGoBack, true);
    } else {
        Log.i(TAG, "transitToNext: no more states, finishing");
        finishSetup(true);
    }
}
```

---

## 4.2 用户界面层

### 4.2.1 Activity生命周期

#### 生命周期管理

**DefaultActivity生命周期**:
```java
public class DefaultActivity extends ProvisionBaseActivity {
    
    @Override
    protected void onCreate(Bundle icicle) {
        super.onCreate(icicle);
        Log.d(TAG, "DefaultActivity onCreate");
        
        // 检查是否已完成引导
        if (deviceIsProvisioned()) {
            finishSetup(false);
            return;
        }
        
        // 初始化状态机
        mStateMachine = new StateMachine(this);
        mStateMachine.start(enterCurrent);
        
        // 启动服务
        startService(new Intent(this, AbnormalBackService.class));
        
        // 注册网络监听
        registerNetworkChangedReceiver();
    }
    
    @Override
    protected void onStart() {
        super.onStart();
        Log.d(TAG, "onStart");
    }
    
    @Override
    protected void onResume() {
        super.onResume();
        Log.d(TAG, "onResume");
    }
    
    @Override
    protected void onPause() {
        super.onPause();
        Log.d(TAG, "onPause");
    }
    
    @Override
    protected void onStop() {
        super.onStop();
        Log.d(TAG, "onStop");
    }
    
    @Override
    protected void onDestroy() {
        super.onDestroy();
        Log.d(TAG, "onDestroy");
        
        // 注销网络监听
        unregisterNetworkChangedReceiver();
        
        // 清理资源
        if (mStateMachine != null) {
            mStateMachine.cleanup();
        }
    }
}
```

#### 状态保存与恢复

**onSaveInstanceState**:
```java
@Override
protected void onSaveInstanceState(Bundle outState) {
    super.onSaveInstanceState(outState);
    
    // 保存当前状态
    if (mStateMachine != null && mStateMachine.getCurrentState() != null) {
        outState.putString("current_state", 
            mStateMachine.getCurrentState().getClass().getName());
    }
    
    // 保存是否进入当前状态
    outState.putBoolean(STATE_ENTER_CURRENTSTATE, mEnterCurrent);
    
    // 保存其他数据
    outState.putInt("esim_code", eSimeCode);
    outState.putInt("mimover_direct", MiMoverDirect);
}
```

**onRestoreInstanceState**:
```java
@Override
protected void onRestoreInstanceState(Bundle savedInstanceState) {
    super.onRestoreInstanceState(savedInstanceState);
    
    // 恢复状态
    String stateName = savedInstanceState.getString("current_state");
    boolean enterCurrent = savedInstanceState.getBoolean(STATE_ENTER_CURRENTSTATE, true);
    
    // 恢复其他数据
    eSimeCode = savedInstanceState.getInt("esim_code", Utils.THERE_IS_NO_ESIM_CARD_SB);
    MiMoverDirect = savedInstanceState.getInt("mimover_direct", Utils.MI_MOVER_AS_NEW_DEVICE);
}
```

#### 配置变更处理

**处理横竖屏切换**:
```java
@Override
public void onConfigurationChanged(@NonNull Configuration newConfig) {
    super.onConfigurationChanged(newConfig);
    Log.d(TAG, "onConfigurationChanged: " + newConfig);
    
    // 通知PreLoadManager配置变更
    PreLoadManager.get().onConfigurationChange(newConfig);
    
    // 更新UI
    updateUIForConfiguration(newConfig);
}
```

**AndroidManifest.xml配置**:
```xml
<activity
    android:name=".activities.DefaultActivity"
    android:configChanges="orientation|screenSize|keyboardHidden|locale"
    android:theme="@style/ProvisionTheme">
    <!-- 不会因为配置变更而重建Activity -->
</activity>
```

#### 内存优化

**onTrimMemory**:
```java
@Override
public void onTrimMemory(int level) {
    super.onTrimMemory(level);
    
    switch (level) {
        case TRIM_MEMORY_RUNNING_LOW:
            // 内存不足，清理缓存
            PreLoadManager.get().clearCache();
            break;
            
        case TRIM_MEMORY_RUNNING_CRITICAL:
            // 内存严重不足，清理所有缓存
            PreLoadManager.get().clearAllCache();
            MediaPlayerPool.get().releaseAll();
            break;
    }
}
```

---

### 4.2.2 Fragment管理

#### Fragment生命周期

**StartupFragment生命周期**:
```java
public class StartupFragment extends BaseFragment {
    
    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        Log.d(TAG, "onCreate");
    }
    
    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        Log.d(TAG, "onCreateView");
        
        // 使用PreLoadManager加载布局
        View view = PreLoadManager.inflate(inflater, R.layout.startup_fragment, container);
        initView(view);
        return view;
    }
    
    @Override
    public void onViewCreated(View view, Bundle savedInstanceState) {
        super.onViewCreated(view, savedInstanceState);
        Log.d(TAG, "onViewCreated");
        
        initData();
        showWelcomeAnimation();
    }
    
    @Override
    public void onDestroyView() {
        super.onDestroyView();
        Log.d(TAG, "onDestroyView");
        
        // 清理资源
        stopAnimation();
    }
    
    @Override
    public void onDestroy() {
        super.onDestroy();
        Log.d(TAG, "onDestroy");
    }
}
```

#### Fragment通信

**Fragment与Activity通信**:
```java
public class LanguagePickerFragment extends BaseFragment {
    
    private OnLanguageSelectedListener mListener;
    
    public interface OnLanguageSelectedListener {
        void onLanguageSelected(String languageCode);
    }
    
    @Override
    public void onAttach(Context context) {
        super.onAttach(context);
        if (context instanceof OnLanguageSelectedListener) {
            mListener = (OnLanguageSelectedListener) context;
        }
    }
    
    private void selectLanguage(String languageCode) {
        if (mListener != null) {
            mListener.onLanguageSelected(languageCode);
        }
    }
}
```

**通过ViewModel通信**:
```java
// 使用ViewModel共享数据
public class ProvisionViewModel extends ViewModel {
    private MutableLiveData<String> selectedLanguage = new MutableLiveData<>();
    
    public void setSelectedLanguage(String language) {
        selectedLanguage.setValue(language);
    }
    
    public LiveData<String> getSelectedLanguage() {
        return selectedLanguage;
    }
}

// Activity中获取ViewModel
ProvisionViewModel viewModel = new ViewModelProvider(this).get(ProvisionViewModel.class);
viewModel.getSelectedLanguage().observe(this, language -> {
    // 处理语言变更
});
```

#### Fragment回退栈

**添加到回退栈**:
```java
FragmentTransaction transaction = getSupportFragmentManager().beginTransaction();
transaction.replace(R.id.fragment_container, new LanguagePickerFragment());
transaction.addToBackStack("language");  // 添加到回退栈
transaction.commit();
```

**管理回退栈**:
```java
// 弹出回退栈
getSupportFragmentManager().popBackStack();

// 弹出到指定Fragment
getSupportFragmentManager().popBackStack("language", 
    FragmentManager.POP_BACK_STACK_INCLUSIVE);

// 清空回退栈
getSupportFragmentManager().popBackStack(null, 
    FragmentManager.POP_BACK_STACK_INCLUSIVE);
```

#### Fragment事务

**StartupFragment事务示例**:
```java
// DefaultActivity.java第628行
private void buildStartupFragment(Fragment fragment, FragmentManager fragmentManager) {
    FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();
    
    // 替换Fragment
    fragmentTransaction.replace(android.R.id.content, fragment, 
        StartupFragment.class.getSimpleName());
    
    // 允许状态丢失提交
    fragmentTransaction.commitAllowingStateLoss();
}
```

**事务动画**:
```java
FragmentTransaction transaction = getSupportFragmentManager().beginTransaction();
transaction.setCustomAnimations(
    R.anim.slide_in_right,   // enter
    R.anim.slide_out_left,   // exit
    R.anim.slide_in_left,    // popEnter
    R.anim.slide_out_right   // popExit
);
transaction.replace(R.id.fragment_container, new InputMethodFragment());
transaction.commit();
```

---

### 4.2.3 视图绑定

#### ViewBinding

**使用ViewBinding**:
```java
public class LanguagePickerFragment extends BaseFragment {
    private LanguagePageLayoutBinding mBinding;
    
    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {
        mBinding = LanguagePageLayoutBinding.inflate(inflater, container, false);
        return mBinding.getRoot();
    }
    
    private void initView() {
        // 类型安全的视图访问
        mBinding.recyclerView.setLayoutManager(new LinearLayoutManager(getContext()));
        mBinding.confirmButton.setOnClickListener(v -> onConfirm());
        mBinding.titleText.setText(R.string.select_language);
    }
    
    @Override
    public void onDestroyView() {
        super.onDestroyView();
        mBinding = null;  // 避免内存泄漏
    }
}
```

#### findViewById替代

**传统方式 vs ViewBinding**:
```java
// 传统方式
TextView titleText = findViewById(R.id.title_text);
Button confirmButton = findViewById(R.id.confirm_button);
RecyclerView recyclerView = findViewById(R.id.recycler_view);

// ViewBinding方式
mBinding.titleText.setText("...");
mBinding.confirmButton.setOnClickListener(...);
mBinding.recyclerView.setAdapter(...);
```

#### 视图复用

**ViewHolder模式**:
```java
public class LanguageAdapter extends RecyclerView.Adapter<LanguageViewHolder> {
    
    @Override
    public LanguageViewHolder onCreateViewHolder(ViewGroup parent, int viewType) {
        View view = LayoutInflater.from(parent.getContext())
            .inflate(R.layout.item_language, parent, false);
        return new LanguageViewHolder(view);
    }
    
    @Override
    public void onBindViewHolder(LanguageViewHolder holder, int position) {
        Language language = mLanguages.get(position);
        holder.bind(language);
    }
    
    static class LanguageViewHolder extends RecyclerView.ViewHolder {
        private TextView nameText;
        private ImageView checkIcon;
        
        public LanguageViewHolder(View itemView) {
            super(itemView);
            nameText = itemView.findViewById(R.id.name_text);
            checkIcon = itemView.findViewById(R.id.check_icon);
        }
        
        public void bind(Language language) {
            nameText.setText(language.getDisplayName());
            checkIcon.setVisibility(language.isSelected() ? View.VISIBLE : View.GONE);
        }
    }
}
```

#### 性能优化

**布局优化**:
```java
// 使用ViewStub延迟加载
ViewStub stub = findViewById(R.id.viewStub);
if (needLoad) {
    View inflated = stub.inflate();
    // 使用inflated
}

// 使用merge减少层级
<merge xmlns:android="http://schemas.android.com/apk/res/android">
    <TextView ... />
    <Button ... />
</merge>

// 使用ConstraintLayout减少嵌套
<androidx.constraintlayout.widget.ConstraintLayout>
    <!-- 扁平化布局 -->
</androidx.constraintlayout.widget.ConstraintLayout>
```

---

## 4.3 业务逻辑层

### 4.3.1 业务规则

#### 规则定义

**State可用性规则**:
```java
// FontState可用性规则
public class FontState extends State {
    @Override
    public boolean isAvailable(boolean toNext) {
        // 规则1: 支持MiSans字体
        boolean supportMiSans = Utils.isMiSansSupportLanguages();
        
        // 规则2: 字体列表只有2个
        List<FontInfo> fonts = FontStyleFragment.getFontList(context);
        boolean twoFonts = (fonts != null && fonts.size() == 2);
        
        // 规则3: 不是折叠设备
        boolean notFold = !Utils.isFoldDevice();
        
        // 规则4: 不在Provision状态
        boolean notInProvision = !Utils.isInProvisionState(context);
        
        // 所有规则都满足才可用
        return supportMiSans && twoFonts && notFold && notInProvision;
    }
}
```

**MiMover规则**:
```java
public static boolean supportMiMover(Context context) {
    // 规则1: 设备支持MiMover功能
    boolean featureSupport = FeatureParser.getBoolean("support_mimover", true);
    
    // 规则2: 不是国际版
    boolean notInternational = !Build.IS_INTERNATIONAL_BUILD;
    
    // 规则3: 系统版本满足要求
    boolean versionOk = Build.VERSION.SDK_INT >= Build.VERSION_CODES.N;
    
    return featureSupport && notInternational && versionOk;
}
```

#### 规则引擎

**规则链条**:
```java
public interface Rule {
    boolean evaluate(Context context);
}

public class RuleChain {
    private List<Rule> rules = new ArrayList<>();
    
    public RuleChain addRule(Rule rule) {
        rules.add(rule);
        return this;
    }
    
    public boolean evaluateAnd(Context context) {
        // 所有规则都满足
        for (Rule rule : rules) {
            if (!rule.evaluate(context)) {
                return false;
            }
        }
        return true;
    }
    
    public boolean evaluateOr(Context context) {
        // 任一规则满足
        for (Rule rule : rules) {
            if (rule.evaluate(context)) {
                return true;
            }
        }
        return false;
    }
}

// 使用规则链
RuleChain chain = new RuleChain()
    .addRule(ctx -> Utils.isTabletDevice())
    .addRule(ctx -> NetworkUtils.isWifiConnected(ctx))
    .addRule(ctx -> !Utils.isInternationalBuild());

boolean result = chain.evaluateAnd(context);
```

#### 规则验证

**输入验证规则**:
```java
public class ValidationRules {
    
    /**
     * 验证WiFi SSID
     */
    public static boolean isValidSSID(String ssid) {
        if (TextUtils.isEmpty(ssid)) {
            return false;
        }
        // SSID长度限制
        if (ssid.length() > 32) {
            return false;
        }
        // 特殊字符检查
        return ssid.matches("[\\w\\s-]+");
    }
    
    /**
     * 验证WiFi密码
     */
    public static boolean isValidPassword(String password) {
        if (TextUtils.isEmpty(password)) {
            return false;
        }
        // 密码长度8-63
        return password.length() >= 8 && password.length() <= 63;
    }
    
    /**
     * 验证小米账号
     */
    public static boolean isValidMiAccount(String account) {
        if (TextUtils.isEmpty(account)) {
            return false;
        }
        // 邮箱或手机号
        return android.util.Patterns.EMAIL_ADDRESS.matcher(account).matches()
            || android.util.Patterns.PHONE.matcher(account).matches();
    }
}
```

#### 规则扩展

**规则配置化**:
```json
// rules.json
{
  "font_state_rules": {
    "enabled": true,
    "conditions": [
      {"type": "feature", "key": "support_misans", "value": true},
      {"type": "device", "key": "is_fold", "value": false},
      {"type": "font_count", "value": 2}
    ],
    "logic": "AND"
  },
  "mimover_rules": {
    "enabled": true,
    "conditions": [
      {"type": "feature", "key": "support_mimover", "value": true},
      {"type": "build", "key": "is_international", "value": false}
    ],
    "logic": "AND"
  }
}
```

---

### 4.3.2 数据验证

#### 输入验证

**表单输入验证**:
```java
public class FormValidator {
    
    public static class ValidationResult {
        public boolean isValid;
        public String errorMessage;
        
        public static ValidationResult success() {
            ValidationResult result = new ValidationResult();
            result.isValid = true;
            return result;
        }
        
        public static ValidationResult error(String message) {
            ValidationResult result = new ValidationResult();
            result.isValid = false;
            result.errorMessage = message;
            return result;
        }
    }
    
    /**
     * 验证WiFi配置
     */
    public static ValidationResult validateWiFiConfig(String ssid, String password) {
        if (TextUtils.isEmpty(ssid)) {
            return ValidationResult.error("SSID不能为空");
        }
        
        if (ssid.length() > 32) {
            return ValidationResult.error("SSID长度不能超过32个字符");
        }
        
        if (!TextUtils.isEmpty(password)) {
            if (password.length() < 8) {
                return ValidationResult.error("密码长度至少8个字符");
            }
            if (password.length() > 63) {
                return ValidationResult.error("密码长度不能超过63个字符");
            }
        }
        
        return ValidationResult.success();
    }
}
```

#### 业务验证

**账号登录验证**:
```java
public class AccountValidator {
    
    /**
     * 验证小米账号登录
     */
    public static ValidationResult validateLogin(String account, String password) {
        // 账号格式验证
        if (TextUtils.isEmpty(account)) {
            return ValidationResult.error("账号不能为空");
        }
        
        if (!isValidMiAccount(account)) {
            return ValidationResult.error("账号格式不正确");
        }
        
        // 密码验证
        if (TextUtils.isEmpty(password)) {
            return ValidationResult.error("密码不能为空");
        }
        
        if (password.length() < 6) {
            return ValidationResult.error("密码长度至少6个字符");
        }
        
        return ValidationResult.success();
    }
}
```

#### 数据完整性

**数据完整性检查**:
```java
public class DataIntegrityChecker {
    
    /**
     * 检查Provision数据完整性
     */
    public static boolean checkProvisionData(Context context) {
        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);
        
        // 检查必要字段
        boolean hasLanguage = prefs.contains("selected_language");
        boolean hasInputMethod = prefs.contains("selected_input_method");
        boolean hasTermsAccepted = prefs.getBoolean("terms_accepted", false);
        
        return hasLanguage && hasInputMethod && hasTermsAccepted;
    }
    
    /**
     * 检查设置完整性
     */
    public static boolean checkSettingsIntegrity(Context context) {
        ContentResolver resolver = context.getContentResolver();
        
        // 检查系统设置
        int deviceProvisioned = Settings.Global.getInt(resolver, 
            Settings.Global.DEVICE_PROVISIONED, 0);
        int userSetupComplete = Settings.Secure.getInt(resolver,
            Settings.Secure.USER_SETUP_COMPLETE, 0);
        
        return deviceProvisioned == 1 && userSetupComplete == 1;
    }
}
```

#### 错误处理

**验证错误处理**:
```java
public class ValidationErrorHandler {
    
    public static void handleValidationError(Context context, ValidationResult result) {
        if (!result.isValid) {
            // 显示错误提示
            Toast.makeText(context, result.errorMessage, Toast.LENGTH_SHORT).show();
            
            // 记录日志
            Log.w(TAG, "Validation error: " + result.errorMessage);
            
            // 埋点统计
            trackValidationError(result.errorMessage);
        }
    }
    
    private static void trackValidationError(String error) {
        // 使用OneTrack SDK进行埋点
        Map<String, String> params = new HashMap<>();
        params.put("error_type", "validation");
        params.put("error_message", error);
        OneTrackHelper.track("validation_error", params);
    }
}
```

---

### 4.3.3 流程控制

#### 流程定义

**引导流程控制器**:
```java
public class ProvisionFlowController {
    private StateMachine mStateMachine;
    private Context mContext;
    
    public ProvisionFlowController(Context context) {
        mContext = context;
        mStateMachine = new StateMachine(context);
    }
    
    /**
     * 启动引导流程
     */
    public void startFlow() {
        mStateMachine.start(true);
    }
    
    /**
     * 下一步
     */
    public void next() {
        mStateMachine.transitToNext();
    }
    
    /**
     * 上一步
     */
    public void previous() {
        if (canGoBack()) {
            mStateMachine.transitToPrevious();
        }
    }
    
    /**
     * 跳过当前步骤
     */
    public void skip() {
        mStateMachine.transitToNext();
    }
    
    /**
     * 跳转到指定状态
     */
    public void jumpTo(Class<? extends State> stateClass) {
        mStateMachine.jumpToState(stateClass);
    }
    
    /**
     * 是否可以返回
     */
    public boolean canGoBack() {
        return !mStateMachine.isStackEmpty();
    }
    
    /**
     * 完成引导
     */
    public void finish() {
        finishSetup(true);
    }
}
```

#### 流程执行

**流程执行器**:
```java
public class FlowExecutor {
    
    /**
     * 执行异步流程
     */
    public static void executeAsync(Runnable task) {
        new Thread(task).start();
    }
    
    /**
     * 在主线程执行
     */
    public static void executeOnMainThread(Runnable task) {
        Handler mainHandler = new Handler(Looper.getMainLooper());
        mainHandler.post(task);
    }
    
    /**
     * 延迟执行
     */
    public static void executeDelayed(Runnable task, long delayMillis) {
        Handler handler = new Handler(Looper.getMainLooper());
        handler.postDelayed(task, delayMillis);
    }
    
    /**
     * 执行带进度的流程
     */
    public static void executeWithProgress(Context context, 
                                          ProgressTask task) {
        ProgressDialog dialog = new ProgressDialog(context);
        dialog.setMessage("处理中...");
        dialog.setCancelable(false);
        dialog.show();
        
        new Thread(() -> {
            task.run();
            executeOnMainThread(() -> {
                dialog.dismiss();
                task.onComplete();
            });
        }).start();
    }
    
    public interface ProgressTask {
        void run();
        void onComplete();
    }
}
```

#### 流程监控

**流程监控器**:
```java
public class FlowMonitor {
    private long mStartTime;
    private String mCurrentState;
    private List<String> mStateHistory = new ArrayList<>();
    
    /**
     * 开始监控
     */
    public void start() {
        mStartTime = System.currentTimeMillis();
        mStateHistory.clear();
        Log.i(TAG, "Flow monitoring started");
    }
    
    /**
     * 记录状态变化
     */
    public void recordStateChange(String stateName) {
        mCurrentState = stateName;
        mStateHistory.add(stateName);
        
        long duration = System.currentTimeMillis() - mStartTime;
        Log.i(TAG, "State changed to: " + stateName + ", duration: " + duration + "ms");
        
        // 埋点上报
        trackStateChange(stateName, duration);
    }
    
    /**
     * 结束监控
     */
    public void finish() {
        long totalDuration = System.currentTimeMillis() - mStartTime;
        Log.i(TAG, "Flow completed, total duration: " + totalDuration + "ms");
        Log.i(TAG, "State history: " + mStateHistory);
        
        // 上报完整流程数据
        trackFlowComplete(totalDuration, mStateHistory);
    }
}
```

#### 流程优化

**流程优化策略**:
```java
public class FlowOptimizer {
    
    /**
     * 跳过不必要的步骤
     */
    public static boolean shouldSkipState(State state, Context context) {
        // 已设置过的跳过
        if (state instanceof LanguagePickerState) {
            String currentLanguage = Utils.getCurrentLanguage(context);
            if (!TextUtils.isEmpty(currentLanguage)) {
                return true;  // 已设置语言，跳过
            }
        }
        
        // 不支持的功能跳过
        if (state instanceof FingerprintState) {
            if (!Utils.supportFingerprint(context)) {
                return true;  // 不支持指纹，跳过
            }
        }
        
        return false;
    }
    
    /**
     * 合并相似步骤
     */
    public static void mergeStates(State state1, State state2) {
        // 将两个状态合并为一个
        // 例如：WiFi设置和网络检测合并
    }
}
```

---

## 4.4 数据持久层

### 4.4.1 数据库设计

#### 表结构设计

**ProvisionDBHelper表结构**:
```java
public class ProvisionDBHelper extends SQLiteOpenHelper {
    private static final String DATABASE_NAME = "provision.db";
    private static final int DATABASE_VERSION = 1;
    
    // 表名
    public static final String APPDATA_TABLE_NAME = "appdata";
    public static final String DOTINFO_TABLE_NAME = "dotinfo";
    
    // appdata表字段
    public static final String APP_ID = "app_id";
    public static final String APP_PACKAGE = "package";
    public static final String APP_CLASS_NAME = "className";
    public static final String APP_FOLDER_ID = "folderId";
    public static final String APP_DOT = "dot";
    
    // dotinfo表字段
    public static final String DOTINFO_ID = "dotinfo_id";
    public static final String DOT_COLOR = "color";
    public static final String DOT_CONFIG_ID = "configId";
    public static final String DOT_FOLDER_DOT = "folderDot";
    
    @Override
    public void onCreate(SQLiteDatabase db) {
        // 创建appdata表
        db.execSQL("CREATE TABLE IF NOT EXISTS " + APPDATA_TABLE_NAME + " ("
            + APP_ID + " INTEGER PRIMARY KEY AUTOINCREMENT, "
            + APP_PACKAGE + " VARCHAR, "
            + APP_CLASS_NAME + " VARCHAR, "
            + APP_FOLDER_ID + " VARCHAR, "
            + APP_DOT + " INTEGER"
            + ")");
        
        // 创建dotinfo表
        db.execSQL("CREATE TABLE IF NOT EXISTS " + DOTINFO_TABLE_NAME + " ("
            + DOTINFO_ID + " INTEGER PRIMARY KEY AUTOINCREMENT, "
            + DOT_COLOR + " VARCHAR, "
            + DOT_CONFIG_ID + " VARCHAR, "
            + DOT_FOLDER_DOT + " INTEGER"
            + ")");
    }
    
    @Override
    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
        db.execSQL("DROP TABLE IF EXISTS " + APPDATA_TABLE_NAME);
        db.execSQL("DROP TABLE IF EXISTS " + DOTINFO_TABLE_NAME);
        onCreate(db);
    }
}
```

#### 索引设计

**创建索引优化查询**:
```sql
-- 为package字段创建索引
CREATE INDEX idx_package ON appdata(package);

-- 为folderId创建索引
CREATE INDEX idx_folder_id ON appdata(folderId);

-- 为configId创建索引
CREATE INDEX idx_config_id ON dotinfo(configId);
```

#### 查询优化

**优化查询语句**:
```java
public class ProvisionDAO {
    private ProvisionDBHelper mDBHelper;
    
    /**
     * 查询应用数据（优化版）
     */
    public List<AppData> queryAppData(String packageName) {
        SQLiteDatabase db = mDBHelper.getReadableDatabase();
        
        // 使用参数化查询防止SQL注入
        String selection = "package = ?";
        String[] selectionArgs = {packageName};
        
        // 指定需要的列，避免SELECT *
        String[] columns = {APP_ID, APP_PACKAGE, APP_CLASS_NAME, APP_DOT};
        
        Cursor cursor = db.query(
            APPDATA_TABLE_NAME,  // 表名
            columns,             // 列名
            selection,           // WHERE子句
            selectionArgs,       // WHERE参数
            null,                // GROUP BY
            null,                // HAVING
            null                 // ORDER BY
        );
        
        List<AppData> result = new ArrayList<>();
        if (cursor != null) {
            while (cursor.moveToNext()) {
                AppData data = new AppData();
                data.id = cursor.getInt(0);
                data.packageName = cursor.getString(1);
                data.className = cursor.getString(2);
                data.dot = cursor.getInt(3);
                result.add(data);
            }
            cursor.close();
        }
        
        return result;
    }
}
```

#### 数据迁移

**数据库版本升级**:
```java
@Override
public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
    if (oldVersion < 2) {
        // 版本1到版本2的升级
        db.execSQL("ALTER TABLE appdata ADD COLUMN icon_path VARCHAR");
    }
    
    if (oldVersion < 3) {
        // 版本2到版本3的升级
        db.execSQL("CREATE INDEX idx_class_name ON appdata(className)");
    }
}
```

---

### 4.4.2 SharedPreferences

#### 配置管理

**DefaultPreferenceHelper**:
```java
public class DefaultPreferenceHelper {
    private static final String PREF_NAME = "provision_prefs";
    private static final String KEY_SETUP_COMPLETE = "setup_complete";
    private static final String KEY_SELECTED_LANGUAGE = "selected_language";
    private static final String KEY_SELECTED_INPUT_METHOD = "selected_input_method";
    private static final String KEY_TERMS_ACCEPTED = "terms_accepted";
    
    /**
     * 保存设置完成状态
     */
    public static void setSetupComplete(Context context, boolean complete) {
        SharedPreferences prefs = context.getSharedPreferences(
            PREF_NAME, Context.MODE_PRIVATE);
        prefs.edit().putBoolean(KEY_SETUP_COMPLETE, complete).apply();
    }
    
    /**
     * 获取设置完成状态
     */
    public static boolean isSetupComplete(Context context) {
        SharedPreferences prefs = context.getSharedPreferences(
            PREF_NAME, Context.MODE_PRIVATE);
        return prefs.getBoolean(KEY_SETUP_COMPLETE, false);
    }
    
    /**
     * 保存语言选择
     */
    public static void setSelectedLanguage(Context context, String languageCode) {
        SharedPreferences prefs = context.getSharedPreferences(
            PREF_NAME, Context.MODE_PRIVATE);
        prefs.edit().putString(KEY_SELECTED_LANGUAGE, languageCode).apply();
    }
    
    /**
     * 获取语言选择
     */
    public static String getSelectedLanguage(Context context) {
        SharedPreferences prefs = context.getSharedPreferences(
            PREF_NAME, Context.MODE_PRIVATE);
        return prefs.getString(KEY_SELECTED_LANGUAGE, null);
    }
}
```

#### 数据存储

**数据持久化示例**:
```java
// 保存用户配置
SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);
SharedPreferences.Editor editor = prefs.edit();

editor.putString("language", "zh_CN");
editor.putString("input_method", "com.google.android.inputmethod.pinyin");
editor.putBoolean("terms_accepted", true);
editor.putInt("font_size", 14);
editor.putLong("setup_time", System.currentTimeMillis());

// 异步提交
editor.apply();

// 或同步提交
boolean success = editor.commit();
```

#### 加密存储

**EncryptedSharedPreferences**:
```java
public class SecurePreferences {
    
    /**
     * 获取加密的SharedPreferences
     */
    public static SharedPreferences getEncryptedPreferences(Context context) {
        try {
            MasterKey masterKey = new MasterKey.Builder(context)
                .setKeyScheme(MasterKey.KeyScheme.AES256_GCM)
                .build();
            
            return EncryptedSharedPreferences.create(
                context,
                "secure_prefs",
                masterKey,
                EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
                EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
            );
        } catch (Exception e) {
            Log.e(TAG, "Failed to create encrypted preferences", e);
            return null;
        }
    }
    
    /**
     * 保存敏感数据
     */
    public static void saveSensitiveData(Context context, String key, String value) {
        SharedPreferences prefs = getEncryptedPreferences(context);
        if (prefs != null) {
            prefs.edit().putString(key, value).apply();
        }
    }
}
```

#### 多进程支持

**多进程SharedPreferences**:
```java
// 使用MODE_MULTI_PROCESS支持多进程访问（已废弃）
SharedPreferences prefs = context.getSharedPreferences(
    "provision_prefs", Context.MODE_MULTI_PROCESS);

// 推荐使用ContentProvider实现多进程数据共享
public class PreferenceProvider extends ContentProvider {
    // 实现CRUD方法
}
```

---

### 4.4.3 文件存储

#### 文件管理

**文件存储工具类**:
```java
public class FileStorageHelper {
    
    /**
     * 保存文本文件
     */
    public static boolean saveTextFile(Context context, String filename, String content) {
        try {
            FileOutputStream fos = context.openFileOutput(filename, Context.MODE_PRIVATE);
            fos.write(content.getBytes());
            fos.close();
            return true;
        } catch (IOException e) {
            Log.e(TAG, "Failed to save file: " + filename, e);
            return false;
        }
    }
    
    /**
     * 读取文本文件
     */
    public static String readTextFile(Context context, String filename) {
        try {
            FileInputStream fis = context.openFileInput(filename);
            BufferedReader reader = new BufferedReader(new InputStreamReader(fis));
            StringBuilder sb = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                sb.append(line).append("\n");
            }
            fis.close();
            return sb.toString();
        } catch (IOException e) {
            Log.e(TAG, "Failed to read file: " + filename, e);
            return null;
        }
    }
    
    /**
     * 删除文件
     */
    public static boolean deleteFile(Context context, String filename) {
        File file = new File(context.getFilesDir(), filename);
        return file.delete();
    }
}
```

#### 缓存策略

**图片缓存**:
```java
public class ImageCacheManager {
    private LruCache<Integer, Drawable> mMemoryCache;
    private DiskLruCache mDiskCache;
    
    /**
     * 初始化缓存
     */
    public void init(Context context) {
        // 内存缓存：最大1/8的可用内存
        int maxMemory = (int) (Runtime.getRuntime().maxMemory() / 1024);
        int cacheSize = maxMemory / 8;
        
        mMemoryCache = new LruCache<Integer, Drawable>(cacheSize) {
            @Override
            protected int sizeOf(Integer key, Drawable value) {
                return value.getIntrinsicWidth() * value.getIntrinsicHeight() * 4 / 1024;
            }
        };
        
        // 磁盘缓存
        File cacheDir = context.getCacheDir();
        try {
            mDiskCache = DiskLruCache.open(cacheDir, 1, 1, 10 * 1024 * 1024);  // 10MB
        } catch (IOException e) {
            Log.e(TAG, "Failed to open disk cache", e);
        }
    }
    
    /**
     * 添加到缓存
     */
    public void put(int resId, Drawable drawable) {
        mMemoryCache.put(resId, drawable);
    }
    
    /**
     * 从缓存获取
     */
    public Drawable get(int resId) {
        return mMemoryCache.get(resId);
    }
    
    /**
     * 清空缓存
     */
    public void clear() {
        mMemoryCache.evictAll();
        if (mDiskCache != null) {
            try {
                mDiskCache.delete();
            } catch (IOException e) {
                Log.e(TAG, "Failed to clear disk cache", e);
            }
        }
    }
}
```

#### 存储优化

**存储空间管理**:
```java
public class StorageOptimizer {
    
    /**
     * 检查存储空间
     */
    public static boolean hasEnoughStorage(Context context, long requiredBytes) {
        File dataDir = context.getFilesDir();
        long availableBytes = dataDir.getUsableSpace();
        return availableBytes >= requiredBytes;
    }
    
    /**
     * 清理缓存
     */
    public static void clearCache(Context context) {
        deleteDir(context.getCacheDir());
    }
    
    /**
     * 递归删除目录
     */
    private static void deleteDir(File dir) {
        if (dir != null && dir.isDirectory()) {
            File[] children = dir.listFiles();
            if (children != null) {
                for (File child : children) {
                    deleteDir(child);
                }
            }
            dir.delete();
        } else if (dir != null && dir.isFile()) {
            dir.delete();
        }
    }
}
```

#### 安全存储

**加密文件存储**:
```java
public class SecureFileStorage {
    
    /**
     * 加密并保存文件
     */
    public static boolean saveEncryptedFile(Context context, String filename, byte[] data) {
        try {
            // 生成密钥
            SecretKey secretKey = generateKey();
            
            // 加密数据
            Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
            cipher.init(Cipher.ENCRYPT_MODE, secretKey);
            byte[] encryptedData = cipher.doFinal(data);
            
            // 保存到文件
            FileOutputStream fos = context.openFileOutput(filename, Context.MODE_PRIVATE);
            fos.write(encryptedData);
            fos.close();
            
            return true;
        } catch (Exception e) {
            Log.e(TAG, "Failed to save encrypted file", e);
            return false;
        }
    }
    
    /**
     * 读取并解密文件
     */
    public static byte[] readEncryptedFile(Context context, String filename) {
        try {
            // 读取文件
            FileInputStream fis = context.openFileInput(filename);
            byte[] encryptedData = new byte[fis.available()];
            fis.read(encryptedData);
            fis.close();
            
            // 解密数据
            SecretKey secretKey = retrieveKey();
            Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
            cipher.init(Cipher.DECRYPT_MODE, secretKey);
            return cipher.doFinal(encryptedData);
        } catch (Exception e) {
            Log.e(TAG, "Failed to read encrypted file", e);
            return null;
        }
    }
    
    private static SecretKey generateKey() throws Exception {
        KeyGenerator keyGen = KeyGenerator.getInstance("AES");
        keyGen.init(256);
        return keyGen.generateKey();
    }
    
    private static SecretKey retrieveKey() {
        // 从Android Keystore获取密钥
        return null;
    }
}
```

---

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2025-10-17
- **最后更新**: 2025-10-17
- **文档状态**: 正式版
- **维护者**: MIUI开发团队
- **相关文档**:
  - [00-模块解析大纲.md](./00-模块解析大纲.md)
  - [01-项目概览.md](./01-项目概览.md)
  - [02-架构设计.md](./02-架构设计.md)
  - [03-代码结构.md](./03-代码结构.md)
  - [05-性能优化.md](./05-性能优化.md)

