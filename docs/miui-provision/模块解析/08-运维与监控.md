---
layout: default
title: 8. 运维与监控 (Operations & Monitoring)
parent: MiuiProvision项目文档
---

# 8. 运维与监控 (Operations & Monitoring)

## 8.1 日志系统

### 8.1.1 日志分级

**Android日志级别**:
```java
public class Logger {
    private static final String TAG = "Provision";
    
    /**
     * VERBOSE：详细信息，开发调试用
     */
    public static void v(String tag, String msg) {
        if (BuildConfig.DEBUG) {
            Log.v(TAG + "_" + tag, msg);
        }
    }
    
    /**
     * DEBUG：调试信息
     */
    public static void d(String tag, String msg) {
        if (BuildConfig.DEBUG) {
            Log.d(TAG + "_" + tag, msg);
        }
    }
    
    /**
     * INFO：一般信息
     */
    public static void i(String tag, String msg) {
        Log.i(TAG + "_" + tag, msg);
    }
    
    /**
     * WARNING：警告信息
     */
    public static void w(String tag, String msg) {
        Log.w(TAG + "_" + tag, msg);
    }
    
    /**
     * WARNING：警告+异常
     */
    public static void w(String tag, String msg, Throwable tr) {
        Log.w(TAG + "_" + tag, msg, tr);
    }
    
    /**
     * ERROR：错误信息
     */
    public static void e(String tag, String msg) {
        Log.e(TAG + "_" + tag, msg);
    }
    
    /**
     * ERROR：错误+异常
     */
    public static void e(String tag, String msg, Throwable tr) {
        Log.e(TAG + "_" + tag, msg, tr);
    }
}
```

### 8.1.2 日志收集

**本地日志收集**:
```java
public class LogCollector {
    
    /**
     * 收集应用日志
     */
    public static File collectLogs(Context context) {
        File logFile = new File(context.getExternalFilesDir(null), "provision_log.txt");
        
        try {
            Process process = Runtime.getRuntime().exec(
                "logcat -d -v time *:V");
            BufferedReader reader = new BufferedReader(
                new InputStreamReader(process.getInputStream()));
            
            BufferedWriter writer = new BufferedWriter(new FileWriter(logFile));
            
            String line;
            while ((line = reader.readLine()) != null) {
                if (line.contains("Provision")) {
                    writer.write(line);
                    writer.newLine();
                }
            }
            
            writer.close();
            reader.close();
            
        } catch (IOException e) {
            Log.e(TAG, "Failed to collect logs", e);
        }
        
        return logFile;
    }
}
```

### 8.1.3 日志分析

**日志分析工具**:
```bash
# 过滤Provision日志
adb logcat | grep "Provision"

# 查看特定标签
adb logcat -s Provision_StateMachine

# 保存日志到文件
adb logcat -d > provision.log

# 清除日志
adb logcat -c
```

---

## 8.2 性能监控

### 8.2.1 APM集成

**OneTrack SDK集成**:
```java
public class PerformanceMonitor {
    
    /**
     * 初始化OneTrack
     */
    public static void init(Context context) {
        OneTrack.Config config = OneTrack.Config.newBuilder()
            .setAppId("provision_app")
            .setChannel(BuildConfig.FLAVOR)
            .build();
        
        OneTrack.init(context, config);
    }
    
    /**
     * 记录页面浏览
     */
    public static void trackPageView(String pageName) {
        Map<String, Object> properties = new HashMap<>();
        properties.put("page_name", pageName);
        properties.put("timestamp", System.currentTimeMillis());
        OneTrack.track("page_view", properties);
    }
    
    /**
     * 记录事件
     */
    public static void trackEvent(String eventName, Map<String, Object> properties) {
        OneTrack.track(eventName, properties);
    }
}
```

### 8.2.2 性能指标

**关键性能指标**:
```java
public class PerformanceMetrics {
    
    /**
     * 启动时间
     */
    public static void recordStartupTime() {
        long startupTime = System.currentTimeMillis() - DefaultActivity.START_TIME;
        
        Map<String, Object> metrics = new HashMap<>();
        metrics.put("startup_time", startupTime);
        metrics.put("cold_start", true);
        
        PerformanceMonitor.trackEvent("app_startup", metrics);
    }
    
    /**
     * 页面加载时间
     */
    public static void recordPageLoadTime(String pageName, long duration) {
        Map<String, Object> metrics = new HashMap<>();
        metrics.put("page_name", pageName);
        metrics.put("load_time", duration);
        
        PerformanceMonitor.trackEvent("page_load", metrics);
    }
    
    /**
     * 内存使用
     */
    public static void recordMemoryUsage() {
        Runtime runtime = Runtime.getRuntime();
        long usedMemory = runtime.totalMemory() - runtime.freeMemory();
        long maxMemory = runtime.maxMemory();
        
        Map<String, Object> metrics = new HashMap<>();
        metrics.put("used_memory_mb", usedMemory / 1024 / 1024);
        metrics.put("max_memory_mb", maxMemory / 1024 / 1024);
        metrics.put("memory_usage_percent", (usedMemory * 100) / maxMemory);
        
        PerformanceMonitor.trackEvent("memory_usage", metrics);
    }
}
```

### 8.2.3 异常追踪

**崩溃收集**:
```java
public class CrashHandler implements Thread.UncaughtExceptionHandler {
    
    private Thread.UncaughtExceptionHandler mDefaultHandler;
    
    public void init(Context context) {
        mDefaultHandler = Thread.getDefaultUncaughtExceptionHandler();
        Thread.setDefaultUncaughtExceptionHandler(this);
    }
    
    @Override
    public void uncaughtException(Thread thread, Throwable ex) {
        // 收集崩溃信息
        String crashInfo = collectCrashInfo(ex);
        
        // 保存到本地
        saveCrashToFile(crashInfo);
        
        // 上报到服务器
        uploadCrash(crashInfo);
        
        // 调用默认处理器
        if (mDefaultHandler != null) {
            mDefaultHandler.uncaughtException(thread, ex);
        }
    }
    
    private String collectCrashInfo(Throwable ex) {
        StringBuilder sb = new StringBuilder();
        sb.append("Time: ").append(new Date()).append("\n");
        sb.append("Thread: ").append(Thread.currentThread().getName()).append("\n");
        sb.append("Exception: ").append(ex.getClass().getName()).append("\n");
        sb.append("Message: ").append(ex.getMessage()).append("\n\n");
        
        // 堆栈信息
        StringWriter sw = new StringWriter();
        PrintWriter pw = new PrintWriter(sw);
        ex.printStackTrace(pw);
        sb.append(sw.toString());
        
        return sb.toString();
    }
}
```

---

## 8.3 用户行为分析

### 8.3.1 埋点设计

**埋点规范**:
```java
public class Analytics {
    
    /**
     * 页面埋点
     */
    public static void trackPage(String pageName) {
        Map<String, Object> params = new HashMap<>();
        params.put("page", pageName);
        params.put("timestamp", System.currentTimeMillis());
        OneTrack.track("page_view", params);
    }
    
    /**
     * 按钮点击埋点
     */
    public static void trackClick(String buttonName) {
        Map<String, Object> params = new HashMap<>();
        params.put("button", buttonName);
        OneTrack.track("button_click", params);
    }
    
    /**
     * 流程完成埋点
     */
    public static void trackFlowComplete(String flowName, long duration) {
        Map<String, Object> params = new HashMap<>();
        params.put("flow", flowName);
        params.put("duration_ms", duration);
        OneTrack.track("flow_complete", params);
    }
}
```

### 8.3.2 数据统计

**统计指标**:
- 日活用户（DAU）
- 月活用户（MAU）
- 留存率
- 转化率
- 平均使用时长
- 页面访问量（PV）
- 独立访客（UV）

### 8.3.3 漏斗分析

**引导流程漏斗**:
```java
public class FunnelAnalytics {
    
    public static void trackFunnelStep(String stepName) {
        Map<String, Object> params = new HashMap<>();
        params.put("step", stepName);
        params.put("timestamp", System.currentTimeMillis());
        OneTrack.track("funnel_step", params);
    }
}

// 使用示例
FunnelAnalytics.trackFunnelStep("startup");          // 启动页
FunnelAnalytics.trackFunnelStep("language");         // 语言选择
FunnelAnalytics.trackFunnelStep("input_method");     // 输入法选择
FunnelAnalytics.trackFunnelStep("terms");            // 条款同意
FunnelAnalytics.trackFunnelStep("complete");         // 完成
```

---

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2025-10-17
- **最后更新**: 2025-10-17
- **文档状态**: 正式版
- **维护者**: MIUI开发团队

