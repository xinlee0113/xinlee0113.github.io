<!-- PlantUML在线渲染辅助工具 - 使用Kroki服务 -->
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script>
  // 使用Kroki.io服务（更可靠，支持多种图表）
  const KROKI_SERVER = 'https://kroki.io/plantuml/svg/';
  
  // 自动渲染页面中的PlantUML代码块
  document.addEventListener('DOMContentLoaded', function() {
    // 查找所有标记为plantuml的代码块
    const plantumlBlocks = document.querySelectorAll('code.language-plantuml');
    
    plantumlBlocks.forEach(function(codeBlock) {
      const code = codeBlock.textContent.trim();
      
      // 编码PlantUML代码
      const encoded = encodePlantUML(code);
      
      // 创建图片元素
      const img = document.createElement('img');
      img.src = KROKI_SERVER + encoded;
      img.alt = 'PlantUML Diagram';
      img.className = 'plantuml-diagram';
      img.onerror = function() {
        // 如果加载失败，显示错误信息
        const error = document.createElement('div');
        error.className = 'plantuml-error';
        error.innerHTML = `
          <p><strong>⚠️ PlantUML图表渲染失败</strong></p>
          <details>
            <summary>查看源代码</summary>
            <pre><code>${code}</code></pre>
          </details>
          <p><small>提示：检查PlantUML语法或网络连接</small></p>
        `;
        this.parentNode.replaceChild(error, this);
      };
      
      // 替换代码块为图片
      const pre = codeBlock.parentNode;
      if (pre && pre.tagName === 'PRE') {
        pre.parentNode.replaceChild(img, pre);
      }
    });
  });
  
  // PlantUML编码函数 - 使用Deflate + URL-safe Base64
  function encodePlantUML(plantumlCode) {
    // 1. 将字符串转为UTF-8字节
    const utf8Bytes = new TextEncoder().encode(plantumlCode);
    
    // 2. 使用Deflate压缩
    const compressed = pako.deflate(utf8Bytes, { level: 9 });
    
    // 3. 转换为PlantUML专用Base64
    return encode64(compressed);
  }
  
  // PlantUML专用Base64编码（使用特殊字符集）
  function encode64(data) {
    let r = '';
    const alphabet = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_';
    
    for (let i = 0; i < data.length; i += 3) {
      if (i + 2 === data.length) {
        r += append3bytes(data[i], data[i + 1], 0);
      } else if (i + 1 === data.length) {
        r += append3bytes(data[i], 0, 0);
      } else {
        r += append3bytes(data[i], data[i + 1], data[i + 2]);
      }
    }
    return r;
    
    function append3bytes(b1, b2, b3) {
      const c1 = b1 >> 2;
      const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
      const c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
      const c4 = b3 & 0x3F;
      let r = '';
      r += alphabet.charAt(c1 & 0x3F);
      r += alphabet.charAt(c2 & 0x3F);
      r += alphabet.charAt(c3 & 0x3F);
      r += alphabet.charAt(c4 & 0x3F);
      return r;
    }
  }
</script>

<style>
  /* PlantUML图表样式 */
  .plantuml-diagram {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 20px auto;
    border: 1px solid #e1e4e8;
    border-radius: 6px;
    padding: 10px;
    background-color: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
  }
  
  .plantuml-diagram:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  /* PlantUML错误提示样式 */
  .plantuml-error {
    margin: 20px auto;
    padding: 15px;
    border: 2px solid #ff6b6b;
    border-radius: 6px;
    background-color: #fff5f5;
    color: #c92a2a;
  }
  
  .plantuml-error details {
    margin-top: 10px;
    padding: 10px;
    background-color: #fff;
    border: 1px solid #ffe0e0;
    border-radius: 4px;
  }
  
  .plantuml-error summary {
    cursor: pointer;
    color: #c92a2a;
    font-weight: bold;
  }
  
  .plantuml-error pre {
    margin: 10px 0 0 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
    overflow-x: auto;
  }
  
  .plantuml-error code {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
  }
</style>


