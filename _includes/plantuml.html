<!-- PlantUML在线渲染辅助工具 - 使用Kroki.io服务（支持CORS） -->
<script>
  // 使用Kroki.io服务（支持CORS，开源免费）
  const KROKI_SERVER = 'https://kroki.io';
  
  // 自动渲染页面中的PlantUML代码块
  document.addEventListener('DOMContentLoaded', function() {
    // 查找所有标记为plantuml的代码块（支持多种选择器）
    // 1. 查找 code.language-plantuml
    // 2. 查找包含 @startuml 的代码块
    // 3. 查找 pre > code 中包含 @startuml 的
    let plantumlBlocks = document.querySelectorAll('code.language-plantuml');
    
    // 如果没找到，尝试查找包含 @startuml 的代码块
    if (plantumlBlocks.length === 0) {
      const allCodeBlocks = document.querySelectorAll('pre > code, code');
      plantumlBlocks = Array.from(allCodeBlocks).filter(codeBlock => {
        const text = codeBlock.textContent || '';
        return text.includes('@startuml') || text.includes('@startmindmap') || text.includes('@startwbs');
      });
    }
    
    console.log(`找到 ${plantumlBlocks.length} 个PlantUML代码块`);
    
    plantumlBlocks.forEach(async function(codeBlock) {
      const code = codeBlock.textContent.trim();
      
      // 跳过空代码块
      if (!code || code.length === 0) {
        return;
      }
      
      // 检查是否包含PlantUML标记
      if (!code.includes('@startuml') && !code.includes('@startmindmap') && !code.includes('@startwbs')) {
        return;
      }
      
      try {
        // 使用Kroki的POST API（支持CORS）
        const response = await fetch(`${KROKI_SERVER}/plantuml/svg`, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: code
        });
        
        if (response.ok) {
          let svgText = await response.text();
          
          // 清理SVG中的错误信息和调试信息
          // 移除PlantUML版本信息和错误提示框
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = svgText;
          
          // 查找SVG元素
          const svg = tempDiv.querySelector('svg');
          if (svg) {
            // 移除包含错误信息的text元素（通常是黑色背景的错误框）
            const textElements = svg.querySelectorAll('text');
            textElements.forEach(text => {
              const content = text.textContent;
              // 移除版本信息、错误提示等
              if (content && (
                content.includes('PlantUML') || 
                content.includes('[From string') ||
                content.includes('Syntax Error') ||
                content.includes('line')
              )) {
                // 找到包含这个text的最近的g元素并移除
                let parent = text.parentElement;
                while (parent && parent.tagName !== 'g' && parent !== svg) {
                  parent = parent.parentElement;
                }
                if (parent && parent !== svg) {
                  parent.remove();
                }
              }
            });
            
            // 移除包含错误信息的rect元素（黑色背景框）
            const rects = svg.querySelectorAll('rect');
            rects.forEach(rect => {
              const fill = rect.getAttribute('fill');
              // 移除黑色或深色背景的矩形（通常是错误框）
              if (fill && (fill.includes('#000') || fill.includes('black') || fill === '#000000')) {
                const siblings = rect.parentElement?.children;
                if (siblings) {
                  // 检查是否有相关的text元素
                  Array.from(siblings).forEach(sibling => {
                    if (sibling.tagName === 'text') {
                      const content = sibling.textContent;
                      if (content && (content.includes('PlantUML') || content.includes('Error'))) {
                        rect.remove();
                      }
                    }
                  });
                }
              }
            });
            
            svgText = svg.outerHTML;
          }
          
          // 创建div容器
          const container = document.createElement('div');
          container.className = 'plantuml-diagram';
          container.innerHTML = svgText;
          
          // 替换代码块为图表
          // 查找包含代码块的pre元素
          let pre = codeBlock.parentNode;
          while (pre && pre.tagName !== 'PRE' && pre !== document.body) {
            pre = pre.parentNode;
          }
          
          if (pre && pre.tagName === 'PRE') {
            pre.parentNode.replaceChild(container, pre);
          } else {
            // 如果找不到pre，直接替换code元素
            codeBlock.parentNode.replaceChild(container, codeBlock);
          }
        } else {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
        }
      } catch (error) {
        // 如果失败，显示错误信息
        const errorDiv = document.createElement('div');
        errorDiv.className = 'plantuml-error';
        errorDiv.innerHTML = `
          <p><strong>⚠️ PlantUML图表渲染失败</strong></p>
          <details open>
            <summary>查看源代码</summary>
            <pre><code>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>
          </details>
          <p><small>错误：${error.message}</small></p>
          <p><small>提示：检查PlantUML语法是否正确，或尝试刷新页面</small></p>
          <p><small>服务器：<a href="https://kroki.io" target="_blank">Kroki.io</a></small></p>
        `;
        
        // 查找包含代码块的pre元素
        let pre = codeBlock.parentNode;
        while (pre && pre.tagName !== 'PRE' && pre !== document.body) {
          pre = pre.parentNode;
        }
        
        if (pre && pre.tagName === 'PRE') {
          pre.parentNode.replaceChild(errorDiv, pre);
        } else {
          // 如果找不到pre，直接替换code元素
          codeBlock.parentNode.replaceChild(errorDiv, codeBlock);
        }
        
        console.error('PlantUML渲染失败:', error);
      }
    });
  });
</script>

<style>
  /* PlantUML图表样式 */
  .plantuml-diagram {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 20px auto;
    border: 1px solid #e1e4e8;
    border-radius: 6px;
    padding: 10px;
    background-color: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
  }
  
  .plantuml-diagram:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  /* PlantUML错误提示样式 */
  .plantuml-error {
    margin: 20px auto;
    padding: 15px;
    border: 2px solid #ff6b6b;
    border-radius: 6px;
    background-color: #fff5f5;
    color: #c92a2a;
  }
  
  .plantuml-error details {
    margin-top: 10px;
    padding: 10px;
    background-color: #fff;
    border: 1px solid #ffe0e0;
    border-radius: 4px;
  }
  
  .plantuml-error summary {
    cursor: pointer;
    color: #c92a2a;
    font-weight: bold;
  }
  
  .plantuml-error pre {
    margin: 10px 0 0 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
    overflow-x: auto;
  }
  
  .plantuml-error code {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
  }
</style>


