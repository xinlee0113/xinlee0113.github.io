<!-- PlantUML客户端渲染工具 - 使用PlantUML官方服务器（完全离线编码） -->
<!-- 引入pako库用于数据压缩 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js"></script>

<script>
  // PlantUML官方服务器（支持GET请求，无需CORS）
  const PLANTUML_SERVER = 'https://www.plantuml.com/plantuml';
  
  // PlantUML编码函数（使用PlantUML官方编码算法）
  function encodePlantUML(text) {
    // 使用pako进行deflate压缩
    const compressed = pako.deflate(text, { level: 9, to: 'string' });
    
    // 转换为Uint8Array
    const bytes = new Uint8Array(compressed.length);
    for (let i = 0; i < compressed.length; i++) {
      bytes[i] = compressed.charCodeAt(i);
    }
    
    // Base64编码（使用PlantUML的特殊编码表）
    return encode64(bytes);
  }
  
  // PlantUML Base64编码（使用特殊字符集）
  function encode64(data) {
    let r = "";
    for (let i = 0; i < data.length; i += 3) {
      if (i + 2 === data.length) {
        r += append3bytes(data[i], data[i + 1], 0);
      } else if (i + 1 === data.length) {
        r += append3bytes(data[i], 0, 0);
      } else {
        r += append3bytes(data[i], data[i + 1], data[i + 2]);
      }
    }
    return r;
  }
  
  function append3bytes(b1, b2, b3) {
    const c1 = b1 >> 2;
    const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
    const c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
    const c4 = b3 & 0x3F;
    let r = "";
    r += encode6bit(c1 & 0x3F);
    r += encode6bit(c2 & 0x3F);
    r += encode6bit(c3 & 0x3F);
    r += encode6bit(c4 & 0x3F);
    return r;
  }
  
  function encode6bit(b) {
    if (b < 10) {
      return String.fromCharCode(48 + b);
    }
    b -= 10;
    if (b < 26) {
      return String.fromCharCode(65 + b);
    }
    b -= 26;
    if (b < 26) {
      return String.fromCharCode(97 + b);
    }
    b -= 26;
    if (b === 0) {
      return '-';
    }
    if (b === 1) {
      return '_';
    }
    return '?';
  }

  // 自动渲染页面中的PlantUML代码块
  document.addEventListener('DOMContentLoaded', function() {
    console.log('[PlantUML] 开始初始化（客户端渲染模式）...');
    console.log('[PlantUML] 服务器地址:', PLANTUML_SERVER);
    
    // 检查pako库是否加载
    if (typeof pako === 'undefined') {
      console.error('[PlantUML] pako库未加载，请检查CDN连接');
      return;
    }
    console.log('[PlantUML] pako库已加载');
    
    // 查找所有标记为plantuml的代码块（支持多种选择器）
    // 1. 查找 code.language-plantuml
    // 2. 查找包含 @startuml 的代码块
    // 3. 查找 pre > code 中包含 @startuml 的
    let plantumlBlocks = document.querySelectorAll('code.language-plantuml');
    console.log('[PlantUML] 通过 .language-plantuml 找到', plantumlBlocks.length, '个代码块');

    // 如果没找到，尝试查找包含 @startuml 的代码块
    if (plantumlBlocks.length === 0) {
      console.log('[PlantUML] 尝试查找包含 @startuml 的代码块...');
      const allCodeBlocks = document.querySelectorAll('pre > code, code');
      console.log('[PlantUML] 总共找到', allCodeBlocks.length, '个代码块');
      plantumlBlocks = Array.from(allCodeBlocks).filter(codeBlock => {
        const text = codeBlock.textContent || '';
        const isPlantUML = text.includes('@startuml') || text.includes('@startmindmap') || text.includes('@startwbs');
        if (isPlantUML) {
          console.log('[PlantUML] 发现PlantUML代码块，前50字符:', text.substring(0, 50));
        }
        return isPlantUML;
      });
    }

    console.log(`[PlantUML] 最终找到 ${plantumlBlocks.length} 个PlantUML代码块`);

    if (plantumlBlocks.length === 0) {
      console.warn('[PlantUML] 未找到任何PlantUML代码块，请检查：');
      console.warn('[PlantUML] 1. 代码块是否使用 ```plantuml 标记');
      console.warn('[PlantUML] 2. 代码块是否包含 @startuml 标记');
      console.warn('[PlantUML] 3. 页面是否已完全加载');
      return;
    }

    let processedCount = 0;
    let successCount = 0;
    let errorCount = 0;
    const totalBlocks = plantumlBlocks.length;

    plantumlBlocks.forEach(function(codeBlock, index) {
      const code = codeBlock.textContent.trim();
      console.log(`[PlantUML] 处理第 ${index + 1}/${plantumlBlocks.length} 个代码块，长度: ${code.length} 字符`);

      // 跳过空代码块
      if (!code || code.length === 0) {
        console.warn(`[PlantUML] 代码块 ${index + 1} 为空，跳过`);
        processedCount++;
        return;
      }

      // 检查是否包含PlantUML标记
      if (!code.includes('@startuml') && !code.includes('@startmindmap') && !code.includes('@startwbs')) {
        console.warn(`[PlantUML] 代码块 ${index + 1} 不包含PlantUML标记，跳过`);
        processedCount++;
        return;
      }

      try {
        console.log(`[PlantUML] 代码块 ${index + 1} 开始编码...`);
        const startTime = Date.now();
        
        // 编码PlantUML代码
        const encoded = encodePlantUML(code);
        const encodeTime = Date.now();
        console.log(`[PlantUML] 代码块 ${index + 1} 编码完成，耗时: ${encodeTime - startTime}ms`);
        console.log(`[PlantUML] 编码后长度: ${encoded.length} 字符`);
        
        // 构建图片URL（使用GET请求，无需CORS）
        const imgUrl = `${PLANTUML_SERVER}/svg/${encoded}`;
        console.log(`[PlantUML] 图片URL: ${imgUrl.substring(0, 100)}...`);
        
        // 创建img元素
        const img = document.createElement('img');
        img.className = 'plantuml-diagram';
        img.src = imgUrl;
        img.alt = 'PlantUML Diagram';
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.display = 'block';
        img.style.margin = '20px auto';
        
        // 图片加载成功
        img.onload = function() {
          const loadTime = Date.now();
          console.log(`[PlantUML] 代码块 ${index + 1} 图片加载成功，总耗时: ${loadTime - startTime}ms`);
          successCount++;
          processedCount++;
          updateStats();
        };
        
        // 图片加载失败
        img.onerror = function(error) {
          console.error(`[PlantUML] 代码块 ${index + 1} 图片加载失败:`, error);
          errorCount++;
          processedCount++;
          
          // 显示错误信息
          const errorDiv = document.createElement('div');
          errorDiv.className = 'plantuml-error';
          errorDiv.innerHTML = `
            <p><strong>⚠️ PlantUML图表渲染失败</strong></p>
            <details open>
              <summary>查看源代码</summary>
              <pre><code>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>
            </details>
            <p><small>错误：图片加载失败</small></p>
            <p><small>提示：检查PlantUML语法是否正确，或尝试刷新页面</small></p>
            <p><small>服务器：<a href="${PLANTUML_SERVER}" target="_blank">PlantUML官方服务器</a></small></p>
          `;
          
          // 替换代码块
          replaceCodeBlock(codeBlock, errorDiv);
          updateStats();
        };
        
        // 替换代码块为图片
        replaceCodeBlock(codeBlock, img);
        
      } catch (error) {
        errorCount++;
        processedCount++;
        console.error(`[PlantUML] 代码块 ${index + 1} 渲染失败:`, error);
        console.error(`[PlantUML] 错误类型:`, error.constructor.name);
        console.error(`[PlantUML] 错误消息:`, error.message);
        console.error(`[PlantUML] 错误堆栈:`, error.stack);
        
        // 显示错误信息
        const errorDiv = document.createElement('div');
        errorDiv.className = 'plantuml-error';
        errorDiv.innerHTML = `
          <p><strong>⚠️ PlantUML图表渲染失败</strong></p>
          <details open>
            <summary>查看源代码</summary>
            <pre><code>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>
          </details>
          <p><small>错误：${error.message}</small></p>
          <p><small>提示：检查PlantUML语法是否正确，或尝试刷新页面</small></p>
          <p><small>服务器：<a href="${PLANTUML_SERVER}" target="_blank">PlantUML官方服务器</a></small></p>
        `;
        
        // 替换代码块
        replaceCodeBlock(codeBlock, errorDiv);
        updateStats();
      }
    });
    
    // 替换代码块的辅助函数
    function replaceCodeBlock(codeBlock, replacement) {
      // 查找包含代码块的pre元素
      let pre = codeBlock.parentNode;
      while (pre && pre.tagName !== 'PRE' && pre !== document.body) {
        pre = pre.parentNode;
      }
      
      if (pre && pre.tagName === 'PRE') {
        pre.parentNode.replaceChild(replacement, pre);
      } else {
        // 如果找不到pre，直接替换code元素
        codeBlock.parentNode.replaceChild(replacement, codeBlock);
      }
    }
    
    // 更新统计信息
    function updateStats() {
      if (processedCount === totalBlocks) {
        console.log(`[PlantUML] ========== 渲染统计 ==========`);
        console.log(`[PlantUML] 总代码块数: ${totalBlocks}`);
        console.log(`[PlantUML] 已处理: ${processedCount}`);
        console.log(`[PlantUML] 成功: ${successCount}`);
        console.log(`[PlantUML] 失败: ${errorCount}`);
        console.log(`[PlantUML] =============================`);
      }
    }
  });
</script>

<style>
  /* PlantUML图表样式 */
  .plantuml-diagram {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 20px auto;
    border: 1px solid #e1e4e8;
    border-radius: 6px;
    padding: 10px;
    background-color: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
  }

  .plantuml-diagram:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  /* PlantUML错误提示样式 */
  .plantuml-error {
    margin: 20px auto;
    padding: 15px;
    border: 2px solid #ff6b6b;
    border-radius: 6px;
    background-color: #fff5f5;
    color: #c92a2a;
  }

  .plantuml-error details {
    margin-top: 10px;
    padding: 10px;
    background-color: #fff;
    border: 1px solid #ffe0e0;
    border-radius: 4px;
  }

  .plantuml-error summary {
    cursor: pointer;
    color: #c92a2a;
    font-weight: bold;
  }

  .plantuml-error pre {
    margin: 10px 0 0 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
    overflow-x: auto;
  }

  .plantuml-error code {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
  }
</style>
