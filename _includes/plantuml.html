<!-- PlantUML渲染工具 - 优先使用预渲染图片，回退到客户端渲染 -->
<!-- 引入plantuml-encoder库用于客户端渲染（备用方案） -->
<!-- 使用多个CDN备用，避免单点故障 -->
<script src="https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js" 
        onerror="this.onerror=null; this.src='https://unpkg.com/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js'"></script>
<script>
  // 如果第一个CDN失败，尝试第二个CDN
  if (typeof plantumlEncoder === 'undefined') {
    var script = document.createElement('script');
    script.src = 'https://unpkg.com/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js';
    script.onerror = function() {
      console.error('[PlantUML] 所有CDN都加载失败，将使用pako库手动编码');
      // 如果所有CDN都失败，加载pako库作为最后备用
      var pakoScript = document.createElement('script');
      pakoScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js';
      document.head.appendChild(pakoScript);
    };
    document.head.appendChild(script);
  }
</script>

<script>
  // 自动渲染页面中的PlantUML代码块
  document.addEventListener('DOMContentLoaded', function() {
    console.log('[PlantUML] 开始初始化...');

    // 查找所有标记为plantuml的代码块（支持多种选择器）
    let plantumlBlocks = document.querySelectorAll('code.language-plantuml');
    console.log('[PlantUML] 通过 .language-plantuml 找到', plantumlBlocks.length, '个代码块');

    // 如果没找到，尝试查找包含 @startuml 的代码块
    if (plantumlBlocks.length === 0) {
      console.log('[PlantUML] 尝试查找包含 @startuml 的代码块...');
      const allCodeBlocks = document.querySelectorAll('pre > code, code');
      console.log('[PlantUML] 总共找到', allCodeBlocks.length, '个代码块');
      plantumlBlocks = Array.from(allCodeBlocks).filter(codeBlock => {
        const text = codeBlock.textContent || '';
        return text.includes('@startuml') || text.includes('@startmindmap') || text.includes('@startwbs');
      });
    }

    console.log(`[PlantUML] 最终找到 ${plantumlBlocks.length} 个PlantUML代码块`);

    if (plantumlBlocks.length === 0) {
      console.warn('[PlantUML] 未找到任何PlantUML代码块');
      return;
    }

    let processedCount = 0;
    let successCount = 0;
    let errorCount = 0;
    const totalBlocks = plantumlBlocks.length;

    plantumlBlocks.forEach(function(codeBlock, index) {
      const code = codeBlock.textContent.trim();

      // 跳过空代码块
      if (!code || code.length === 0) {
        processedCount++;
        return;
      }

      // 检查是否包含PlantUML标记
      if (!code.includes('@startuml') && !code.includes('@startmindmap') && !code.includes('@startwbs')) {
        processedCount++;
        return;
      }

      try {
        console.log(`[PlantUML] 处理第 ${index + 1}/${plantumlBlocks.length} 个代码块`);

        // 方案1：尝试使用预渲染的图片（如果存在）
        // 生成图片路径（基于当前页面路径）
        const currentPath = window.location.pathname;
        // 提取页面路径，例如 /docs/android-source/Android_Binder机制详解.html
        // 转换为 android-source/Android_Binder机制详解
        let pagePath = currentPath.replace(/^\/docs\//, '').replace(/\.html$/, '');
        if (!pagePath) {
          pagePath = 'index';
        }
        
        // 先解码URL编码（%E4%BA%8B -> 事），然后替换特殊字符
        // 这样与预渲染脚本保持一致（预渲染脚本从文件路径提取，文件路径是未编码的）
        try {
          pagePath = decodeURIComponent(pagePath);
        } catch (e) {
          // 如果解码失败，使用原始路径
          console.warn('[PlantUML] URL解码失败，使用原始路径:', e);
        }
        
        // 将路径中的斜杠替换为下划线，用于文件名（与预渲染脚本保持一致）
        const pageName = pagePath.replace(/\//g, '_').replace(/[^a-zA-Z0-9_]/g, '_');
        const imagePath = `/plantuml-images/${pageName}_${index + 1}.svg`;
        
        console.log(`[PlantUML] 尝试加载预渲染图片: ${imagePath}`);
        console.log(`[PlantUML] 页面路径: ${currentPath}`);
        console.log(`[PlantUML] 解码后路径: ${pagePath}`);
        console.log(`[PlantUML] 页面名: ${pageName}`);

        // 先尝试加载预渲染的图片
        const img = document.createElement('img');
        img.className = 'plantuml-diagram';
        img.alt = 'PlantUML Diagram';
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.display = 'block';
        img.style.margin = '20px auto';

        // 尝试加载预渲染图片
        let fallbackAttempted = false;
        img.onerror = function(event) {
          if (!fallbackAttempted) {
            fallbackAttempted = true;
            console.warn(`[PlantUML] 预渲染图片加载失败: ${imagePath}`);
            console.warn(`[PlantUML] 错误事件:`, event);
            console.log(`[PlantUML] 尝试使用客户端渲染作为备用方案...`);

            // 方案2：客户端渲染（备用方案）
            // 等待一下，确保plantumlEncoder已加载（如果CDN加载慢）
            const tryClientRender = () => {
              if (typeof plantumlEncoder !== 'undefined') {
                try {
                  const encoded = plantumlEncoder.encode(code);
                  const imgUrl = `https://www.plantuml.com/plantuml/svg/${encoded}`;
                  console.log(`[PlantUML] 客户端渲染URL: ${imgUrl.substring(0, 100)}...`);
                  img.src = imgUrl;

                // 重置错误处理，避免无限循环
                img.onerror = function() {
                  console.error(`[PlantUML] 客户端渲染失败: ${imgUrl.substring(0, 100)}...`);
                  showError(codeBlock, code, '客户端渲染失败（网络问题或PlantUML语法错误）');
                  errorCount++;
                  processedCount++;
                  updateStats();
                };

                img.onload = function() {
                  console.log(`[PlantUML] 客户端渲染成功`);
                  successCount++;
                  processedCount++;
                  updateStats();
                };
              } catch (e) {
                console.error(`[PlantUML] 编码失败:`, e);
                showError(codeBlock, code, `编码失败: ${e.message}`);
                errorCount++;
                processedCount++;
                updateStats();
              }
              } else {
                // 如果plantumlEncoder还未加载，等待一下再试
                console.log(`[PlantUML] plantumlEncoder未加载，等待500ms后重试...`);
                setTimeout(tryClientRender, 500);
              }
            };
            
            // 立即尝试，如果失败则等待
            tryClientRender();
          } else {
            // 如果回退也失败了，显示错误
            console.error(`[PlantUML] 预渲染和客户端渲染都失败`);
            showError(codeBlock, code, '预渲染和客户端渲染都失败');
            errorCount++;
            processedCount++;
            updateStats();
          }
        };

        img.onload = function() {
          console.log(`[PlantUML] 使用预渲染图片: ${imagePath}`);
          successCount++;
          processedCount++;
          updateStats();
        };

        // 先尝试预渲染图片
        img.src = imagePath;

        // 替换代码块为图片
        replaceCodeBlock(codeBlock, img);

      } catch (error) {
        errorCount++;
        processedCount++;
        console.error(`[PlantUML] 代码块 ${index + 1} 渲染失败:`, error);
        showError(codeBlock, code, error.message);
        updateStats();
      }
    });

    // 替换代码块的辅助函数
    function replaceCodeBlock(codeBlock, replacement) {
      let pre = codeBlock.parentNode;
      while (pre && pre.tagName !== 'PRE' && pre !== document.body) {
        pre = pre.parentNode;
      }

      if (pre && pre.tagName === 'PRE') {
        pre.parentNode.replaceChild(replacement, pre);
      } else {
        codeBlock.parentNode.replaceChild(replacement, codeBlock);
      }
    }

    // 显示错误信息
    function showError(codeBlock, code, errorMsg) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'plantuml-error';
      errorDiv.innerHTML = `
        <p><strong>⚠️ PlantUML图表渲染失败</strong></p>
        <details open>
          <summary>查看源代码</summary>
          <pre><code>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>
        </details>
        <p><small>错误：${errorMsg}</small></p>
        <p><small>提示：检查PlantUML语法是否正确</small></p>
      `;
      replaceCodeBlock(codeBlock, errorDiv);
    }

    // 更新统计信息
    function updateStats() {
      if (processedCount === totalBlocks) {
        console.log(`[PlantUML] ========== 渲染统计 ==========`);
        console.log(`[PlantUML] 总代码块数: ${totalBlocks}`);
        console.log(`[PlantUML] 已处理: ${processedCount}`);
        console.log(`[PlantUML] 成功: ${successCount}`);
        console.log(`[PlantUML] 失败: ${errorCount}`);
        console.log(`[PlantUML] =============================`);
      }
    }
  });
</script>

<style>
  /* PlantUML图表样式 */
  .plantuml-diagram {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 20px auto;
    border: 1px solid #e1e4e8;
    border-radius: 6px;
    padding: 10px;
    background-color: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
  }

  .plantuml-diagram:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  /* PlantUML错误提示样式 */
  .plantuml-error {
    margin: 20px auto;
    padding: 15px;
    border: 2px solid #ff6b6b;
    border-radius: 6px;
    background-color: #fff5f5;
    color: #c92a2a;
  }

  .plantuml-error details {
    margin-top: 10px;
    padding: 10px;
    background-color: #fff;
    border: 1px solid #ffe0e0;
    border-radius: 4px;
  }

  .plantuml-error summary {
    cursor: pointer;
    color: #c92a2a;
    font-weight: bold;
  }

  .plantuml-error pre {
    margin: 10px 0 0 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
    overflow-x: auto;
  }

  .plantuml-error code {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
  }
</style>
